#!/bin/bash
################################################################################
# 综合测试套件
#
# 使用 run_test_with_error_check.sh 执行所有关键测试
################################################################################

set -e

echo "======================================================================"
echo "综合测试套件 - 使用自动错误检查"
echo "======================================================================"
echo ""

# 测试计数器
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# 记录失败的测试
FAILED_TEST_NAMES=()

# 运行单个测试
run_test() {
    local test_name="$1"
    local test_command="$2"

    TOTAL_TESTS=$((TOTAL_TESTS + 1))

    echo ""
    echo "======================================================================"
    echo "测试 $TOTAL_TESTS: $test_name"
    echo "======================================================================"
    echo ""

    if ./run_test_with_error_check.sh "$test_command"; then
        PASSED_TESTS=$((PASSED_TESTS + 1))
        echo "✓ 测试通过: $test_name"
    else
        FAILED_TESTS=$((FAILED_TESTS + 1))
        FAILED_TEST_NAMES+=("$test_name")
        echo "✗ 测试失败: $test_name"
    fi
}

# ============================================================================
# 1. 依赖检查测试
# ============================================================================
echo "【第一部分：依赖检查】"
run_test "依赖检查" "python3 scripts/check_dependencies.py"

# ============================================================================
# 2. 指数成分股功能测试
# ============================================================================
echo ""
echo "【第二部分：指数成分股功能】"
run_test "指数成分股获取" "python3 test_index_constituents.py"

# ============================================================================
# 3. 数据加载测试
# ============================================================================
echo ""
echo "【第三部分：数据加载】"

# 3.1 单股票数据加载（短期）
run_test "单股票数据加载(3个月)" \
    "./run_cli.sh data load --code sh600036 --start 2023-10-01 --end 2023-12-31"

# 3.2 单股票数据加载（长期）
run_test "单股票数据加载(1年)" \
    "./run_cli.sh data load --code sh600036 --start 2023-01-01 --end 2023-12-31"

# ============================================================================
# 4. 模型训练测试
# ============================================================================
echo ""
echo "【第四部分：模型训练】"

# 4.1 短期数据训练（预期失败 - 数据不足）
run_test "模型训练(3个月数据-预期数据不足)" \
    "./run_cli.sh model train --type LGBM --name test_3months \
    --code sh600036 --start 2023-10-01 --end 2023-12-31" || true

# 4.2 完整年度数据训练
run_test "模型训练(1年数据)" \
    "./run_cli.sh model train --type LGBM --name test_1year \
    --code sh600036 --start 2023-01-01 --end 2023-12-31"

# 4.3 不同股票训练
run_test "模型训练(sh600000)" \
    "./run_cli.sh model train --type LGBM --name test_sh600000 \
    --code sh600000 --start 2023-01-01 --end 2023-12-31"

# ============================================================================
# 5. 批量训练测试（小规模）
# ============================================================================
echo ""
echo "【第五部分：批量训练】"

# 5.1 小规模指数训练（5只股票）
run_test "指数批量训练(5只股票)" \
    "./run_cli.sh model train-index --type LGBM --name test_index_5stocks \
    --index 沪深300 --start 2023-01-01 --end 2023-12-31 --max-stocks 5"

# 5.2 中等规模指数训练（20只股票）
run_test "指数批量训练(20只股票)" \
    "./run_cli.sh model train-index --type LGBM --name test_index_20stocks \
    --index 沪深300 --start 2023-01-01 --end 2023-12-31 --max-stocks 20"

# ============================================================================
# 6. 模型查询测试
# ============================================================================
echo ""
echo "【第六部分：模型查询】"

run_test "模型列表查询" \
    "./run_cli.sh model list"

run_test "模型详情查询" \
    "./run_cli.sh model show --name test_1year"

# ============================================================================
# 测试总结
# ============================================================================
echo ""
echo "======================================================================"
echo "测试总结"
echo "======================================================================"
echo ""
echo "总测试数:   $TOTAL_TESTS"
echo "通过:       $PASSED_TESTS"
echo "失败:       $FAILED_TESTS"
echo ""

if [ $FAILED_TESTS -gt 0 ]; then
    echo "失败的测试:"
    for test_name in "${FAILED_TEST_NAMES[@]}"; do
        echo "  ✗ $test_name"
    done
    echo ""
    echo "======================================================================"
    echo "❌ 测试套件失败"
    echo "======================================================================"
    exit 1
else
    echo "======================================================================"
    echo "✅ 所有测试通过！"
    echo "======================================================================"
    exit 0
fi
