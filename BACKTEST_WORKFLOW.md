# Hikyuu 回测完整流程

## 概述

本文档说明如何使用 Hikyuu 对 Qlib 模型预测结果进行回测。

## 完整工作流程

```
训练阶段 (2024数据) → 预测阶段 (2025数据) → 回测阶段 (验证策略)
```

---

## 第一步:训练模型

使用 2024 年沪深300成分股数据训练 LightGBM 模型:

```bash
PYTHONPATH=./src python -m controllers.cli.main model train-index \
  --type LGBM \
  --name hs300_2024_model \
  --index 沪深300 \
  --start 2024-01-01 \
  --end 2024-12-31
```

**输出**:
```
训练完成!
模型ID: c18e2c6f-940a-4390-9099-7e2dbe469f37
状态: TRAINED
指标:
  train_r2: 0.15
  test_r2: 0.12
  train_rmse: 0.0248
  test_rmse: 0.0313
```

**记录模型 ID** 供下一步使用。

---

## 第二步:生成预测

使用训练好的模型对 2025 年数据生成预测:

```bash
PYTHONPATH=./src python -m controllers.cli.main model predict \
  --model-id c18e2c6f-940a-4390-9099-7e2dbe469f37 \
  --index 沪深300 \
  --start 2025-01-01 \
  --end 2025-12-31 \
  --output outputs/predictions/hs300_2025_pred.pkl
```

**输出**:
```
开始为 300 只股票生成预测...
======================================================================
预测生成完成!
  成功: 300/300 只股票
  总预测数: 62687 条

✓ 预测结果已保存: outputs/predictions/hs300_2025_pred.pkl (Qlib格式)
✓ 详细信息已保存: outputs/predictions/hs300_2025_pred_details.pkl
```

**预测文件格式**:
- MultiIndex DataFrame: `['stock_code', 'timestamp']`
- 列: `score` (预测值), `confidence`, `model_id`, `prediction_id`
- 62,687 条预测 (300 只股票 × 约 209 个交易日)

---

## 第三步:运行回测

### 方法1:快速回测(推荐)

最简单的方式,一键运行:

```bash
python examples/quick_backtest.py
```

### 方法2:自定义参数

```bash
python examples/quick_backtest.py \
  --pred-file outputs/predictions/hs300_2025_pred.pkl \
  --start 20250101 \
  --end 20251231 \
  --cash 1000000 \
  --buy-threshold 0.01 \
  --sell-threshold -0.01 \
  --top-k 30 \
  --pool 沪深300
```

### 方法3:高级回测(含可视化)

```bash
python examples/backtest_advanced.py
```

生成图表和详细报告:
- `outputs/backtest/equity_curve.png` - 资金曲线
- `outputs/backtest/drawdown_curve.png` - 回撤曲线
- `outputs/backtest/returns_distribution.png` - 收益分布
- `outputs/backtest/backtest_report_*.txt` - 详细报告

---

## 回测结果示例

```
======================================================================
回测结果
======================================================================

📊 资金情况:
  初始资金: 1,000,000.00
  最终资金: 850,234.56
  总资产: 1,125,678.90
  总收益率: 12.57%

📈 交易统计:
  总交易次数: 856
  持仓股票数: 28

最近10笔交易:
  1. 2025-12-30 买入 sh600036 100股 @45.23 成本:45.68
  2. 2025-12-30 卖出 sh600000 100股 @12.34 成本:0.37
  ...

当前持仓 (Top 10):
  1. sh600036 100股 成本价:45.23 市值:4,568.00
  2. sh600519 50股 成本价:156.78 市值:7,839.00
  ...
```

---

## 核心参数说明

### buy_threshold (买入阈值)

预测收益率超过此值时买入:

```python
buy_threshold = 0.01   # 预测收益 > 1% 时买入
buy_threshold = 0.02   # 预测收益 > 2% 时买入 (更保守)
buy_threshold = 0.005  # 预测收益 > 0.5% 时买入 (更激进)
```

### sell_threshold (卖出阈值)

预测收益率低于此值时卖出:

```python
sell_threshold = -0.01   # 预测收益 < -1% 时卖出
sell_threshold = -0.02   # 预测收益 < -2% 时卖出 (更保守)
sell_threshold = -0.005  # 预测收益 < -0.5% 时卖出 (更激进)
```

### top_k (每日最大交易股票数)

限制每日交易的股票数量,选择预测最好的 K 只:

```python
top_k = 10   # 集中投资最优的 10 只
top_k = 30   # 分散投资 30 只 (默认)
top_k = 50   # 更分散投资
top_k = None # 不限制,所有满足阈值的都交易
```

### init_cash (初始资金)

回测起始资金:

```python
init_cash = 1000000   # 100 万
init_cash = 5000000   # 500 万
```

---

## 策略类型对比

### 保守策略

```python
buy_threshold = 0.02
sell_threshold = -0.02
top_k = 10
```

特点:
- ✅ 更高阈值,交易频率低
- ✅ 只选最优股票,风险低
- ❌ 可能错过机会,收益较低

### 均衡策略(默认)

```python
buy_threshold = 0.01
sell_threshold = -0.01
top_k = 30
```

特点:
- ✅ 平衡风险和收益
- ✅ 适中的交易频率
- ✅ 推荐用于大多数场景

### 激进策略

```python
buy_threshold = 0.005
sell_threshold = -0.005
top_k = 50
```

特点:
- ✅ 更低阈值,交易频率高
- ✅ 把握更多机会,潜在收益高
- ❌ 风险较高,回撤可能大

---

## 性能指标解读

### 总收益率

(最终资产 - 初始资金) / 初始资金

- > 0%: 盈利
- > 10%: 良好
- > 20%: 优秀

### 年化收益率

折算为年化的收益率

- > 5%: 跑赢理财
- > 10%: 跑赢大盘
- > 15%: 优秀表现

### 最大回撤

从资金最高点到最低点的最大跌幅

- < 10%: 风险很低
- 10-20%: 风险适中
- > 30%: 风险较高

### 夏普比率

(年化收益率 - 无风险利率) / 年化波动率

- > 1: 风险调整后收益良好
- > 2: 优秀
- > 3: 卓越

### 胜率

盈利交易次数 / 总交易次数

- > 50%: 合格
- > 60%: 良好
- > 70%: 优秀

### 盈亏比

平均盈利 / 平均亏损

- > 1: 盈利交易平均大于亏损
- > 1.5: 良好
- > 2: 优秀

---

## 优化策略

### 如果收益率不理想

1. **检查模型质量**: R² 分数是否 > 0.1
2. **降低买入阈值**: 增加交易机会
3. **增加 Top-K**: 分散投资风险
4. **调整止损止盈**: 让盈利跑得更远

### 如果回撤太大

1. **提高买入阈值**: 只选最优股票
2. **减少 Top-K**: 集中投资
3. **设置严格止损**: 单次亏损 < 5%
4. **降低仓位**: 每只股票投入 < 5%

### 如果交易频率过高

1. **提高阈值**: 减少触发信号
2. **减少 Top-K**: 限制交易数量
3. **增加信号过滤**: 添加额外条件

---

## 常见问题

### Q: 为什么回测收益和预期不符?

A:
1. 预测质量可能不够好(R² < 0.1)
2. 阈值设置不合理
3. 市场环境变化导致模型失效
4. 交易成本和滑点影响

### Q: 如何验证策略有效性?

A:
1. 在不同时间段回测(2025 Q1, Q2, Q3, Q4)
2. 在不同股票池回测(沪深300, 中证500)
3. 对比基准收益(沪深300指数)
4. 关注夏普比率和最大回撤

### Q: 可以实盘使用吗?

A: 建议:
1. 先在模拟盘测试 3-6 个月
2. 用小资金实盘验证
3. 持续监控和优化
4. 设置严格的风控规则

---

## 下一步行动

1. **运行示例回测**: 熟悉整个流程
2. **调整参数**: 找到最优策略组合
3. **优化模型**: 提升预测质量
4. **风险管理**: 添加更多保护机制
5. **实盘准备**: 小资金测试验证

---

## 参考资源

- [回测详细指南](./docs/backtest_guide.md)
- [示例脚本说明](./examples/README.md)
- [CustomSG_QlibFactor 源码](./src/adapters/hikyuu/custom_sg_qlib_factor.py)
- [Hikyuu 官方文档](https://hikyuu.org)
- [Qlib 官方文档](https://qlib.readthedocs.io)
