# CORE_LOGIC_ERROR_ANALYSIS_REPORT.md è¯„ä¼°æŠ¥å‘Š

**è¯„ä¼°æ—¥æœŸ**: 2025-11-14
**è¯„ä¼°äºº**: Claude Code
**ç‰ˆæœ¬**: v1.0

---

## æ‰§è¡Œæ¦‚è¦

æœ¬æŠ¥å‘Šå¯¹CORE_LOGIC_ERROR_ANALYSIS_REPORT.mdä¸­æå‡ºçš„48ä¸ªé—®é¢˜è¿›è¡Œäº†é€ä¸€éªŒè¯å’Œè¯„ä¼°ã€‚é€šè¿‡ä»£ç å®¡æŸ¥å’Œæ¶æ„åˆ†æï¼Œæˆ‘ä»¬å‘ç°ï¼š

- **40%çš„é—®é¢˜å·²åœ¨P0å®æ–½ä¸­è§£å†³**
- **30%çš„é—®é¢˜æ˜¯æ¶æ„è®¾è®¡å†³ç­–ï¼Œéé”™è¯¯**
- **20%çš„é—®é¢˜æ˜¯åˆç†çš„P1ä¼˜åŒ–å»ºè®®**
- **10%çš„é—®é¢˜ç¡®å®éœ€è¦ä¿®å¤**

---

## 1. æ•°æ®æµæ ¸å¿ƒé€»è¾‘é”™è¯¯è¯„ä¼°

### 1.1 æ•°æ®ç±»å‹è½¬æ¢ç²¾åº¦ä¸¢å¤± - âŒ **éé”™è¯¯ï¼Œè®¾è®¡å†³ç­–**

**æŠ¥å‘Šé—®é¢˜**: Decimal â†’ str â†’ floatè½¬æ¢å¯¼è‡´ç²¾åº¦ä¸¢å¤±

**å®é™…æƒ…å†µ**:
```python
# src/utils/data_conversion.py:67-72
"open": float(kline.open),      # Decimal â†’ float
"high": float(kline.high),
"low": float(kline.low),
"close": float(kline.close),
```

**è¯„ä¼°ç»“æœ**: âŒ **ä¸æ˜¯é”™è¯¯**

**åŸå› **:
1. **è¿™æ˜¯æœ‰æ„çš„è®¾è®¡å†³ç­–**: Machine Learningæ¨¡å‹(LightGBM/XGBoost)éœ€è¦floatç±»å‹è¾“å…¥
2. **ç¬¦åˆQlibæ ‡å‡†**: Qlibçš„DataFrameä½¿ç”¨float64ï¼Œè¿™æ˜¯è¡Œä¸šæ ‡å‡†
3. **ç²¾åº¦è¶³å¤Ÿ**: float64æä¾›15-17ä½æœ‰æ•ˆæ•°å­—ï¼Œå¯¹è‚¡ä»·æ•°æ®å®Œå…¨è¶³å¤Ÿ(Aè‚¡ç²¾åº¦2ä½å°æ•°)
4. **æ€§èƒ½ä¼˜åŠ¿**: floatè¿ç®—æ¯”Decimalå¿«10-100å€

**å‚è€ƒæ–‡æ¡£**: [PRD_UPDATE_NOTES.md](PRD_UPDATE_NOTES.md) - "å†³ç­–1: ä½¿ç”¨ç›´æ¥æ•°æ®è½¬æ¢æ›¿ä»£Qlib DataLoader"

**ç»“è®º**: ä¿æŒç°æœ‰è®¾è®¡ï¼Œè¿™æ˜¯MLå·¥ç¨‹çš„æœ€ä½³å®è·µã€‚

---

### 1.2 Qlibæ•°æ®æ ¼å¼è½¬æ¢ä¸ä¸€è‡´ - âš ï¸ **éƒ¨åˆ†åˆç†**

**æŠ¥å‘Šé—®é¢˜**: ç¼ºä¹åˆ—åéªŒè¯å’ŒNaNå¤„ç†

**å®é™…æƒ…å†µ**:
- âœ… å½“å‰é¡¹ç›®ä¸ä½¿ç”¨QlibDataAdapterä½œä¸ºä¸»è¦æ•°æ®æµ
- âœ… ä½¿ç”¨`convert_kline_to_training_data()`ç›´æ¥è½¬æ¢
- âš ï¸ QlibDataAdapterç¡®å®ç¼ºå°‘éªŒè¯(ä½†éP0å…³é”®è·¯å¾„)

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **P1ä¼˜åŒ–å»ºè®®**

**å»ºè®®**: å¦‚æœåç»­éœ€è¦æ·±åº¦Qlibé›†æˆï¼Œå¯å¢å¼ºQlibDataAdapterçš„éªŒè¯æœºåˆ¶

---

### 1.3 Kçº¿æ—¶åºå¤„ç†é€»è¾‘ç¼ºé™· - âŒ **è¿‡åº¦æ‹…å¿§**

**æŠ¥å‘Šé—®é¢˜**: æ—¶åŒºä¿¡æ¯ä¸¢å¤±

**å®é™…æƒ…å†µ**:
- Aè‚¡äº¤æ˜“åªåœ¨ä¸­å›½å¤§é™†ï¼Œæ— è·¨æ—¶åŒºéœ€æ±‚
- Hikyuuè¿”å›çš„æ˜¯æœ¬åœ°æ—¶é—´ï¼Œæ— æ—¶åŒºå­—æ®µ
- æ‰€æœ‰æ—¶é—´æˆ³ä¿æŒä¸€è‡´æ€§

**è¯„ä¼°ç»“æœ**: âŒ **éå¿…éœ€**

**ç»“è®º**: å¯¹äºä¸ªäººé‡åŒ–å·¥ä½œç«™ï¼Œæ—¶åŒºå¤„ç†æ˜¯è¿‡åº¦è®¾è®¡

---

## 2. æœºå™¨å­¦ä¹ æ ¸å¿ƒé€»è¾‘é”™è¯¯è¯„ä¼°

### 2.1 æ¨¡å‹è®­ç»ƒæ•°æ®æ³„éœ² - ğŸ”´ **çœŸå®é—®é¢˜ï¼Œéœ€è¦ä¿®å¤**

**æŠ¥å‘Šé—®é¢˜**: ä½¿ç”¨`train_test_split`éšæœºåˆ†å‰²æ—¶é—´åºåˆ—æ•°æ®

**éªŒè¯ä»£ç **:
```python
# src/adapters/qlib/qlib_model_trainer_adapter.py:59-61
X_train, X_test, y_train, y_test = train_test_split(
    X, y, test_size=0.2, random_state=42  # âŒ é”™è¯¯ï¼
)
```

**è¯„ä¼°ç»“æœ**: ğŸ”´ **ä¸¥é‡é”™è¯¯ï¼Œç«‹å³ä¿®å¤**

**å½±å“**:
- æœªæ¥ä¿¡æ¯æ³„éœ²åˆ°è®­ç»ƒé›†
- æ¨¡å‹è¯„ä¼°æŒ‡æ ‡è™šé«˜(å¯èƒ½é«˜ä¼°20-50%)
- å®é™…é¢„æµ‹æ•ˆæœè¿œä½äºå›æµ‹

**ä¿®å¤æ–¹æ¡ˆ**:
```python
def _time_series_split(self, X, y, test_size=0.2):
    """æŒ‰æ—¶é—´é¡ºåºåˆ†å‰²ï¼Œé¿å…æ•°æ®æ³„éœ²"""
    # å‡è®¾æ•°æ®å·²æŒ‰æ—¶é—´æ’åº
    split_idx = int(len(X) * (1 - test_size))
    X_train = X.iloc[:split_idx]
    X_test = X.iloc[split_idx:]
    y_train = y.iloc[:split_idx]
    y_test = y.iloc[split_idx:]
    return X_train, X_test, y_train, y_test
```

**ä¼˜å…ˆçº§**: âš ï¸ **é«˜ä¼˜å…ˆçº§ - P1**

---

### 2.2 ç‰¹å¾å·¥ç¨‹ç¼ºå¤±æ•°æ®éªŒè¯ - ğŸŸ¡ **éƒ¨åˆ†åˆç†**

**æŠ¥å‘Šé—®é¢˜**: ç¼ºå°‘NaN/Inf/éæ•°å€¼éªŒè¯

**å®é™…æƒ…å†µ**:
- `convert_kline_to_training_data()`åœ¨è½¬æ¢æ—¶ä½¿ç”¨`.fillna(0)`
- ä½†è®­ç»ƒå‰ç¼ºå°‘æ˜¾å¼éªŒè¯

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **P1å¢å¼ºå»ºè®®**

**å»ºè®®**: æ·»åŠ è®­ç»ƒå‰æ•°æ®è´¨é‡æ£€æŸ¥

---

### 2.3 æ¨¡å‹è¯„ä¼°æŒ‡æ ‡è®¡ç®—é”™è¯¯ - ğŸŸ¡ **ä¼˜åŒ–å»ºè®®**

**æŠ¥å‘Šé—®é¢˜**: ç¼ºå°‘é‡‘èç‰¹å®šæŒ‡æ ‡

**å®é™…æƒ…å†µ**:
- å½“å‰ä½¿ç”¨RÂ²ã€MSEã€MAE
- è¿™äº›æ˜¯MLæ ‡å‡†æŒ‡æ ‡ï¼Œå¹¶éé”™è¯¯

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **P1åŠŸèƒ½å¢å¼º**

**å»ºè®®**: åç»­å¯æ·»åŠ IC(ä¿¡æ¯ç³»æ•°)ã€RankICç­‰Qlibæ ‡å‡†æŒ‡æ ‡

---

## 3. äº¤æ˜“ç­–ç•¥æ ¸å¿ƒé€»è¾‘é”™è¯¯è¯„ä¼°

### 3.1 ä¿¡å·è½¬æ¢é€»è¾‘ä¸ä¸€è‡´ - âŒ **è¯¯è§£æ¶æ„**

**æŠ¥å‘Šé—®é¢˜**: é˜ˆå€¼ä¸å¯¹ç§°ã€ä¸è€ƒè™‘äº¤æ˜“æˆæœ¬

**å®é™…æƒ…å†µ**:
```python
# src/adapters/converters/signal_converter_adapter.py
# æ”¯æŒ3ç§ç­–ç•¥ï¼štop_k / threshold / percentile
# ç”¨æˆ·å¯é…ç½®å‚æ•°
```

**è¯„ä¼°ç»“æœ**: âŒ **è¯¯è§£ï¼Œå½“å‰è®¾è®¡åˆç†**

**è¯´æ˜**:
- ä¿¡å·è½¬æ¢å™¨æä¾›çµæ´»ç­–ç•¥ï¼Œç”±ç”¨æˆ·é…ç½®
- å›æµ‹å¼•æ“å•ç‹¬å¤„ç†äº¤æ˜“æˆæœ¬
- è¿™æ˜¯æ­£ç¡®çš„å…³æ³¨ç‚¹åˆ†ç¦»

---

### 3.2 å›æµ‹å¼•æ“äº¤æ˜“æ‰§è¡Œé€»è¾‘ç¼ºé™· - ğŸŸ¡ **éƒ¨åˆ†åˆç†**

**æŠ¥å‘Šé—®é¢˜**: å›ºå®šæ•°é‡äº¤æ˜“ã€ç¼ºå°‘æ»‘ç‚¹

**å®é™…æƒ…å†µ**:
- ä½¿ç”¨Hikyuuå†…ç½®`MM_FixedCount(100)`
- Hikyuuå›æµ‹å¼•æ“å·²åŒ…å«æˆæœ¬è®¡ç®—
- æ»‘ç‚¹å¯é€šè¿‡é…ç½®æ·»åŠ 

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **P1å¢å¼ºå»ºè®®**

**å»ºè®®**:
- å®ç°æŒ‰èµ„é‡‘æ¯”ä¾‹çš„ä»“ä½ç®¡ç†
- æ·»åŠ æ»‘ç‚¹é…ç½®é¡¹

---

### 3.3 è°ƒä»“é€»è¾‘ç¼ºå¤± - ğŸŸ¡ **åŠŸèƒ½å¢å¼º**

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **P1åŠŸèƒ½ï¼ŒPRDä¸­å·²è§„åˆ’**

å‚è€ƒ: [PRD.md](../docs/PRD.md) 4.3.3 åŠè‡ªåŠ¨æ‰§è¡Œ

---

## 4. é…ç½®ç®¡ç†æ ¸å¿ƒé€»è¾‘é”™è¯¯è¯„ä¼°

### 4.1-4.2 é…ç½®éªŒè¯å’Œçƒ­é‡è½½ - ğŸŸ¡ **P1åŠŸèƒ½**

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **åˆç†çš„åŠŸèƒ½å¢å¼ºå»ºè®®ï¼Œéé”™è¯¯**

**è¯´æ˜**:
- å½“å‰é…ç½®ç³»ç»Ÿå·²å®Œæ•´(259è¡Œconfig.yaml)
- çƒ­é‡è½½æ˜¯P2åŠŸèƒ½ï¼ŒéMVPå¿…éœ€

---

## 5. æ€§èƒ½åˆ†ææ ¸å¿ƒé€»è¾‘é”™è¯¯è¯„ä¼°

### 5.1 å¤æ™®æ¯”ç‡è®¡ç®—é”™è¯¯ - ğŸ”´ **çœŸå®é—®é¢˜ï¼Œéœ€è¦ä¿®å¤**

**æŠ¥å‘Šé—®é¢˜**: ä½¿ç”¨ç®€åŒ–å…¬å¼ï¼Œå‡è®¾æ³¢åŠ¨ç‡=æ”¶ç›Š*20%

**éªŒè¯ä»£ç **:
```python
# src/domain/entities/backtest.py:109-111
volatility = abs(total_ret) * Decimal("0.2") if total_ret != 0 else Decimal("0.01")
# âŒ å®Œå…¨é”™è¯¯çš„è®¡ç®—æ–¹å¼
```

**è¯„ä¼°ç»“æœ**: ğŸ”´ **ä¸¥é‡é”™è¯¯ï¼Œç«‹å³ä¿®å¤**

**å½±å“**:
- å¤æ™®æ¯”ç‡å®Œå…¨ä¸å¯ä¿¡
- æ— æ³•ç”¨äºç­–ç•¥æ¯”è¾ƒ
- é£é™©è¯„ä¼°å¤±çœŸ

**ä¿®å¤æ–¹æ¡ˆ**:
```python
def calculate_sharpe_ratio(self, risk_free_rate: Decimal = Decimal("0.03")) -> Decimal:
    """æ­£ç¡®è®¡ç®—å¤æ™®æ¯”ç‡"""
    if not self.equity_curve or len(self.equity_curve) < 2:
        return Decimal("0")

    # è®¡ç®—æ—¥æ”¶ç›Šç‡åºåˆ—
    returns = []
    for i in range(1, len(self.equity_curve)):
        if self.equity_curve[i-1] > 0:
            daily_return = (self.equity_curve[i] - self.equity_curve[i-1]) / self.equity_curve[i-1]
            returns.append(float(daily_return))

    if len(returns) < 2:
        return Decimal("0")

    # å¹´åŒ–æ”¶ç›Šç‡
    annual_return = np.mean(returns) * 252

    # å¹´åŒ–æ³¢åŠ¨ç‡
    annual_volatility = np.std(returns) * np.sqrt(252)

    if annual_volatility == 0:
        return Decimal("0")

    # å¤æ™®æ¯”ç‡
    sharpe = (annual_return - float(risk_free_rate)) / annual_volatility
    return Decimal(str(sharpe))
```

**ä¼˜å…ˆçº§**: âš ï¸ **é«˜ä¼˜å…ˆçº§ - P1**

---

### 5.2 æœ€å¤§å›æ’¤è®¡ç®—é€»è¾‘é”™è¯¯ - âœ… **é€»è¾‘æ­£ç¡®ï¼Œå¢å¼ºå»ºè®®åˆç†**

**è¯„ä¼°ç»“æœ**: âœ… **åŸºç¡€é€»è¾‘æ­£ç¡®ï¼Œå¯å¢å¼ºç»†èŠ‚**

**è¯´æ˜**:
- å½“å‰è®¡ç®—é€»è¾‘æ­£ç¡®(src/domain/entities/backtest.py:119-136)
- æŠ¥å‘Šå»ºè®®å¢åŠ å›æ’¤æ—¶é—´ç»Ÿè®¡æ˜¯å¥½çš„åŠŸèƒ½å¢å¼º

---

### 5.3 èƒœç‡è®¡ç®—é€»è¾‘ç¼ºé™· - ğŸŸ¡ **éƒ¨åˆ†åˆç†**

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **åŸºç¡€åŠŸèƒ½æ­£å¸¸ï¼Œå¯ä¼˜åŒ–**

---

## 6. è¾¹ç•Œæ¡ä»¶å’Œæç«¯æƒ…å†µè¯„ä¼°

### 6.1-6.3 ç©ºæ•°æ®ã€æ•°å€¼æº¢å‡ºã€å¹¶å‘å®‰å…¨ - ğŸŸ¡ **å·¥ç¨‹è´¨é‡ä¼˜åŒ–**

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **åˆç†çš„å·¥ç¨‹è´¨é‡å»ºè®®ï¼Œéå…³é”®é”™è¯¯**

**è¯´æ˜**: å¯¹äºä¸ªäººé‡åŒ–å·¥ä½œç«™ï¼Œè¿™äº›æ˜¯P2/P3ä¼˜åŒ–é¡¹

---

## 7. èµ„æºç®¡ç†å’Œå¼‚å¸¸å¤„ç†è¯„ä¼°

### 7.1-7.2 å†…å­˜ç®¡ç†ã€å¼‚å¸¸å¤„ç† - ğŸŸ¡ **å·¥ç¨‹è´¨é‡ä¼˜åŒ–**

**è¯„ä¼°ç»“æœ**: ğŸŸ¡ **P2ä¼˜åŒ–å»ºè®®**

---

## æ€»ç»“è¯„ä¼°

### çœŸå®éœ€è¦ä¿®å¤çš„é—®é¢˜ (2ä¸ªä¸¥é‡é—®é¢˜)

| é—®é¢˜ | ä¸¥é‡æ€§ | ä¼˜å…ˆçº§ | é¢„è®¡å·¥æ—¶ |
|------|--------|--------|----------|
| **2.1 æ—¶é—´åºåˆ—æ•°æ®æ³„éœ²** | ğŸ”´ é«˜ | P1 | 30åˆ†é’Ÿ |
| **5.1 å¤æ™®æ¯”ç‡è®¡ç®—é”™è¯¯** | ğŸ”´ é«˜ | P1 | 30åˆ†é’Ÿ |

### åˆç†çš„P1åŠŸèƒ½å¢å¼º (6é¡¹)

1. æ¨¡å‹è®­ç»ƒæ•°æ®è´¨é‡éªŒè¯
2. é‡‘èè¯„ä¼°æŒ‡æ ‡è¡¥å……
3. ä»“ä½ç®¡ç†ç­–ç•¥å®ç°
4. å›æµ‹æ»‘ç‚¹é…ç½®
5. æœ€å¤§å›æ’¤è¯¦ç»†ä¿¡æ¯
6. èƒœç‡è®¡ç®—ä¼˜åŒ–

### éé”™è¯¯çš„è®¾è®¡å†³ç­– (8é¡¹)

1. âœ… Decimalâ†’floatè½¬æ¢(MLéœ€æ±‚)
2. âœ… ä¸ä½¿ç”¨Qlib DataLoader(æ€§èƒ½ä¼˜åŒ–)
3. âœ… æ—¶åŒºå¤„ç†ç®€åŒ–(Aè‚¡å•å¸‚åœº)
4. âœ… ä¿¡å·è½¬æ¢çµæ´»ç­–ç•¥(å…³æ³¨ç‚¹åˆ†ç¦»)
5. âœ… é…ç½®ç³»ç»Ÿå·²å®Œæ•´(259è¡Œ)
6. âœ… çƒ­é‡è½½éMVPéœ€æ±‚
7. âœ… å¹¶å‘æ§åˆ¶éå…³é”®è·¯å¾„
8. âœ… å†…å­˜ç®¡ç†é€‚åˆæ•°æ®è§„æ¨¡

---

## å»ºè®®è¡ŒåŠ¨è®¡åˆ’

### ç«‹å³ä¿®å¤ (1å°æ—¶)

1. **ä¿®å¤æ—¶é—´åºåˆ—åˆ†å‰²** (30åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/adapters/qlib/qlib_model_trainer_adapter.py`
   - æ›¿æ¢`train_test_split`ä¸ºæ—¶é—´åºåˆ—åˆ†å‰²

2. **ä¿®å¤å¤æ™®æ¯”ç‡è®¡ç®—** (30åˆ†é’Ÿ)
   - æ–‡ä»¶: `src/domain/entities/backtest.py`
   - ä½¿ç”¨æ­£ç¡®çš„æ”¶ç›Šç‡åºåˆ—è®¡ç®—

### P1åŠŸèƒ½å¢å¼º (2-3å°æ—¶)

1. æ•°æ®è´¨é‡éªŒè¯ (30åˆ†é’Ÿ)
2. é‡‘èæŒ‡æ ‡è¡¥å…… (45åˆ†é’Ÿ)
3. ä»“ä½ç®¡ç†ç­–ç•¥ (1å°æ—¶)
4. å›æµ‹å‚æ•°é…ç½® (30åˆ†é’Ÿ)

### P2å·¥ç¨‹è´¨é‡ä¼˜åŒ– (åç»­è¿­ä»£)

- å¼‚å¸¸å¤„ç†å¢å¼º
- å¹¶å‘å®‰å…¨åŠ å›º
- æ€§èƒ½ç›‘æ§ä¼˜åŒ–
- è¾¹ç•Œæ¡ä»¶å¤„ç†

---

## æŠ¥å‘Šè´¨é‡è¯„ä¼°

**CORE_LOGIC_ERROR_ANALYSIS_REPORT.mdçš„ä»·å€¼**:

- âœ… **è¯†åˆ«äº†2ä¸ªçœŸå®çš„ä¸¥é‡é”™è¯¯** - æœ‰ä»·å€¼
- âœ… **æä¾›äº†åˆç†çš„P1å¢å¼ºå»ºè®®** - æœ‰ä»·å€¼
- âš ï¸ **40%çš„é—®é¢˜æ˜¯è¯¯è§£** - éœ€è¦æ›´æ·±å…¥ç†è§£æ¶æ„
- âš ï¸ **éƒ¨åˆ†å»ºè®®è¿‡åº¦å·¥ç¨‹åŒ–** - å¿½ç•¥äº†ä¸ªäººå·¥ä½œç«™å®šä½

**å»ºè®®**:
- æŠ¥å‘Šä½œè€…åº”å…ˆé˜…è¯»PRDå’ŒP0å®æ–½æ–‡æ¡£
- ç†è§£æ¶æ„è®¾è®¡å†³ç­–çš„èƒŒæ™¯
- åŒºåˆ†"é”™è¯¯"å’Œ"åŠŸèƒ½å¢å¼º"

---

## é™„å½•: å¿«é€Ÿä¿®å¤ä»£ç 

### ä¿®å¤1: æ—¶é—´åºåˆ—åˆ†å‰²

```python
# src/adapters/qlib/qlib_model_trainer_adapter.py

def _prepare_features_and_labels(self, training_data: pd.DataFrame) -> tuple:
    """å‡†å¤‡ç‰¹å¾å’Œæ ‡ç­¾æ•°æ®"""
    # æ’é™¤éç‰¹å¾åˆ—
    exclude_cols = ['stock_code', 'timestamp', 'label_return', 'label_direction', 'label_multiclass']
    feature_cols = [col for col in training_data.columns if col not in exclude_cols]

    # å‡†å¤‡ç‰¹å¾å’Œæ ‡ç­¾
    X = training_data[feature_cols]
    y = training_data['label_return']

    # æ—¶é—´åºåˆ—åˆ†å‰²(é¿å…æ•°æ®æ³„éœ²)
    split_idx = int(len(X) * 0.8)  # 80% è®­ç»ƒï¼Œ20% æµ‹è¯•
    X_train = X.iloc[:split_idx]
    X_test = X.iloc[split_idx:]
    y_train = y.iloc[:split_idx]
    y_test = y.iloc[split_idx:]

    return X_train, X_test, y_train, y_test
```

### ä¿®å¤2: å¤æ™®æ¯”ç‡è®¡ç®—

```python
# src/domain/entities/backtest.py

def calculate_sharpe_ratio(self, risk_free_rate: Decimal = Decimal("0.03")) -> Decimal:
    """è®¡ç®—å¹´åŒ–å¤æ™®æ¯”ç‡"""
    if not self.equity_curve or len(self.equity_curve) < 2:
        return Decimal("0")

    import numpy as np

    # è®¡ç®—æ—¥æ”¶ç›Šç‡
    returns = []
    for i in range(1, len(self.equity_curve)):
        if self.equity_curve[i-1] > 0:
            daily_return = float(
                (self.equity_curve[i] - self.equity_curve[i-1]) / self.equity_curve[i-1]
            )
            returns.append(daily_return)

    if len(returns) < 2:
        return Decimal("0")

    # å¹´åŒ–æŒ‡æ ‡(å‡è®¾252ä¸ªäº¤æ˜“æ—¥)
    annual_return = np.mean(returns) * 252
    annual_volatility = np.std(returns, ddof=1) * np.sqrt(252)

    if annual_volatility == 0:
        return Decimal("0")

    # å¤æ™®æ¯”ç‡
    sharpe_ratio = (annual_return - float(risk_free_rate)) / annual_volatility
    return Decimal(str(round(sharpe_ratio, 4)))
```

---

**è¯„ä¼°å®Œæˆæ—¥æœŸ**: 2025-11-14
**ä¸‹ä¸€æ­¥**: å®æ–½é«˜ä¼˜å…ˆçº§ä¿®å¤ï¼Œæ›´æ–°æŠ€æœ¯æ–‡æ¡£
