# é”™è¯¯æ£€æŸ¥æµ‹è¯•æŠ¥å‘Š

## æµ‹è¯•æ‰§è¡Œæ—¶é—´
2025-11-14

## æµ‹è¯•æ–¹æ³•

ä½¿ç”¨ `run_test_with_error_check.sh` è„šæœ¬å¯¹æ‰€æœ‰å…³é”®å‘½ä»¤è¿›è¡Œè‡ªåŠ¨é”™è¯¯æ£€æµ‹ã€‚

è¯¥è„šæœ¬ä¼šï¼š
1. æ‰§è¡Œå‘½ä»¤å¹¶æ•è·æ‰€æœ‰è¾“å‡º
2. è‡ªåŠ¨æœç´¢é”™è¯¯å…³é”®å­—ï¼ˆerror, fail, exception, traceback, abortç­‰ï¼‰
3. æ˜¾ç¤ºå½©è‰²çš„æµ‹è¯•ç»“æœ
4. ä¿å­˜å®Œæ•´æ—¥å¿—åˆ° `/tmp/test_output_*.log`

## æµ‹è¯•ç»“æœæ€»ç»“

| æµ‹è¯•é¡¹ | ç»“æœ | è¯´æ˜ |
|--------|------|------|
| æŒ‡æ•°æˆåˆ†è‚¡è·å– | âœ… é€šè¿‡ | æœªå‘ç°é”™è¯¯ |
| æ•°æ®åŠ è½½(sh600000) | âœ… é€šè¿‡ | æˆåŠŸåŠ è½½242æ¡Kçº¿æ•°æ® |
| æ‰¹é‡è®­ç»ƒ(3åªè‚¡ç¥¨) | âš ï¸  è¯¯æŠ¥ | æ¨¡å‹è®­ç»ƒæˆåŠŸï¼Œä½†æ¨¡å‹ååŒ…å«"error"å¯¼è‡´è¯¯æŠ¥ |
| æ¨¡å‹è®­ç»ƒ(1å¹´æ•°æ®) | âœ… é€šè¿‡ | æˆåŠŸè®­ç»ƒå¹¶ä¿å­˜æ¨¡å‹ |
| ä¾èµ–æ£€æŸ¥ | âœ… é€šè¿‡ | æ‰€æœ‰10ä¸ªä¾èµ–æ­£ç¡®å®‰è£… |

## è¯¦ç»†æµ‹è¯•ç»“æœ

### 1. æŒ‡æ•°æˆåˆ†è‚¡è·å–æµ‹è¯• âœ…

**å‘½ä»¤**:
```bash
./run_test_with_error_check.sh "python3 test_index_constituents.py"
```

**ç»“æœ**:
```
âœ“ æœªå‘ç°é”™è¯¯å…³é”®å­—
æµ‹è¯•é€šè¿‡ âœ“
```

**æ—¥å¿—**: `/tmp/test_output_20251114_083217.log`

---

### 2. æ•°æ®åŠ è½½æµ‹è¯• âœ…

**å‘½ä»¤**:
```bash
./run_test_with_error_check.sh \
    "./run_cli.sh data load --code sh600000 --start 2023-01-01 --end 2023-12-31"
```

**ç»“æœ**:
```
âœ“ Successfully loaded 242 K-line records for sh600000
âœ“ Date range: 2023-01-03 to 2023-12-29
âœ“ æœªå‘ç°é”™è¯¯å…³é”®å­—
æµ‹è¯•é€šè¿‡ âœ“
```

**æ—¥å¿—**: `/tmp/test_output_20251114_083228.log`

---

### 3. æ‰¹é‡è®­ç»ƒæµ‹è¯• âš ï¸

**å‘½ä»¤**:
```bash
./run_test_with_error_check.sh \
    "./run_cli.sh model train-index --type LGBM --name test_error_check \
    --index æ²ªæ·±300 --start 2023-01-01 --end 2023-12-31 --max-stocks 3"
```

**ç»“æœ**:
```
âœ— å‘ç°é”™è¯¯:
  â†’ â„¹   æ¨¡å‹åç§°: test_error_check
  â†’ âœ“ æ¨¡å‹ 'test_error_check' è®­ç»ƒæˆåŠŸ!

é”™è¯¯ç»Ÿè®¡:
  â€¢ error: 2 æ¬¡
```

**åˆ†æ**:
- **è¯¯æŠ¥åŸå› **: æ¨¡å‹åç§°åŒ…å« "error_check"ï¼Œgrep åŒ¹é…åˆ°äº† "error" å…³é”®å­—
- **å®é™…çŠ¶æ€**: æ¨¡å‹è®­ç»ƒæˆåŠŸ
- **æ”¹è¿›å»ºè®®**: åœ¨æ¨¡å‹åç§°ä¸­é¿å…ä½¿ç”¨é”™è¯¯å…³é”®å­—ï¼Œæˆ–æ”¹è¿› grep æ¨¡å¼æ’é™¤æ­£å¸¸çš„ä¿¡æ¯è¾“å‡º

**æ—¥å¿—**: `/tmp/test_output_20251114_083258.log`

---

### 4. æ¨¡å‹è®­ç»ƒæµ‹è¯• âœ…

**å‘½ä»¤**:
```bash
./run_test_with_error_check.sh \
    "./run_cli.sh model train --type LGBM --name test_improved_adapters \
    --code sh600036 --start 2023-01-01 --end 2023-12-31"
```

**ç»“æœ**:
```
âœ“ Loaded 242 K-line records from Hikyuu
âœ“ Converted to training data: 182 records with features
âœ“ Model 'test_improved_adapters' trained successfully!
âœ“ æœªå‘ç°é”™è¯¯å…³é”®å­—
æµ‹è¯•é€šè¿‡ âœ“
```

**è®­ç»ƒæŒ‡æ ‡**:
- train_rmse: 0.0098 (0.98%)
- test_rmse: 0.0133 (1.33%)
- train_r2: 0.5404 (54%)
- test_r2: -0.0336 (-3.4%)

**æ—¥å¿—**: `/tmp/test_output_20251114_082141.log`

---

### 5. ä¾èµ–æ£€æŸ¥æµ‹è¯• âœ…

**å‘½ä»¤**:
```bash
python3 scripts/check_dependencies.py
```

**ç»“æœ**:
```
âœ… æ‰€æœ‰ 10 ä¸ªä¾èµ–å·²æ­£ç¡®å®‰è£…!

å·²å®‰è£…ç‰ˆæœ¬:
  Hikyuu               2.6.8
  LightGBM             4.6.0
  Pandas               2.3.3
  NumPy                2.3.3
  PyMySQL              1.4.6
  aiosqlite            0.21.0
  asyncio              unknown
  PyYAML               6.0.3
  Click                8.3.0
  pytest               8.4.2
```

---

## å‘ç°çš„é—®é¢˜

### 1. è¯¯æŠ¥é—®é¢˜ âš ï¸

**é—®é¢˜**: å½“æ¨¡å‹åç§°ã€å˜é‡åæˆ–æ³¨é‡Šä¸­åŒ…å«é”™è¯¯å…³é”®å­—æ—¶ï¼Œä¼šè¢«é”™è¯¯æ£€æµ‹

**ç¤ºä¾‹**:
- æ¨¡å‹åç§°: `test_error_check` â†’ è§¦å‘ "error" åŒ¹é…
- æ³¨é‡Š: `# Handle error cases` â†’ è§¦å‘ "error" åŒ¹é…

**è§£å†³æ–¹æ¡ˆ**:

#### æ–¹æ¡ˆ A: æ”¹è¿› grep æ¨¡å¼ï¼ˆæ¨èï¼‰
```bash
# å½“å‰æ¨¡å¼ï¼ˆè¿‡äºå®½æ¾ï¼‰
grep -iE "(error|fail|exception|traceback|abort)"

# æ”¹è¿›æ¨¡å¼ï¼ˆåªåŒ¹é…çœŸå®é”™è¯¯ï¼‰
grep -E "^(âœ—|Error:|ERROR:|Exception:|Traceback|Aborted!|failed)"
```

#### æ–¹æ¡ˆ B: ä½¿ç”¨ä¸Šä¸‹æ–‡è¿‡æ»¤
```bash
# åªåŒ¹é…åŒ…å« âœ— ç¬¦å·çš„é”™è¯¯è¡Œ
grep -E "âœ—.*error"

# æ’é™¤ä¿¡æ¯è¡Œå’ŒæˆåŠŸè¡Œ
grep -E "(error|fail)" | grep -v "âœ“" | grep -v "â„¹"
```

#### æ–¹æ¡ˆ C: é¿å…åœ¨åç§°ä¸­ä½¿ç”¨é”™è¯¯å…³é”®å­—
```bash
# ä¸æ¨è
--name test_error_check

# æ¨è
--name test_validation
--name test_check
--name test_suite
```

---

### 2. test_r2 ä¸ºè´Ÿå€¼é—®é¢˜ï¼ˆå·²çŸ¥ï¼‰

**é—®é¢˜**: ä½¿ç”¨1å¹´æ•°æ®è®­ç»ƒå•è‚¡ç¥¨æ—¶ï¼Œtest_r2 = -0.034

**åŸå› **:
1. æµ‹è¯•é›†æ ·æœ¬é‡å°ï¼ˆ37æ¡ï¼‰
2. æ—¶é—´åºåˆ—æ•°æ®ç‰¹æ€§
3. éšæœºåˆ’åˆ†å¯èƒ½åŒ…å«å¼‚å¸¸æ³¢åŠ¨æœŸ

**è§£å†³æ–¹æ¡ˆ**: å‚è€ƒä¹‹å‰çš„åˆ†ææŠ¥å‘Š
- ä½¿ç”¨æ›´é•¿æ—¶é—´æ•°æ®ï¼ˆ2-3å¹´ï¼‰
- ä½¿ç”¨æ—¶é—´åºåˆ—åˆ’åˆ†è€Œééšæœºåˆ’åˆ†
- å¢åŠ æ­£åˆ™åŒ–

---

## æ”¹è¿›åçš„æµ‹è¯•è„šæœ¬

### æ”¹è¿›çš„é”™è¯¯æ¨¡å¼

ä¿®æ”¹ [run_test_with_error_check.sh:70](../run_test_with_error_check.sh:70):

```bash
# å½“å‰ï¼šè¿‡äºå®½æ¾
ERROR_KEYWORDS=(
    "error"
    "Error"
    "ERROR"
    "fail"
    "failed"
    # ...
)

# æ”¹è¿›ï¼šæ›´ç²¾ç¡®çš„åŒ¹é…
ERROR_PATTERNS=(
    "^âœ—.*"              # ä»¥ âœ— å¼€å¤´çš„è¡Œ
    "Error:"            # é”™è¯¯æ ‡ç­¾
    "ERROR:"
    "Exception:"
    "Traceback"
    "Aborted!"
    "^.*failed.*$"      # å¤±è´¥æ¶ˆæ¯ï¼ˆä½†æ’é™¤æˆåŠŸæ¶ˆæ¯ï¼‰
)

# æ’é™¤æ¨¡å¼ï¼ˆä¸åº”è¢«è§†ä¸ºé”™è¯¯ï¼‰
EXCLUDE_PATTERNS=(
    "âœ“.*"               # æˆåŠŸæ¶ˆæ¯
    "â„¹.*"               # ä¿¡æ¯æ¶ˆæ¯
    "æ¨¡å‹åç§°:"          # æ¨¡å‹å…ƒæ•°æ®
)
```

---

## å¯ç”¨çš„æµ‹è¯•è„šæœ¬

### 1. å•ä¸ªå‘½ä»¤æµ‹è¯•
```bash
./run_test_with_error_check.sh "your command here"
```

### 2. å¿«é€Ÿæµ‹è¯•å¥—ä»¶ï¼ˆ6ä¸ªæµ‹è¯•ï¼‰
```bash
./run_quick_tests.sh
```

åŒ…å«ï¼š
- ä¾èµ–æ£€æŸ¥
- æŒ‡æ•°æˆåˆ†è‚¡è·å–
- æ•°æ®åŠ è½½
- æ¨¡å‹è®­ç»ƒï¼ˆçŸ­æœŸ + é•¿æœŸï¼‰
- æ‰¹é‡è®­ç»ƒï¼ˆ5åªè‚¡ç¥¨ï¼‰

### 3. ç»¼åˆæµ‹è¯•å¥—ä»¶ï¼ˆ12ä¸ªæµ‹è¯•ï¼‰
```bash
./run_comprehensive_tests.sh
```

åŒ…å«å¿«é€Ÿæµ‹è¯• + é¢å¤–çš„ï¼š
- å¤šè‚¡ç¥¨è®­ç»ƒ
- æ¨¡å‹æŸ¥è¯¢
- å¤§è§„æ¨¡æ‰¹é‡è®­ç»ƒ

---

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

**é¿å…åœ¨åç§°ä¸­ä½¿ç”¨é”™è¯¯å…³é”®å­—**:
```bash
# âŒ ä¸æ¨è
--name error_handling_test
--name failure_recovery_test
--name exception_test

# âœ… æ¨è
--name validation_test
--name recovery_test
--name boundary_test
```

### 2. æµ‹è¯•ç­–ç•¥

**åˆ†å±‚æµ‹è¯•**:
1. **å¿«é€Ÿå†’çƒŸæµ‹è¯•**ï¼ˆ<5åˆ†é’Ÿï¼‰
   ```bash
   ./run_test_with_error_check.sh "python3 test_index_constituents.py"
   ```

2. **é›†æˆæµ‹è¯•**ï¼ˆ5-15åˆ†é’Ÿï¼‰
   ```bash
   ./run_quick_tests.sh
   ```

3. **å®Œæ•´å›å½’æµ‹è¯•**ï¼ˆ>30åˆ†é’Ÿï¼‰
   ```bash
   ./run_comprehensive_tests.sh
   ```

### 3. CI/CD é›†æˆ

```yaml
# GitHub Actions ç¤ºä¾‹
- name: Run smoke tests
  run: |
    source ~/anaconda3/bin/activate qlib_hikyuu
    ./run_test_with_error_check.sh "python3 scripts/check_dependencies.py"

- name: Run integration tests
  run: |
    source ~/anaconda3/bin/activate qlib_hikyuu
    ./run_quick_tests.sh
```

---

## ç»“è®º

### âœ… æˆåŠŸçš„æ–¹é¢

1. **é”™è¯¯æ£€æŸ¥æœºåˆ¶**ï¼šæˆåŠŸæ£€æµ‹å¹¶é«˜äº®é”™è¯¯è¾“å‡º
2. **ä¾èµ–ç®¡ç†**ï¼šæ‰€æœ‰ä¾èµ–æ­£ç¡®å®‰è£…å’Œé…ç½®
3. **Mock æ”¹è¿›**ï¼šæ‰€æœ‰é€‚é…å™¨çš„æ¡ä»¶å¯¼å…¥å·²æ”¹è¿›
4. **æµ‹è¯•è¦†ç›–**ï¼šå…³é”®åŠŸèƒ½éƒ½æœ‰è‡ªåŠ¨åŒ–æµ‹è¯•

### âš ï¸ éœ€è¦æ”¹è¿›çš„æ–¹é¢

1. **è¯¯æŠ¥é—®é¢˜**ï¼šéœ€è¦æ”¹è¿› grep æ¨¡å¼é¿å…è¯¯æŠ¥
2. **æµ‹è¯•æ•°æ®**ï¼šçŸ­æœŸæ•°æ®è®­ç»ƒé¢„æœŸä¼šå¤±è´¥ï¼Œéœ€è¦æ›´å¥½çš„æ–‡æ¡£è¯´æ˜
3. **RÂ² ä¼˜åŒ–**ï¼šå•è‚¡ç¥¨è®­ç»ƒçš„ test_r2 è¿˜éœ€è¦ä¼˜åŒ–

### ğŸ“‹ åç»­è¡ŒåŠ¨

1. [ ] æ”¹è¿›é”™è¯¯æ£€æµ‹æ¨¡å¼ï¼Œå‡å°‘è¯¯æŠ¥
2. [ ] æ·»åŠ æµ‹è¯•æ•°æ®è¦æ±‚çš„æ–‡æ¡£
3. [ ] å®ç°æ—¶é—´åºåˆ—åˆ’åˆ†ä¼˜åŒ– test_r2
4. [ ] æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•

---

## é™„å½•

### å¯ç”¨å‘½ä»¤åˆ—è¡¨

```bash
# ä¾èµ–æ£€æŸ¥
python3 scripts/check_dependencies.py

# æŒ‡æ•°æˆåˆ†è‚¡
python3 test_index_constituents.py

# æ•°æ®åŠ è½½
./run_cli.sh data load --code <è‚¡ç¥¨ä»£ç > --start <å¼€å§‹æ—¥æœŸ> --end <ç»“æŸæ—¥æœŸ>

# å•è‚¡ç¥¨è®­ç»ƒ
./run_cli.sh model train --type LGBM --name <æ¨¡å‹å> \
    --code <è‚¡ç¥¨ä»£ç > --start <å¼€å§‹æ—¥æœŸ> --end <ç»“æŸæ—¥æœŸ>

# æ‰¹é‡è®­ç»ƒ
./run_cli.sh model train-index --type LGBM --name <æ¨¡å‹å> \
    --index <æŒ‡æ•°å> --start <å¼€å§‹æ—¥æœŸ> --end <ç»“æŸæ—¥æœŸ> --max-stocks <æ•°é‡>

# æ¨¡å‹æŸ¥è¯¢
./run_cli.sh model list
./run_cli.sh model show --name <æ¨¡å‹å>
```

### æ—¥å¿—ä½ç½®

æ‰€æœ‰æµ‹è¯•æ—¥å¿—ä¿å­˜åœ¨ï¼š
```
/tmp/test_output_YYYYMMDD_HHMMSS.log
```

æŸ¥çœ‹æœ€æ–°æ—¥å¿—ï¼š
```bash
ls -lt /tmp/test_output_*.log | head -1
```

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-14
**æµ‹è¯•ç¯å¢ƒ**: macOS (Darwin 24.6.0), Python 3.13.0, Hikyuu 2.6.8
