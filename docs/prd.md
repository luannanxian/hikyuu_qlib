好的，遵照您的所有要求，特别是：
1.  **聚焦个人用户，移除企业级特性**。
2.  **明确职责边界：Qlib 负责机器学习，Hikyuu 负责内置回测与执行**。

我为您整理出这份**完整的、精简后的《Hikyuu × Qlib 个人量化工作站 PRD》文档。**

---

# 📝 Hikyuu × Qlib 个人量化工作站 产品需求文档 (PRD)

## 1. 项目概述与背景

### 1.1 项目目标

目标是构建一套适用于**个人独立投资者**的“桌面级量化工作站”，一站式实现 AI 建模与策略执行的完整闭环。该工作站将融合两个核心框架的优势：

* **Qlib (Microsoft Research Asia)：** 提供强大的**机器学习建模**、因子工程和预测能力。
* **Hikyuu (开源金融量化框架)：** 提供稳定的**行情数据获取**、**策略回测**和**半自动执行生态**。

### 1.2 核心价值

* **数据整合：** 打通 Hikyuu 数据到 Qlib 建模的壁垒。
* **低门槛 AI：** 为个人投资者提供快速体验机器学习择时/选股的能力。
* **执行闭环：** 将 AI 信号无缝导入 Hikyuu **内置回测引擎**进行验证和执行。

## 2. 目标用户与环境要求

### 2.1 目标用户

| 用户类型 | 核心诉求 |
| :--- | :--- |
| **量化爱好者** | 想体验机器学习择时/选股，降低数据准备与建模门槛。 |
| **技术指标型交易者** | 期望自动化处理更多特征，利用 AI 提升策略效率。 |
| **兼职自营投资者** | 希望快速试验新想法、采信 AI 信号，但仍保持人工把控。 |

### 2.2 硬件平台要求

本项目专注于**桌面级**环境的可用性与轻量化。

* **支持操作系统：** macOS（Apple Silicon，M1/M2 系列）
* **建议配置：** 16GB 内存以上、推荐 512GB SSD（用于存放行情与实验数据）

## 3. 产品功能目标（MVP）

1.  **数据流通 (P0)：** Hikyuu 行情数据通过定制的 DataLoader **一键加载**到 Qlib。
2.  **快速建模 (P0)：** 提供预设脚本，**最少配置**完成 AI 模型训练与预测。
3.  **策略验证 (P0)：** Qlib 预测信号自动转换为 Hikyuu 信号格式，并**调用 Hikyuu 内置回测功能**进行验证。
4.  **配置驱动 (P0)：** 所有参数配置化，方便用户快速迭代。

---

## 4. 功能需求与职责划分

### 4.1 数据与特征（Qlib 数据加载 / 建模准备）

| ID | 功能名称 | 优先级 | 描述 |
| :--- | :--- | :--- | :--- |
| 4.1.1 | **数据接入向导** | P0 | 提供脚本/简易 UI 指引用户配置 Hikyuu 数据目录、市场、标的、时间范围。默认支持日线 HDF5 数据。 |
| 4.1.2 | **Qlib DataLoader 适配** | P0 | 提供 **`HikyuuDataLoader`**，默认加载核心字段（开高低收量额、复权因子等）。支持可选的增量加载模式以控制内存占用。 |
| 4.1.3 | **特征模板** | P1 | 附带常用技术指标组合（EMA, MACD, RSI, 量价等），导出为 Qlib 特征。支持 YAML/JSON 模板自定义参数。 |

### 4.2 机器学习建模与实验（Qlib 核心职责）

| ID | 功能名称 | 优先级 | 描述 |
| :--- | :--- | :--- | :--- |
| 4.2.1 | **快速训练脚本** | P0 | 默认 LGBModel + 基础指标数据集，**一键训练并生成 Qlib 预测结果 (`pred.pkl`)**。支持命令行参数指定训练窗口。 |
| 4.2.2 | **实验记录** | P1 | **默认使用 Qlib 内置的 R 模块**，在本地记录参数、指标与预测文件，确保轻量可用。 |
| 4.2.3 | **约束机制** | P1 | 预设训练资源上限、评估指标阈值；记录数据版本与特征编排，确保训练可复现。 |
| 4.2.4 | **透明性** | P1 | **Qlib 训练后**输出特征重要度、预测区间等可解释信息。 |

### 4.3 策略执行与回测（Hikyuu 核心职责）

| ID | 功能名称 | 优先级 | 描述 |
| :--- | :--- | :--- | :--- |
| 4.3.1 | **信号转换适配器** | P0 | 将 **Qlib 的 `pred.pkl`**（MultiIndex DataFrame）转换为 Hikyuu **内置信号格式**（CSV/JSON），作为 Hikyuu 策略的输入。支持 Top-K 选股与择时信号映射规则。 |
| 4.3.2 | **回测脚本** | P0 | **调用 Hikyuu 内置的 Portfolio/TradeManager** 完成回测，输出收益曲线与关键指标。输出 CSV 或图形结果。 |
| 4.3.3 | **半自动执行** | P1 | **利用 Hikyuu 的内置功能**在 GUI/命令行中展示格式化调仓建议，用户确认后再执行。设定仓位限制、止损止盈等安全约束。 |

### 4.4 配置、日志与复盘

| ID | 功能名称 | 优先级 | 描述 |
| :--- | :--- | :--- | :--- |
| 4.4.1 | **配置优先** | P0 | 所有可变参数（标的池、时间区间、特征列表、模型参数等）统一抽离至 `config.yaml`。用户 80% 场景仅需修改配置。 |
| 4.4.2 | **端到端示例** | P0 | 提供一套完整的示例策略，包含数据准备、**Qlib 训练/预测**、信号转换、**Hikyuu 回测**与基础报告。 |
| 4.4.3 | **日志与监控** | P1 | 记录数据更新、训练、信号生成、执行结果，提供简易日志管理。 |
| 4.4.4 | **复盘工具** | P1 | 自动生成策略**回测结果 CSV** 和**基础收益曲线图表**，支持对比多个实验的回测表现。 |

---

## 5. 用户旅程（AI 策略闭环）

1.  **安装配置：** 运行一键脚本安装环境，并运行 `check_env.py` 验证依赖。
2.  **数据准备（Hikyuu → Qlib）：** 运行 `prepare_data.py`，加载 Hikyuu 行情数据，生成 Qlib Dataset。
3.  **模型训练（Qlib）：** 调用 `train_model.py`，使用默认参数训练模型，**Qlib 输出预测文件 `pred.pkl`**。
4.  **信号转换：** 运行 `export_signals.py`，将 Qlib 的 `pred.pkl` 转换为 **Hikyuu 信号格式**。
5.  **策略执行（Hikyuu）：** 在 `run_backtest.py` 或 **Hikyuu GUI 中加载信号，完成回测/调仓建议**。
6.  **复盘迭代：** 查看日志与回测报告（CSV/图表），调整配置，重复流程。

## 6. 约束与安全（个人用户风控）

* **数据合规：** 确保数据来源合法，提醒用户遵守当地监管政策。
* **资源限制：** 默认限制训练耗时与内存；引导用户使用增量加载。
* **风险控制：** **信号标记为“建议”**，强调需人工确认或设定多重风控阈值。提供仓位、止损、资金管理模板。
* **透明性：** 输出特征重要度、模型参数和版本，便于用户理解和回溯。

## 7. 交付计划与验收标准

| 阶段 | 时间 | 关键产出 |
| :--- | :--- | :--- |
| **MVP** | 2~3 周 | 数据适配脚本、快速训练脚本、回测脚本、**Hikyuu-Qlib 信号转换**、基础文档、**端到端示例策略**。 |
| **GA** | 4~5 周 | 指标模板、实验日志、半自动调仓支持、监控日志与基础复盘图表。 |

### 7.1 验收标准

* **效率：** 默认配置下，用户可在 **1 小时内**完成数据准备、训练与回测整个流程。
* **质量：** 所有脚本提供示例配置并能跑通；错误提示友好且可追踪。
* **留痕：** **Qlib 模型训练**、**Hikyuu 回测结果**均有日志/报告（CSV/图表）留存。
* **示范：** 提供一套完整的示例策略，包含指标、预测、回测与复盘示范。

---

**这份文档已完全聚焦于个人量化工作站的需求，并清晰划分了 Qlib 和 Hikyuu 的职责。**

您现在可以基于这份 PRD 进行开发规划。您是否需要我为您细化 **MVP 阶段**（2~3 周）的具体开发任务清单？