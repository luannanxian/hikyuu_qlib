# 需求规格说明书 - Hikyuu × Qlib 个人量化工作站

## 1. 项目概述

### 1.1 背景

随着人工智能技术在金融领域的快速发展，个人投资者对量化交易工具的需求日益增长。然而，现有的量化工具存在以下痛点：

- 数据获取和处理门槛高
- 机器学习建模技术复杂
- 策略验证和执行流程割裂
- 缺乏端到端的集成解决方案

为了解决这些问题，需要构建一套融合Hikyuu和Qlib优势的个人量化工作站，为个人投资者提供一站式AI建模与策略执行平台。

### 1.2 目标

**业务目标：**

- 为个人独立投资者提供桌面级量化工作站
- 实现AI建模与策略执行的完整闭环
- 降低机器学习在量化投资中的应用门槛

**技术目标：**

- 打通Hikyuu数据到Qlib建模的壁垒
- 实现Qlib预测信号到Hikyuu执行的无缝转换
- 构建轻量化、易用的配置驱动系统

### 1.3 范围

**包含内容：**

- Hikyuu行情数据到Qlib的数据流通
- Qlib机器学习建模与预测
- 预测信号到Hikyuu执行格式的转换
- Hikyuu内置回测与策略执行
- 端到端配置管理和示例策略

**不包含内容：**

- 企业级特性（如多用户管理、权限控制等）
- 实时交易执行（仅支持半自动执行）

### 1.4 开发总约束

**开发工作准则：**

1. **以暗猜接口为耻，以认真查阅为荣**：所有接口设计必须基于现有文档，禁止猜测接口定义
2. **以模糊执行为耻，以寻求确认为荣**：所有执行步骤必须明确，模糊需求需主动确认
3. **以盲想业务为耻，以人类确认为荣**：业务需求必须通过用户确认，禁止主观假设
4. **以创造接口为耻，以复用现有为荣**：优先复用现有接口，避免创造不必要的接口
5. **以跳过验证为耻，以主动测试为荣**：所有功能必须经过验证，禁止跳过测试
6. **以破坏架构为耻，以遵循规范为荣**：遵循现有架构规范，禁止破坏系统架构
7. **以假装理解为耻，以诚实无知为荣**：遇到不理解的问题要诚实承认，禁止假装理解
8. **以盲目修改为耻，以谨慎重构为荣**：修改代码要谨慎，禁止盲目修改现有功能

## 2. 功能需求

### 2.1 用户角色

| 角色名称 | 描述 | 主要使用场景 |
|----------|------|------|
| **量化爱好者** | 想体验机器学习择时/选股，降低数据准备与建模门槛的用户 | 学习AI建模，验证技术指标有效性 |
| **技术指标型交易者** | 期望自动化处理更多特征，利用AI提升策略效率的用户 | 批量测试技术指标组合，寻找最优参数 |
| **兼职自营投资者** | 希望快速试验新想法、采信AI信号，但仍保持人工把控的用户 | 快速试验策略，参考AI信号做决策 |

### 2.2 功能清单

#### 2.2.1 数据流通模块

- **需求ID**: FR-001
- **需求描述**: 提供数据接入向导，指导用户配置Hikyuu数据目录、市场、标的、时间范围
- **优先级**: 高
- **验收标准**:
  - 支持默认日线HDF5数据格式
  - 提供简易UI或脚本引导配置过程
  - 配置完成后能自动检测数据完整性
- **依赖关系**: 无

- **需求ID**: FR-002
- **需求描述**: 实现HikyuuDataLoader，将Hikyuu行情数据加载到Qlib
- **优先级**: 高
- **验收标准**:
  - 默认加载核心字段（开高低收量额、复权因子等）
  - 支持可选的增量加载模式
  - 数据格式转换准确无误
- **依赖关系**: FR-001

- **需求ID**: FR-003
- **需求描述**: 提供常用技术指标特征模板
- **优先级**: 中
- **验收标准**:
  - 包含EMA、MACD、RSI、量价等常用指标
  - 支持YAML/JSON模板自定义参数
  - 特征计算结果准确
- **依赖关系**: FR-002

#### 2.2.2 机器学习建模模块

- **需求ID**: FR-004
- **需求描述**: 提供快速训练脚本，支持一键训练并生成预测结果
- **优先级**: 高
- **验收标准**:
  - 默认使用LGBModel+基础指标数据集
  - 生成pred.pkl预测文件
  - 支持命令行参数指定训练窗口
- **依赖关系**: FR-002

- **需求ID**: FR-005
- **需求描述**: 实现实验记录功能，记录训练过程和结果
- **优先级**: 中
- **验收标准**:
  - 使用Qlib内置R模块记录参数和指标
  - 本地存储训练记录
  - 支持历史实验查询
- **依赖关系**: FR-004

- **需求ID**: FR-006
- **需求描述**: 建立约束机制，确保训练可复现
- **优先级**: 中
- **验收标准**:
  - 预设训练资源上限和评估指标阈值
  - 记录数据版本与特征编排
  - 支持实验条件复现
- **依赖关系**: FR-004

- **需求ID**: FR-007
- **需求描述**: 提供模型透明性输出
- **优先级**: 中
- **验收标准**:
  - 输出特征重要度信息
  - 提供预测区间等可解释信息
  - 输出格式清晰易读
- **依赖关系**: FR-004

#### 2.2.3 策略执行与回测模块

- **需求ID**: FR-008
- **需求描述**: 实现信号转换适配器，将Qlib预测转换为Hikyuu信号格式
- **优先级**: 高
- **验收标准**:
  - 支持Qlib的pred.pkl（MultiIndex DataFrame）转换
  - 输出Hikyuu内置信号格式（CSV/JSON）
  - 支持Top-K选股与择时信号映射规则
- **依赖关系**: FR-004

- **需求ID**: FR-009
- **需求描述**: 提供回测脚本，调用Hikyuu内置功能完成回测
- **优先级**: 高
- **验收标准**:
  - 调用Hikyuu内置的Portfolio/TradeManager
  - 输出收益曲线与关键指标
  - 支持CSV或图形结果输出
- **依赖关系**: FR-008

- **需求ID**: FR-010
- **需求描述**: 实现基础调仓建议功能
- **优先级**: 中
- **风险预判**:
  - 调仓建议展示不清晰
  - 用户理解偏差导致错误决策
- **验收标准**:
  - 在GUI/命令行中展示格式化调仓建议
  - 支持用户查看建议详情
  - 调仓建议包含明确的买入/卖出信号
  - 提供简单的风险提示
- **依赖关系**: FR-009

#### 2.2.4 配置与复盘模块

- **需求ID**: FR-011
- **需求描述**: 实现配置优先设计，所有参数可配置化
- **优先级**: 高
- **验收标准**:
  - 所有可变参数统一抽离至config.yaml
  - 用户80%场景仅需修改配置
  - 配置文件结构清晰，易于理解
- **依赖关系**: 无

- **需求ID**: FR-012
- **需求描述**: 提供端到端示例策略
- **优先级**: 高
- **验收标准**:
  - 包含数据准备、Qlib训练/预测完整流程
  - 包含信号转换、Hikyuu回测与基础报告
  - 示例策略可正常运行并产生预期结果
- **依赖关系**: FR-004, FR-008, FR-009

- **需求ID**: FR-013
- **需求描述**: 实现日志与监控功能
- **优先级**: 中
- **风险预判**:
  - 日志文件过大占用存储空间
  - 日志信息过于冗余或不足
  - 敏感信息泄露风险
- **验收标准**:
  - 记录数据更新、训练、信号生成、执行结果
  - 提供简易日志管理界面
  - 支持日志查询和过滤
  - 日志文件自动轮转和清理
  - 日志级别可配置（DEBUG/INFO/WARN/ERROR）
  - 敏感信息自动脱敏处理
- **依赖关系**: FR-004, FR-009

- **需求ID**: FR-014
- **需求描述**: 提供复盘工具
- **优先级**: 中
- **风险预判**:
  - 复盘数据统计错误
  - 图表展示不准确或误导
  - 多策略对比基准不一致
- **验收标准**:
  - 自动生成策略回测结果CSV
  - 生成基础收益曲线图表
  - 支持对比多个实验的回测表现
  - 复盘数据准确性校验
  - 支持多种图表类型（线图、柱状图、散点图等）
  - 策略对比基准可配置（如沪深300、中证500等）
- **依赖关系**: FR-009, FR-013

## 3. 用户故事

### 3.1 数据准备流程

**作为** 量化爱好者
**我想要** 一键加载Hikyuu行情数据到Qlib
**以便于** 快速开始机器学习建模

**验收条件**:

- 能够通过向导配置数据源
- 数据加载过程有进度提示
- 加载完成后显示数据概览信息

### 3.2 模型训练流程

**作为** 技术指标型交易者
**我想要** 使用预设脚本快速训练AI模型
**以便于** 验证技术指标的预测能力

**验收条件**:

- 提供默认模型配置和训练脚本
- 训练过程实时显示进度和关键指标
- 训练完成后自动保存模型和预测结果

### 3.3 策略验证流程

**作为** 兼职自营投资者
**我想要** 将AI预测信号转换为可执行的交易策略
**以便于** 在实际交易中参考AI建议

**验收条件**:

- 预测信号能自动转换为交易信号
- 支持回测验证策略表现
- 提供清晰的可视化结果展示

### 3.4 风险控制流程

**作为** 兼职自营投资者
**我想要** 在执行交易前进行人工确认
**以便于** 控制交易风险并保持决策主导权

**验收条件**:

- 交易建议明确标示为"建议"性质
- 提供多重风控阈值设置
- 支持人工确认机制

## 4. 数据需求

### 4.1 数据实体

- **行情数据**: 包含开高低收量额、复权因子等核心字段
- **特征数据**: 技术指标计算结果，如EMA、MACD、RSI等
- **预测数据**: Qlib模型输出的pred.pkl文件
- **信号数据**: 转换后的Hikyuu信号格式（CSV/JSON）
- **配置数据**: YAML格式的参数配置文件
- **日志数据**: 训练、转换、执行过程的记录信息

### 4.2 数据流

1. **数据准备流**: Hikyuu HDF5数据 → HikyuuDataLoader → Qlib Dataset
2. **特征计算流**: 原始数据 → 特征模板 → Qlib特征数据
3. **模型训练流**: 特征数据 → 训练脚本 → 模型文件 + 预测结果
4. **信号转换流**: Qlib预测结果 → 信号转换器 → Hikyuu信号格式
5. **策略执行流**: Hikyuu信号 → 回测引擎 → 执行结果 + 回测报告
6. **配置管理流**: 配置文件 → 各模块参数 → 运行时配置

## 5. 假设和依赖

### 5.1 假设

- **用户技术能力**: 用户具备基本的命令行操作能力
- **数据完整性**: 用户已获取合法的行情数据源
- **硬件环境**: 用户拥有满足最低配置要求的硬件设备
- **网络环境**: 用户在数据更新时能正常访问网络
- **监管合规**: 用户遵守当地金融监管政策

### 5.2 依赖

- **Hikyuu框架**: 依赖Hikyuu提供的行情数据获取、回测引擎等功能
- **Qlib框架**: 依赖Qlib提供的机器学习建模、特征工程等功能
- **Python环境**: 依赖Python 3.8+及相关机器学习库
- **数据存储**: 依赖HDF5格式存储历史行情数据
- **配置管理**: 依赖YAML格式进行参数配置
