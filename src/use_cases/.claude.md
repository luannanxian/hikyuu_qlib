# Use Cases å±‚ - Claude AI å¼€å‘æŒ‡å—

## æ¨¡å—æ¦‚è¿°

Use Cases å±‚æ˜¯**åº”ç”¨ä¸šåŠ¡è§„åˆ™å±‚**,è´Ÿè´£ç¼–æ’é¢†åŸŸå¯¹è±¡æ¥å®Œæˆç‰¹å®šçš„ä¸šåŠ¡æµç¨‹,**åªä¾èµ– Domain å±‚**ã€‚

**æ¶æ„åŸåˆ™**:
- âœ… **åªä¾èµ– Domain** - é€šè¿‡ Ports ä¸å¤–éƒ¨äº¤äº’
- âœ… **ç¼–æ’ä¸šåŠ¡æµç¨‹** - åè°ƒå¤šä¸ªé¢†åŸŸå¯¹è±¡
- âœ… **æŠ€æœ¯æ— å…³** - ä¸åŒ…å«æ¡†æ¶ç»†èŠ‚
- âœ… **å•ä¸€èŒè´£** - æ¯ä¸ª Use Case å®Œæˆä¸€ä¸ªä¸šåŠ¡åœºæ™¯

**æ ¸å¿ƒèŒè´£**:
1. æ¥æ”¶è¯·æ±‚ (Request DTO)
2. è°ƒç”¨ Domain å±‚æ‰§è¡Œä¸šåŠ¡é€»è¾‘
3. é€šè¿‡ Ports ä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’
4. è¿”å›å“åº” (Response DTO)
5. å¤„ç†å¼‚å¸¸å’Œé”™è¯¯

**ä¾èµ–è§„åˆ™**:
```
Use Cases â†’ Domain (Entities, Value Objects, Ports)
Use Cases âœ— Adapters (ç¦æ­¢ç›´æ¥ä¾èµ–)
Use Cases âœ— Infrastructure (ç¦æ­¢ç›´æ¥ä¾èµ–)
```

## TDD å¼€å‘è¦æ±‚ ğŸ§ª

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **Data Use Cases**: >= 90%
- **Models Use Cases**: >= 90%
- **Strategies Use Cases**: >= 90%
- **Analysis Use Cases**: >= 85%
- **æ•´ä½“ Use Cases å±‚**: >= 90%

## å­æ¨¡å—è¯´æ˜

### 1. data/ - æ•°æ®ç›¸å…³ Use Cases

**ç¤ºä¾‹**: åŠ è½½è‚¡ç¥¨æ•°æ®

```python
# use_cases/data/load_stock_data.py
from dataclasses import dataclass
from typing import Optional
import pandas as pd
from domain.ports.stock_data_provider import IStockDataProvider
from domain.value_objects.stock_code import StockCode
from domain.value_objects.date_range import DateRange
from domain.entities.stock import Stock

@dataclass
class LoadStockDataRequest:
    """Use Case è¾“å…¥"""
    stock_code: str
    start_date: str  # 'YYYY-MM-DD'
    end_date: str

@dataclass
class LoadStockDataResponse:
    """Use Case è¾“å‡º"""
    data: Optional[pd.DataFrame]
    stock: Optional[Stock]
    success: bool
    error: Optional[str] = None

class LoadStockDataUseCase:
    """Use Case: åŠ è½½è‚¡ç¥¨æ•°æ®

    æµç¨‹:
    1. éªŒè¯è¾“å…¥
    2. è½¬æ¢ä¸ºé¢†åŸŸå¯¹è±¡
    3. è°ƒç”¨ Port åŠ è½½æ•°æ®
    4. è¿”å›ç»“æœ
    """

    def __init__(self, data_provider: IStockDataProvider):
        """ä¾èµ–æ³¨å…¥ Port"""
        self.data_provider = data_provider

    async def execute(
        self,
        request: LoadStockDataRequest
    ) -> LoadStockDataResponse:
        """æ‰§è¡Œ Use Case"""
        try:
            # 1. éªŒè¯å¹¶è½¬æ¢ä¸ºé¢†åŸŸå¯¹è±¡
            stock_code = StockCode(request.stock_code)
            date_range = DateRange(
                start=datetime.fromisoformat(request.start_date),
                end=datetime.fromisoformat(request.end_date)
            )

            # 2. è·å–è‚¡ç¥¨ä¿¡æ¯
            stock = await self.data_provider.get_stock_info(stock_code)
            if not stock:
                return LoadStockDataResponse(
                    data=None,
                    stock=None,
                    success=False,
                    error=f"Stock {stock_code.value} not found"
                )

            # 3. æ£€æŸ¥ä¸šåŠ¡è§„åˆ™
            if not stock.is_tradable():
                return LoadStockDataResponse(
                    data=None,
                    stock=stock,
                    success=False,
                    error=f"Stock {stock_code.value} is not tradable"
                )

            # 4. åŠ è½½æ•°æ®
            data = await self.data_provider.load_stock_data(
                stock_code,
                date_range
            )

            return LoadStockDataResponse(
                data=data,
                stock=stock,
                success=True
            )

        except ValueError as e:
            return LoadStockDataResponse(
                data=None,
                stock=None,
                success=False,
                error=str(e)
            )

# use_cases/data/convert_data_format.py
@dataclass
class ConvertDataFormatRequest:
    """è½¬æ¢æ•°æ®æ ¼å¼è¯·æ±‚"""
    source_format: str  # 'hikyuu', 'qlib'
    target_format: str
    data: pd.DataFrame

@dataclass
class ConvertDataFormatResponse:
    """è½¬æ¢æ•°æ®æ ¼å¼å“åº”"""
    converted_data: Optional[pd.DataFrame]
    success: bool
    error: Optional[str] = None

class ConvertDataFormatUseCase:
    """Use Case: è½¬æ¢æ•°æ®æ ¼å¼"""

    def __init__(
        self,
        source_adapter: IDataFormatAdapter,
        target_adapter: IDataFormatAdapter
    ):
        self.source_adapter = source_adapter
        self.target_adapter = target_adapter

    async def execute(
        self,
        request: ConvertDataFormatRequest
    ) -> ConvertDataFormatResponse:
        """æ‰§è¡Œè½¬æ¢"""
        try:
            # éªŒè¯æ•°æ®
            if request.data.empty:
                return ConvertDataFormatResponse(
                    converted_data=None,
                    success=False,
                    error="Empty data"
                )

            # è½¬æ¢
            converted = await self.target_adapter.convert_from(
                request.data,
                source_format=request.source_format
            )

            return ConvertDataFormatResponse(
                converted_data=converted,
                success=True
            )

        except Exception as e:
            return ConvertDataFormatResponse(
                converted_data=None,
                success=False,
                error=str(e)
            )
```

### 2. models/ - æ¨¡å‹ç›¸å…³ Use Cases

**ç¤ºä¾‹**: è®­ç»ƒæ¨¡å‹

```python
# use_cases/models/train_model.py
from dataclasses import dataclass
from typing import Dict, Any, Optional
from domain.ports.model_trainer import IModelTrainer
from domain.ports.data_provider import IDataProvider
from domain.ports.experiment_recorder import IExperimentRecorder
from domain.entities.model import Model

@dataclass
class TrainModelRequest:
    """è®­ç»ƒæ¨¡å‹è¯·æ±‚"""
    model_type: str  # 'LGBModel', 'XGBModel'
    dataset_config: Dict[str, Any]
    experiment_name: str
    parameters: Dict[str, Any]

@dataclass
class TrainModelResponse:
    """è®­ç»ƒæ¨¡å‹å“åº”"""
    model: Optional[Model]
    model_path: Optional[str]
    metrics: Dict[str, float]
    success: bool
    error: Optional[str] = None

class TrainModelUseCase:
    """Use Case: è®­ç»ƒæ¨¡å‹

    ç¼–æ’æµç¨‹:
    1. åŠ è½½æ•°æ®
    2. éªŒè¯æ•°æ®
    3. è®­ç»ƒæ¨¡å‹
    4. è®°å½•å®éªŒ
    5. è¿”å›ç»“æœ
    """

    def __init__(
        self,
        data_provider: IDataProvider,
        model_trainer: IModelTrainer,
        experiment_recorder: IExperimentRecorder
    ):
        """ä¾èµ–æ³¨å…¥æ‰€æœ‰éœ€è¦çš„ Ports"""
        self.data_provider = data_provider
        self.trainer = model_trainer
        self.recorder = experiment_recorder

    async def execute(
        self,
        request: TrainModelRequest
    ) -> TrainModelResponse:
        """æ‰§è¡Œè®­ç»ƒæµç¨‹"""
        try:
            # 1. åŠ è½½æ•°æ® (é€šè¿‡ Port)
            dataset = await self.data_provider.load_dataset(
                request.dataset_config
            )

            # 2. éªŒè¯æ•°æ® (Domain è§„åˆ™)
            if not self._is_valid_dataset(dataset):
                return TrainModelResponse(
                    model=None,
                    model_path=None,
                    metrics={},
                    success=False,
                    error="Invalid dataset"
                )

            # 3. è®­ç»ƒæ¨¡å‹ (é€šè¿‡ Port)
            model = await self.trainer.train(
                model_type=request.model_type,
                dataset=dataset,
                parameters=request.parameters
            )

            # 4. åº”ç”¨ Domain è§„åˆ™
            model.mark_as_trained()

            # 5. è®°å½•å®éªŒ (é€šè¿‡ Port)
            model_path = await self.recorder.record_experiment(
                experiment_name=request.experiment_name,
                model=model,
                parameters=request.parameters
            )

            return TrainModelResponse(
                model=model,
                model_path=model_path,
                metrics=model.metrics,
                success=True
            )

        except Exception as e:
            return TrainModelResponse(
                model=None,
                model_path=None,
                metrics={},
                success=False,
                error=str(e)
            )

    def _is_valid_dataset(self, dataset: Any) -> bool:
        """éªŒè¯æ•°æ®é›† (ä¸šåŠ¡è§„åˆ™)"""
        # æ£€æŸ¥æ•°æ®é›†æ˜¯å¦æ»¡è¶³è®­ç»ƒè¦æ±‚
        return dataset is not None and len(dataset) > 0
```

### 3. strategies/ - ç­–ç•¥ç›¸å…³ Use Cases

**ç¤ºä¾‹**: æ‰§è¡Œå›æµ‹

```python
# use_cases/strategies/run_backtest.py
from dataclasses import dataclass
from typing import Dict, Any, Optional
from domain.ports.backtest_engine import IBacktestEngine
from domain.ports.signal_provider import ISignalProvider
from domain.aggregates.portfolio import Portfolio
from domain.value_objects.price import Price
from decimal import Decimal

@dataclass
class RunBacktestRequest:
    """å›æµ‹è¯·æ±‚"""
    initial_cash: Decimal
    start_date: str
    end_date: str
    signals_config: Dict[str, Any]
    backtest_config: Dict[str, Any]

@dataclass
class RunBacktestResponse:
    """å›æµ‹å“åº”"""
    portfolio: Optional[Portfolio]
    results: Dict[str, Any]
    success: bool
    error: Optional[str] = None

class RunBacktestUseCase:
    """Use Case: æ‰§è¡Œå›æµ‹

    æµç¨‹:
    1. åˆ›å»ºæŠ•èµ„ç»„åˆ
    2. åŠ è½½ä¿¡å·
    3. æ‰§è¡Œå›æµ‹
    4. åˆ†æç»“æœ
    """

    def __init__(
        self,
        backtest_engine: IBacktestEngine,
        signal_provider: ISignalProvider
    ):
        self.engine = backtest_engine
        self.signals = signal_provider

    async def execute(
        self,
        request: RunBacktestRequest
    ) -> RunBacktestResponse:
        """æ‰§è¡Œå›æµ‹"""
        try:
            # 1. åˆ›å»ºæŠ•èµ„ç»„åˆ (Domain å¯¹è±¡)
            portfolio = Portfolio(
                id="backtest_portfolio",
                name="Backtest",
                initial_cash=Price(request.initial_cash)
            )

            # 2. åŠ è½½ä¿¡å·
            signals = await self.signals.load_signals(
                request.signals_config
            )

            # 3. æ‰§è¡Œå›æµ‹ (é€šè¿‡ Port)
            results = await self.engine.run_backtest(
                portfolio=portfolio,
                signals=signals,
                config=request.backtest_config
            )

            return RunBacktestResponse(
                portfolio=portfolio,
                results=results,
                success=True
            )

        except Exception as e:
            return RunBacktestResponse(
                portfolio=None,
                results={},
                success=False,
                error=str(e)
            )
```

### 4. analysis/ - åˆ†æç›¸å…³ Use Cases

**ç¤ºä¾‹**: ç”ŸæˆæŠ¥å‘Š

```python
# use_cases/analysis/generate_report.py
from dataclasses import dataclass
from typing import Dict, Any, Optional
from domain.ports.report_generator import IReportGenerator
from domain.aggregates.portfolio import Portfolio

@dataclass
class GenerateReportRequest:
    """ç”ŸæˆæŠ¥å‘Šè¯·æ±‚"""
    portfolio: Portfolio
    backtest_results: Dict[str, Any]
    report_format: str  # 'markdown', 'html', 'pdf'

@dataclass
class GenerateReportResponse:
    """ç”ŸæˆæŠ¥å‘Šå“åº”"""
    report_content: Optional[str]
    report_path: Optional[str]
    success: bool
    error: Optional[str] = None

class GenerateReportUseCase:
    """Use Case: ç”ŸæˆæŠ¥å‘Š"""

    def __init__(self, report_generator: IReportGenerator):
        self.generator = report_generator

    async def execute(
        self,
        request: GenerateReportRequest
    ) -> GenerateReportResponse:
        """ç”ŸæˆæŠ¥å‘Š"""
        try:
            # éªŒè¯
            if not request.backtest_results:
                return GenerateReportResponse(
                    report_content=None,
                    report_path=None,
                    success=False,
                    error="No results to report"
                )

            # ç”ŸæˆæŠ¥å‘Š
            content, path = await self.generator.generate(
                portfolio=request.portfolio,
                results=request.backtest_results,
                format=request.report_format
            )

            return GenerateReportResponse(
                report_content=content,
                report_path=path,
                success=True
            )

        except Exception as e:
            return GenerateReportResponse(
                report_content=None,
                report_path=None,
                success=False,
                error=str(e)
            )
```

## TDD ç¤ºä¾‹

```python
# tests/unit/use_cases/data/test_load_stock_data.py
import pytest
from unittest.mock import Mock, AsyncMock
from datetime import datetime
from use_cases.data.load_stock_data import (
    LoadStockDataUseCase,
    LoadStockDataRequest,
    LoadStockDataResponse
)
from domain.entities.stock import Stock
from domain.value_objects.stock_code import StockCode
from domain.value_objects.market import Market

class TestLoadStockDataUseCase:
    """LoadStockDataUseCase TDD æµ‹è¯•å¥—ä»¶"""

    @pytest.fixture
    def mock_data_provider(self):
        """Mock Port"""
        return Mock(spec=IStockDataProvider)

    @pytest.fixture
    def use_case(self, mock_data_provider):
        """åˆ›å»º Use Case"""
        return LoadStockDataUseCase(mock_data_provider)

    @pytest.mark.asyncio
    async def test_load_stock_data_success(
        self,
        use_case,
        mock_data_provider
    ):
        """ğŸ”´ æµ‹è¯•: æˆåŠŸåŠ è½½è‚¡ç¥¨æ•°æ®"""
        # å‡†å¤‡ Mock æ•°æ®
        mock_stock = Stock(
            code=StockCode("sh000001"),
            name="å¹³å®‰é“¶è¡Œ",
            market=Market("SH", "ä¸Šæµ·"),
            listed_date=datetime(2010, 1, 1),
            is_active=True
        )

        mock_data = pd.DataFrame({
            'datetime': [datetime(2023, 1, 1)],
            'open': [10.0],
            'close': [11.0]
        })

        # é…ç½® Mock
        mock_data_provider.get_stock_info = AsyncMock(
            return_value=mock_stock
        )
        mock_data_provider.load_stock_data = AsyncMock(
            return_value=mock_data
        )

        # æ‰§è¡Œ Use Case
        request = LoadStockDataRequest(
            stock_code="sh000001",
            start_date="2023-01-01",
            end_date="2023-12-31"
        )

        response = await use_case.execute(request)

        # éªŒè¯
        assert response.success is True
        assert response.stock == mock_stock
        assert not response.data.empty

        # éªŒè¯è°ƒç”¨
        mock_data_provider.get_stock_info.assert_called_once()
        mock_data_provider.load_stock_data.assert_called_once()

    @pytest.mark.asyncio
    async def test_load_stock_data_stock_not_found(
        self,
        use_case,
        mock_data_provider
    ):
        """ğŸ”´ æµ‹è¯•: è‚¡ç¥¨ä¸å­˜åœ¨"""
        # é…ç½® Mock è¿”å› None
        mock_data_provider.get_stock_info = AsyncMock(
            return_value=None
        )

        request = LoadStockDataRequest(
            stock_code="sh999999",
            start_date="2023-01-01",
            end_date="2023-12-31"
        )

        response = await use_case.execute(request)

        # éªŒè¯
        assert response.success is False
        assert "not found" in response.error
        assert response.data is None

    @pytest.mark.asyncio
    async def test_load_stock_data_invalid_code(
        self,
        use_case,
        mock_data_provider
    ):
        """ğŸ”´ æµ‹è¯•: æ— æ•ˆè‚¡ç¥¨ä»£ç """
        request = LoadStockDataRequest(
            stock_code="invalid",  # æ— æ•ˆæ ¼å¼
            start_date="2023-01-01",
            end_date="2023-12-31"
        )

        response = await use_case.execute(request)

        # éªŒè¯
        assert response.success is False
        assert "Invalid" in response.error
```

## å¼€å‘æ—¶é—´è¡¨

| å­æ¨¡å— | é¢„ä¼° | TDD æµç¨‹ |
|--------|------|----------|
| Data Use Cases | 3å¤© | æµ‹è¯•(1å¤©) + å®ç°(1.5å¤©) + é‡æ„(0.5å¤©) |
| Models Use Cases | 4å¤© | æµ‹è¯•(1.5å¤©) + å®ç°(2å¤©) + é‡æ„(0.5å¤©) |
| Strategies Use Cases | 4å¤© | æµ‹è¯•(1.5å¤©) + å®ç°(2å¤©) + é‡æ„(0.5å¤©) |
| Analysis Use Cases | 3å¤© | æµ‹è¯•(1å¤©) + å®ç°(1.5å¤©) + é‡æ„(0.5å¤©) |
| **æ€»è®¡** | **14å¤©** | **çº¦ 2.5 å‘¨** |

---

**æ¨¡å—è´Ÿè´£äºº**: Use Cases Team
**ä¼˜å…ˆçº§**: P0 (æœ€é«˜)
**é¢„ä¼°å·¥æœŸ**: 2.5 å‘¨
**ä¾èµ–**: Domain å±‚
**å½“å‰çŠ¶æ€**: å¾…å¼€å§‹

**é‡è¦æç¤º**:
- âš ï¸ Use Cases åªä¾èµ– Domain å±‚
- âš ï¸ é€šè¿‡ Ports ä¸å¤–éƒ¨äº¤äº’
- âš ï¸ ä¸åŒ…å«æŠ€æœ¯å®ç°ç»†èŠ‚
- âš ï¸ æ¯ä¸ª Use Case å•ä¸€èŒè´£
- âš ï¸ æµ‹è¯•ä½¿ç”¨ Mock Ports
