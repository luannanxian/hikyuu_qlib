# Adapters å±‚ - Claude AI å¼€å‘æŒ‡å—

## æ¨¡å—æ¦‚è¿°

Adapters å±‚å®ç° Domain å±‚å®šä¹‰çš„ **Ports æ¥å£**,è¿æ¥å¤–éƒ¨æ¡†æ¶å’ŒæŠ€æœ¯å®ç°,æ˜¯ **Hexagonal Architecture çš„å…³é”®**ã€‚

**æ¶æ„åŸåˆ™**:
- âœ… **å®ç° Domain Ports** - éµå®ˆæ¥å£å¥‘çº¦
- âœ… **å°è£…å¤–éƒ¨æ¡†æ¶** - Hikyuuã€Qlibã€æ•°æ®åº“ç­‰
- âœ… **å¯æ›¿æ¢æ€§** - è½»æ¾åˆ‡æ¢å®ç°
- âœ… **å•ä¸€èŒè´£** - æ¯ä¸ª Adapter ä¸“æ³¨ä¸€ä¸ªæŠ€æœ¯

**æ ¸å¿ƒèŒè´£**:
1. å®ç° Domain å®šä¹‰çš„ Ports æ¥å£
2. å°è£… Hikyuu æ¡†æ¶è°ƒç”¨
3. å°è£… Qlib æ¡†æ¶è°ƒç”¨
4. å®ç°æ•°æ®æŒä¹…åŒ–
5. å®ç° CLI å’Œ API æ§åˆ¶å™¨

**ä¾èµ–è§„åˆ™**:
```
Adapters â†’ Use Cases â†’ Domain
Adapters â†’ External Frameworks (Hikyuu, Qlib)
```

## TDD å¼€å‘è¦æ±‚ ğŸ§ª

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **Hikyuu Adapters**: >= 85%
- **Qlib Adapters**: >= 85%
- **Repositories**: >= 90%
- **Controllers**: >= 80%
- **æ•´ä½“ Adapters å±‚**: >= 85%

## å­æ¨¡å—è¯´æ˜

### 1. hikyuu/ - Hikyuu é€‚é…å™¨

**èŒè´£**: å®ç°åŸºäº Hikyuu çš„ Ports

```python
# adapters/hikyuu/hikyuu_data_adapter.py
from typing import List, Optional
import pandas as pd
import hikyuu as hku
from domain.ports.stock_data_provider import IStockDataProvider
from domain.entities.stock import Stock
from domain.value_objects.stock_code import StockCode
from domain.value_objects.date_range import DateRange
from domain.value_objects.market import Market
from datetime import datetime

class HikyuuDataAdapter(IStockDataProvider):
    """Adapter: Hikyuu æ•°æ®æä¾›è€…å®ç°

    å®ç° Domain Port: IStockDataProvider
    å°è£… Hikyuu æ¡†æ¶è°ƒç”¨
    """

    def __init__(self, config_file: str):
        """åˆå§‹åŒ– Hikyuu

        Args:
            config_file: Hikyuu é…ç½®æ–‡ä»¶è·¯å¾„
        """
        self.config_file = config_file
        self._initialized = False

    def _ensure_initialized(self):
        """ç¡®ä¿ Hikyuu å·²åˆå§‹åŒ–"""
        if not self._initialized:
            hku.init(self.config_file)
            self._initialized = True

    async def load_stock_data(
        self,
        code: StockCode,
        date_range: DateRange
    ) -> pd.DataFrame:
        """å®ç° Port: åŠ è½½è‚¡ç¥¨æ•°æ®

        å°† Hikyuu KData è½¬æ¢ä¸º DataFrame
        """
        self._ensure_initialized()

        # è½¬æ¢ Domain å¯¹è±¡ä¸º Hikyuu å¯¹è±¡
        stock = hku.Stock(code.value)

        query = hku.Query(
            start=hku.Datetime(date_range.start),
            end=hku.Datetime(date_range.end),
            ktype=hku.Query.DAY
        )

        # è°ƒç”¨ Hikyuu API
        kdata = stock.getKData(query)

        # è½¬æ¢ä¸º DataFrame
        return self._kdata_to_dataframe(kdata)

    def _kdata_to_dataframe(self, kdata: hku.KData) -> pd.DataFrame:
        """å°† KData è½¬æ¢ä¸º DataFrame"""
        data = {
            'datetime': [k.datetime.datetime() for k in kdata],
            'open': [k.open for k in kdata],
            'high': [k.high for k in kdata],
            'low': [k.low for k in kdata],
            'close': [k.close for k in kdata],
            'volume': [k.volume for k in kdata],
            'amount': [k.amount for k in kdata]
        }

        return pd.DataFrame(data)

    async def get_stock_info(
        self,
        code: StockCode
    ) -> Optional[Stock]:
        """å®ç° Port: è·å–è‚¡ç¥¨ä¿¡æ¯"""
        self._ensure_initialized()

        hku_stock = hku.Stock(code.value)

        if hku_stock.isNull():
            return None

        # è½¬æ¢ä¸º Domain Entity
        return Stock(
            code=code,
            name=hku_stock.name,
            market=Market(
                code=hku_stock.market.code(),
                name=hku_stock.market.name()
            ),
            listed_date=datetime.fromtimestamp(
                hku_stock.startDatetime.timestamp()
            ),
            is_active=hku_stock.valid
        )

    async def get_all_stocks(self) -> List[Stock]:
        """å®ç° Port: è·å–æ‰€æœ‰è‚¡ç¥¨"""
        self._ensure_initialized()

        sm = hku.StockManager.instance()
        hku_stocks = sm.getStockTypeInfo(hku.constant.STOCKTYPE_A)

        stocks = []
        for hku_stock in hku_stocks:
            try:
                stock_code = StockCode(hku_stock.code)
                stock_info = await self.get_stock_info(stock_code)
                if stock_info:
                    stocks.append(stock_info)
            except ValueError:
                # è·³è¿‡æ— æ•ˆä»£ç 
                continue

        return stocks

# adapters/hikyuu/hikyuu_backtest_adapter.py
from domain.ports.backtest_engine import IBacktestEngine
from domain.aggregates.portfolio import Portfolio
from typing import Dict, Any
import hikyuu as hku

class HikyuuBacktestAdapter(IBacktestEngine):
    """Adapter: Hikyuu å›æµ‹å¼•æ“å®ç°"""

    async def run_backtest(
        self,
        portfolio: Portfolio,
        signals: Any,
        config: Dict[str, Any]
    ) -> Dict[str, Any]:
        """å®ç° Port: æ‰§è¡Œå›æµ‹

        å°† Domain Portfolio è½¬æ¢ä¸º Hikyuu Portfolio
        """
        # åˆ›å»º Hikyuu Portfolio
        hku_pf = hku.Portfolio(
            name=portfolio.name,
            cash=float(portfolio.cash.value)
        )

        # é…ç½®å›æµ‹å‚æ•°
        # ... Hikyuu å›æµ‹é€»è¾‘

        # æ‰§è¡Œå›æµ‹
        # ...

        # è½¬æ¢ç»“æœä¸º Domain æ ¼å¼
        results = {
            'total_return': 0.25,
            'sharpe_ratio': 1.5,
            'max_drawdown': -0.15
        }

        return results
```

### 2. qlib/ - Qlib é€‚é…å™¨

```python
# adapters/qlib/qlib_model_adapter.py
from domain.ports.model_trainer import IModelTrainer
from domain.entities.model import Model
from typing import Dict, Any
import qlib
from qlib.contrib.model.gbdt import LGBModel
from qlib.contrib.model.xgboost import XGBModel

class QlibModelAdapter(IModelTrainer):
    """Adapter: Qlib æ¨¡å‹è®­ç»ƒå™¨å®ç°"""

    def __init__(self, provider_uri: str, region: str = "REG_CN"):
        self.provider_uri = provider_uri
        self.region = region
        self._initialized = False

    def _ensure_initialized(self):
        """ç¡®ä¿ Qlib å·²åˆå§‹åŒ–"""
        if not self._initialized:
            qlib.init(
                provider_uri=self.provider_uri,
                region=self.region
            )
            self._initialized = True

    async def train(
        self,
        model_type: str,
        dataset: Any,
        parameters: Dict[str, Any]
    ) -> Model:
        """å®ç° Port: è®­ç»ƒæ¨¡å‹"""
        self._ensure_initialized()

        # æ ¹æ®ç±»å‹åˆ›å»ºæ¨¡å‹
        if model_type == "LGBModel":
            qlib_model = LGBModel(**parameters)
        elif model_type == "XGBModel":
            qlib_model = XGBModel(**parameters)
        else:
            raise ValueError(f"Unknown model type: {model_type}")

        # è®­ç»ƒ
        qlib_model.fit(dataset)

        # è®¡ç®—æŒ‡æ ‡
        metrics = self._calculate_metrics(qlib_model, dataset)

        # è½¬æ¢ä¸º Domain Entity
        model = Model(
            id=str(uuid.uuid4()),
            name=model_type,
            model_type=model_type,
            version="1.0.0",
            metrics=metrics
        )

        return model

    async def predict(
        self,
        model: Model,
        data: Any
    ) -> Any:
        """å®ç° Port: ç”Ÿæˆé¢„æµ‹"""
        # åŠ è½½æ¨¡å‹å¹¶é¢„æµ‹
        pass

    def _calculate_metrics(
        self,
        qlib_model,
        dataset
    ) -> Dict[str, float]:
        """è®¡ç®—æ¨¡å‹æŒ‡æ ‡"""
        # è®¡ç®— IC, Rank IC ç­‰
        return {
            'ic': 0.05,
            'rank_ic': 0.06
        }
```

### 3. repositories/ - æ•°æ®æŒä¹…åŒ–

```python
# adapters/repositories/postgres_model_repository.py
from domain.ports.model_repository import IModelRepository
from domain.entities.model import Model
from typing import Optional, List
import asyncpg

class PostgresModelRepository(IModelRepository):
    """Adapter: PostgreSQL æ¨¡å‹ä»“å‚¨"""

    def __init__(self, pool: asyncpg.Pool):
        self.pool = pool

    async def save(self, model: Model) -> Model:
        """ä¿å­˜æ¨¡å‹"""
        async with self.pool.acquire() as conn:
            await conn.execute(
                """
                INSERT INTO models (id, name, model_type, version, metrics)
                VALUES ($1, $2, $3, $4, $5)
                ON CONFLICT (id) DO UPDATE
                SET name = $2, metrics = $5
                """,
                model.id,
                model.name,
                model.model_type,
                model.version,
                json.dumps(model.metrics)
            )

        return model

    async def find_by_id(self, model_id: str) -> Optional[Model]:
        """æŸ¥æ‰¾æ¨¡å‹"""
        async with self.pool.acquire() as conn:
            row = await conn.fetchrow(
                "SELECT * FROM models WHERE id = $1",
                model_id
            )

            if not row:
                return None

            return self._to_entity(row)

    async def find_all(self) -> List[Model]:
        """æŸ¥æ‰¾æ‰€æœ‰æ¨¡å‹"""
        async with self.pool.acquire() as conn:
            rows = await conn.fetch("SELECT * FROM models")

        return [self._to_entity(row) for row in rows]

    def _to_entity(self, row) -> Model:
        """è½¬æ¢ä¸º Entity"""
        return Model(
            id=row['id'],
            name=row['name'],
            model_type=row['model_type'],
            version=row['version'],
            metrics=json.loads(row['metrics'])
        )
```

### 4. controllers/ - æ§åˆ¶å™¨

#### CLI æ§åˆ¶å™¨

```python
# adapters/controllers/cli/data_cli.py
import click
import asyncio
from use_cases.data.load_stock_data import (
    LoadStockDataUseCase,
    LoadStockDataRequest
)
from infrastructure.di.container import get_container

@click.group()
def data_cli():
    """æ•°æ®å¤„ç† CLI"""
    pass

@data_cli.command()
@click.option('--code', required=True, help='è‚¡ç¥¨ä»£ç ')
@click.option('--start', required=True, help='å¼€å§‹æ—¥æœŸ')
@click.option('--end', required=True, help='ç»“æŸæ—¥æœŸ')
def load(code: str, start: str, end: str):
    """åŠ è½½è‚¡ç¥¨æ•°æ®

    Controller èŒè´£:
    1. è§£æå‘½ä»¤è¡Œå‚æ•°
    2. åˆ›å»º Use Case Request
    3. è°ƒç”¨ Use Case
    4. å±•ç¤ºç»“æœ
    """
    # è·å– Use Case (é€šè¿‡ DI)
    container = get_container()
    use_case: LoadStockDataUseCase = container.load_stock_data_use_case()

    # åˆ›å»º Request
    request = LoadStockDataRequest(
        stock_code=code,
        start_date=start,
        end_date=end
    )

    # æ‰§è¡Œ Use Case
    response = asyncio.run(use_case.execute(request))

    # å±•ç¤ºç»“æœ (åªå…³å¿ƒå±•ç¤º,ä¸å…³å¿ƒä¸šåŠ¡é€»è¾‘)
    if response.success:
        click.echo(click.style(f'âœ… æ•°æ®åŠ è½½æˆåŠŸ', fg='green'))
        click.echo(f'è‚¡ç¥¨: {response.stock.name}')
        click.echo(f'æ•°æ®è¡Œæ•°: {len(response.data)}')
    else:
        click.echo(click.style(f'âŒ å¤±è´¥: {response.error}', fg='red'))
```

#### API æ§åˆ¶å™¨ (å¯é€‰)

```python
# adapters/controllers/api/data_api.py
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from use_cases.data.load_stock_data import (
    LoadStockDataUseCase,
    LoadStockDataRequest
)

router = APIRouter(prefix="/api/data", tags=["data"])

class LoadDataDTO(BaseModel):
    """API DTO"""
    stock_code: str
    start_date: str
    end_date: str

@router.post("/load")
async def load_stock_data(
    dto: LoadDataDTO,
    use_case: LoadStockDataUseCase = Depends(get_use_case)
):
    """API Endpoint: åŠ è½½è‚¡ç¥¨æ•°æ®

    Controller èŒè´£:
    1. éªŒè¯ HTTP è¯·æ±‚
    2. è½¬æ¢ä¸º Use Case Request
    3. è°ƒç”¨ Use Case
    4. è¿”å› HTTP å“åº”
    """
    request = LoadStockDataRequest(
        stock_code=dto.stock_code,
        start_date=dto.start_date,
        end_date=dto.end_date
    )

    response = await use_case.execute(request)

    if not response.success:
        raise HTTPException(
            status_code=400,
            detail=response.error
        )

    return {
        "stock": {
            "code": response.stock.code.value,
            "name": response.stock.name
        },
        "rows": len(response.data)
    }
```

## TDD ç¤ºä¾‹

```python
# tests/unit/adapters/hikyuu/test_hikyuu_data_adapter.py
import pytest
from unittest.mock import Mock, patch
from adapters.hikyuu.hikyuu_data_adapter import HikyuuDataAdapter
from domain.value_objects.stock_code import StockCode
from domain.value_objects.date_range import DateRange

class TestHikyuuDataAdapter:
    """HikyuuDataAdapter TDD æµ‹è¯•å¥—ä»¶"""

    @pytest.fixture
    def adapter(self):
        return HikyuuDataAdapter("config.ini")

    @patch('hikyuu.init')
    @patch('hikyuu.Stock')
    @pytest.mark.asyncio
    async def test_load_stock_data_success(
        self,
        mock_stock_class,
        mock_init,
        adapter
    ):
        """ğŸ”´ æµ‹è¯•: æˆåŠŸåŠ è½½æ•°æ®"""
        # Mock Hikyuu API
        mock_kdata = [
            Mock(
                datetime=Mock(datetime=lambda: datetime(2023, 1, 1)),
                open=10.0,
                high=11.0,
                low=9.0,
                close=10.5,
                volume=1000,
                amount=10000
            )
        ]

        mock_stock = Mock()
        mock_stock.getKData.return_value = mock_kdata
        mock_stock_class.return_value = mock_stock

        # æ‰§è¡Œ
        code = StockCode("sh000001")
        date_range = DateRange(
            datetime(2023, 1, 1),
            datetime(2023, 12, 31)
        )

        df = await adapter.load_stock_data(code, date_range)

        # éªŒè¯
        assert not df.empty
        assert 'open' in df.columns
        assert 'close' in df.columns

        # éªŒè¯ Hikyuu è¢«æ­£ç¡®è°ƒç”¨
        mock_init.assert_called_once()
        mock_stock.getKData.assert_called_once()
```

## å¼€å‘æ—¶é—´è¡¨

| å­æ¨¡å— | é¢„ä¼° | TDD æµç¨‹ |
|--------|------|----------|
| Hikyuu Adapters | 5å¤© | æµ‹è¯•(2å¤©) + å®ç°(2.5å¤©) + é‡æ„(0.5å¤©) |
| Qlib Adapters | 5å¤© | æµ‹è¯•(2å¤©) + å®ç°(2.5å¤©) + é‡æ„(0.5å¤©) |
| Repositories | 3å¤© | æµ‹è¯•(1å¤©) + å®ç°(1.5å¤©) + é‡æ„(0.5å¤©) |
| CLI Controllers | 3å¤© | æµ‹è¯•(1å¤©) + å®ç°(1.5å¤©) + é‡æ„(0.5å¤©) |
| API Controllers | 2å¤© | æµ‹è¯•(0.5å¤©) + å®ç°(1å¤©) + é‡æ„(0.5å¤©) |
| **æ€»è®¡** | **18å¤©** | **çº¦ 3.5 å‘¨** |

---

**æ¨¡å—è´Ÿè´£äºº**: Adapters Team
**ä¼˜å…ˆçº§**: P0 (æœ€é«˜)
**é¢„ä¼°å·¥æœŸ**: 3.5 å‘¨
**ä¾èµ–**: Domain å±‚, Use Cases å±‚
**å½“å‰çŠ¶æ€**: å¾…å¼€å§‹

**é‡è¦æç¤º**:
- âš ï¸ Adapters å¿…é¡»å®ç° Domain Ports
- âš ï¸ å°è£…æ‰€æœ‰å¤–éƒ¨æ¡†æ¶ç»†èŠ‚
- âš ï¸ æµ‹è¯•æ—¶ Mock å¤–éƒ¨æ¡†æ¶
- âš ï¸ å¯æ›¿æ¢æ€§æ˜¯å…³é”®è®¾è®¡ç›®æ ‡
