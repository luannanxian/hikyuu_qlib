# Hikyuu Data Adapter - 数据转换集成方案

## 模块概述

**位置**: `src/adapters/hikyuu/`
**职责**: 实现 `IStockDataProvider` 接口,将 Hikyuu HDF5/KData 数据转换为 Qlib MultiIndex DataFrame 格式
**优先级**: P1 - 中等复杂度
**状态**: ✅ 技术方案研究完成

---

## 核心集成挑战

### 1. Hikyuu KData → Qlib DataFrame 转换

**问题描述**:
- **Hikyuu 数据格式**: `KData` 对象 (C++ 封装) + HDF5 存储
- **Qlib 数据格式**: `MultiIndex(datetime, instrument)` pandas DataFrame + .bin 文件

**数据结构差异**:

```python
# Hikyuu KData 结构
kdata = stock.get_kdata(Query(-100))
# KData{
#   size: 100,
#   stock: Stock(SH, 600000, 浦发银行, A股, ...),
#   [0] datetime open high low close amount volume
#   [1] ...
# }

# Qlib DataFrame 结构
qlib_df = pd.DataFrame(
    {
        '$open': [...],
        '$high': [...],
        '$low': [...],
        '$close': [...],
        '$volume': [...],
        '$amount': [...]
    },
    index=pd.MultiIndex.from_product(
        [pd.date_range(...), ['SH600000', 'SZ000001']],
        names=['datetime', 'instrument']
    )
)
```

### 2. 时间戳格式转换

**Hikyuu Datetime 格式**:
```python
from hikyuu import Datetime
dt = Datetime(201809210930)  # YYYYMMDDHHmm 整数格式
```

**Qlib pandas Timestamp 格式**:
```python
import pandas as pd
ts = pd.Timestamp('2018-09-21 09:30:00')
```

**转换逻辑**:
```python
def hikyuu_datetime_to_pandas(hq_dt: Datetime) -> pd.Timestamp:
    """Hikyuu Datetime → pandas Timestamp"""
    dt_number = hq_dt.number  # 201809210930
    dt_str = str(dt_number).zfill(12)  # 补齐12位

    year = int(dt_str[0:4])
    month = int(dt_str[4:6])
    day = int(dt_str[6:8])
    hour = int(dt_str[8:10])
    minute = int(dt_str[10:12])

    return pd.Timestamp(
        year=year,
        month=month,
        day=day,
        hour=hour,
        minute=minute
    )
```

### 3. 股票代码标准化

**Hikyuu 格式**: `sh600000` (小写 + 市场 + 代码)
**Qlib 格式**: `SH600000` (大写 + 市场 + 代码)

**标准化函数**:
```python
def normalize_stock_code(hikyuu_code: str) -> str:
    """
    Hikyuu → Qlib 股票代码转换

    sh600000 → SH600000
    sz000001 → SZ000001
    """
    return hikyuu_code.upper()
```

### 4. 数据字段映射

| Hikyuu KRecord | Qlib Column | 说明 |
|---|---|---|
| `datetime` | `datetime` (index) | 时间戳 |
| `open` | `$open` | 开盘价 |
| `high` | `$high` | 最高价 |
| `low` | `$low` | 最低价 |
| `close` | `$close` | 收盘价 |
| `amount` | `$amount` | 成交额 |
| `volume` | `$volume` | 成交量 |

**注意**: Qlib 列名需要加 `$` 前缀!

---

## 技术方案

### HikyuuDataAdapter 类设计

```python
# src/adapters/hikyuu/data_adapter.py

import hikyuu as hku
import pandas as pd
from typing import List, Dict
from domain.ports.stock_data_provider import IStockDataProvider
from domain.value_objects.stock_code import StockCode
from domain.value_objects.date_range import DateRange
from domain.entities.kline_data import KLineData

class HikyuuDataAdapter(IStockDataProvider):
    """
    Hikyuu 数据适配器

    核心功能:
    1. 从 Hikyuu 加载 KData
    2. 转换为 Domain KLineData 实体
    3. 转换为 Qlib MultiIndex DataFrame
    """

    def __init__(self, hikyuu_config_path: str):
        """
        初始化 Hikyuu 数据适配器

        Args:
            hikyuu_config_path: Hikyuu 配置文件路径 (~/.hikyuu/config.ini)
        """
        self.config_path = hikyuu_config_path
        self._initialized = False

    def _ensure_initialized(self):
        """确保 Hikyuu 已初始化"""
        if not self._initialized:
            hku.load_hikyuu(self.config_path)
            self._initialized = True

    async def load_stock_data(
        self,
        code: StockCode,
        date_range: DateRange,
        kline_type: str = "DAY"
    ) -> List[KLineData]:
        """
        【Domain Port 实现】加载股票数据

        Args:
            code: 股票代码 (Domain 值对象)
            date_range: 日期范围 (Domain 值对象)
            kline_type: K 线类型 (DAY/MIN5/WEEK)

        Returns:
            KLineData 实体列表 (Domain 层)
        """
        self._ensure_initialized()

        # 1. Domain → Hikyuu 转换
        hikyuu_stock_code = code.value.lower()  # sh600000
        stock = hku.sm[hikyuu_stock_code]

        # 2. 构建 Hikyuu Query
        query = hku.Query(
            start=hku.Datetime(self._date_to_hikyuu_number(date_range.start_date)),
            end=hku.Datetime(self._date_to_hikyuu_number(date_range.end_date)),
            ktype=self._get_hikyuu_ktype(kline_type)
        )

        # 3. 调用 Hikyuu API
        kdata = stock.get_kdata(query)

        # 4. Hikyuu KData → Domain KLineData
        return self._to_domain_kline_data(kdata, code)

    def _to_domain_kline_data(
        self,
        kdata: hku.KData,
        code: StockCode
    ) -> List[KLineData]:
        """
        将 Hikyuu KData 转换为 Domain KLineData 实体

        Args:
            kdata: Hikyuu KData 对象
            code: 股票代码

        Returns:
            KLineData 实体列表
        """
        kline_list = []

        for i in range(len(kdata)):
            record = kdata[i]

            kline_list.append(
                KLineData(
                    stock_code=code,
                    timestamp=self._hikyuu_datetime_to_python(record.datetime),
                    open=Decimal(str(record.open)),
                    high=Decimal(str(record.high)),
                    low=Decimal(str(record.low)),
                    close=Decimal(str(record.close)),
                    volume=int(record.volume),
                    amount=Decimal(str(record.amount))
                )
            )

        return kline_list

    def to_qlib_dataframe(
        self,
        kline_data_list: List[KLineData]
    ) -> pd.DataFrame:
        """
        将 Domain KLineData 转换为 Qlib MultiIndex DataFrame

        Args:
            kline_data_list: KLineData 实体列表

        Returns:
            Qlib 格式的 MultiIndex DataFrame
        """
        records = []

        for kline in kline_data_list:
            records.append({
                'datetime': kline.timestamp,
                'instrument': self._normalize_stock_code(kline.stock_code.value),
                '$open': float(kline.open),
                '$high': float(kline.high),
                '$low': float(kline.low),
                '$close': float(kline.close),
                '$volume': kline.volume,
                '$amount': float(kline.amount)
            })

        df = pd.DataFrame(records)

        # 设置 MultiIndex
        df = df.set_index(['datetime', 'instrument'])

        return df

    def kdata_to_qlib_dataframe(
        self,
        kdata: hku.KData,
        stock_code: str
    ) -> pd.DataFrame:
        """
        【快捷方法】直接将 Hikyuu KData 转换为 Qlib DataFrame

        Args:
            kdata: Hikyuu KData 对象
            stock_code: 股票代码 (如 'sh600000')

        Returns:
            Qlib MultiIndex DataFrame
        """
        records = []
        normalized_code = self._normalize_stock_code(stock_code)

        for i in range(len(kdata)):
            record = kdata[i]
            records.append({
                'datetime': self._hikyuu_datetime_to_pandas(record.datetime),
                'instrument': normalized_code,
                '$open': record.open,
                '$high': record.high,
                '$low': record.low,
                '$close': record.close,
                '$volume': record.volume,
                '$amount': record.amount
            })

        df = pd.DataFrame(records)
        df = df.set_index(['datetime', 'instrument'])

        return df

    # ========== 辅助方法 ==========

    def _hikyuu_datetime_to_pandas(self, hq_dt: hku.Datetime) -> pd.Timestamp:
        """Hikyuu Datetime → pandas Timestamp"""
        dt_number = hq_dt.number
        dt_str = str(dt_number).zfill(12)

        return pd.Timestamp(
            year=int(dt_str[0:4]),
            month=int(dt_str[4:6]),
            day=int(dt_str[6:8]),
            hour=int(dt_str[8:10]),
            minute=int(dt_str[10:12])
        )

    def _hikyuu_datetime_to_python(self, hq_dt: hku.Datetime) -> datetime:
        """Hikyuu Datetime → Python datetime"""
        pd_ts = self._hikyuu_datetime_to_pandas(hq_dt)
        return pd_ts.to_pydatetime()

    def _date_to_hikyuu_number(self, date: date) -> int:
        """Python date → Hikyuu Datetime 整数"""
        return date.year * 100000000 + date.month * 1000000 + date.day * 10000

    def _normalize_stock_code(self, code: str) -> str:
        """Hikyuu → Qlib 股票代码标准化"""
        return code.upper()

    def _get_hikyuu_ktype(self, kline_type: str) -> hku.Query.KType:
        """K 线类型字符串 → Hikyuu KType 枚举"""
        mapping = {
            'DAY': hku.Query.DAY,
            'WEEK': hku.Query.WEEK,
            'MONTH': hku.Query.MONTH,
            'MIN': hku.Query.MIN,
            'MIN5': hku.Query.MIN5,
            'MIN15': hku.Query.MIN15,
            'MIN30': hku.Query.MIN30,
            'MIN60': hku.Query.MIN60
        }
        return mapping.get(kline_type, hku.Query.DAY)
```

---

## 使用示例

### 示例 1: Domain 层使用

```python
# examples/data_conversion/test_hikyuu_data_adapter.py

from adapters.hikyuu.data_adapter import HikyuuDataAdapter
from domain.value_objects.stock_code import StockCode
from domain.value_objects.date_range import DateRange
from datetime import date

# 1. 创建适配器
adapter = HikyuuDataAdapter(hikyuu_config_path="~/.hikyuu/config.ini")

# 2. 加载数据 (Domain 接口)
code = StockCode("sh600000")
date_range = DateRange(
    start_date=date(2020, 1, 1),
    end_date=date(2020, 12, 31)
)

kline_data_list = await adapter.load_stock_data(
    code=code,
    date_range=date_range,
    kline_type="DAY"
)

print(f"加载了 {len(kline_data_list)} 条 K 线数据")

# 3. 转换为 Qlib DataFrame
qlib_df = adapter.to_qlib_dataframe(kline_data_list)

print(qlib_df.head())
#                          $open   $high    $low  $close   $volume      $amount
# datetime   instrument
# 2020-01-02 SH600000     11.55   11.62   11.49   11.57  25678000  296847000.0
# 2020-01-03 SH600000     11.58   11.65   11.52   11.60  21234000  245123000.0
```

### 示例 2: 直接转换 (Adapter 层)

```python
# examples/data_conversion/direct_conversion.py

import hikyuu as hku
from adapters.hikyuu.data_adapter import HikyuuDataAdapter

# 1. 初始化 Hikyuu
hku.load_hikyuu()

# 2. 获取 KData
stock = hku.sm['sh600000']
query = hku.Query(-100)  # 最近 100 个交易日
kdata = stock.get_kdata(query)

# 3. 创建适配器
adapter = HikyuuDataAdapter(hikyuu_config_path="~/.hikyuu/config.ini")

# 4. 直接转换
qlib_df = adapter.kdata_to_qlib_dataframe(kdata, 'sh600000')

print(qlib_df.tail())

# 5. 保存为 Qlib .bin 格式 (可选)
from qlib.data import D
D.save(qlib_df, 'output/hikyuu_data.bin')
```

---

## 批量转换全市场数据

```python
# examples/data_conversion/batch_convert_market.py

import hikyuu as hku
import pandas as pd
from pathlib import Path
from tqdm import tqdm
from adapters.hikyuu.data_adapter import HikyuuDataAdapter

def batch_convert_market_data(
    market: str = 'SH',
    start_date: str = '2020-01-01',
    end_date: str = '2024-12-31',
    output_dir: str = 'output/qlib_data'
):
    """
    批量转换全市场 Hikyuu 数据为 Qlib 格式

    Args:
        market: 市场代码 (SH/SZ)
        start_date: 开始日期
        end_date: 结束日期
        output_dir: 输出目录
    """
    # 1. 初始化
    hku.load_hikyuu()
    adapter = HikyuuDataAdapter(hikyuu_config_path="~/.hikyuu/config.ini")

    # 2. 获取股票列表
    stock_list = [
        s for s in hku.sm
        if s.market == market and s.valid and s.type == hku.constant.STOCKTYPE_A
    ]

    print(f"找到 {len(stock_list)} 只 {market} 股票")

    # 3. 批量转换
    all_dataframes = []

    for stock in tqdm(stock_list, desc="转换进度"):
        try:
            # 获取 KData
            query = hku.Query(
                start=hku.Datetime.from_string(start_date),
                end=hku.Datetime.from_string(end_date)
            )
            kdata = stock.get_kdata(query)

            if len(kdata) == 0:
                continue

            # 转换为 Qlib DataFrame
            df = adapter.kdata_to_qlib_dataframe(kdata, stock.market_code)
            all_dataframes.append(df)

        except Exception as e:
            print(f"转换 {stock.market_code} 失败: {e}")
            continue

    # 4. 合并所有 DataFrame
    merged_df = pd.concat(all_dataframes, axis=0)
    merged_df = merged_df.sort_index()

    # 5. 保存
    output_path = Path(output_dir)
    output_path.mkdir(parents=True, exist_ok=True)

    merged_df.to_pickle(output_path / f"{market}_data.pkl")
    print(f"保存完成: {output_path / f'{market}_data.pkl'}")
    print(f"总计 {len(merged_df)} 条记录")

if __name__ == "__main__":
    batch_convert_market_data()
```

---

## 数据完整性验证

```python
# src/adapters/hikyuu/data_validator.py

class HikyuuDataValidator:
    """Hikyuu → Qlib 数据转换验证器"""

    @staticmethod
    def validate_conversion(
        hikyuu_kdata: hku.KData,
        qlib_df: pd.DataFrame
    ) -> Dict[str, Any]:
        """
        验证转换后的数据完整性

        Args:
            hikyuu_kdata: Hikyuu 原始数据
            qlib_df: Qlib 转换后数据

        Returns:
            验证结果字典
        """
        results = {
            'total_records': len(hikyuu_kdata),
            'converted_records': len(qlib_df),
            'missing_records': 0,
            'data_integrity': True,
            'errors': []
        }

        # 1. 记录数验证
        if len(hikyuu_kdata) != len(qlib_df):
            results['missing_records'] = len(hikyuu_kdata) - len(qlib_df)
            results['data_integrity'] = False
            results['errors'].append(
                f"记录数不匹配: Hikyuu={len(hikyuu_kdata)}, Qlib={len(qlib_df)}"
            )

        # 2. 数值验证 (抽样检查)
        sample_indices = range(0, min(len(hikyuu_kdata), 10))

        for i in sample_indices:
            hikyuu_record = hikyuu_kdata[i]

            # 从 qlib_df 获取对应记录
            qlib_record = qlib_df.iloc[i]

            # 验证关键字段
            if abs(hikyuu_record.close - qlib_record['$close']) > 1e-6:
                results['data_integrity'] = False
                results['errors'].append(
                    f"收盘价不匹配: index={i}, "
                    f"Hikyuu={hikyuu_record.close}, Qlib={qlib_record['$close']}"
                )

        return results
```

---

## 性能优化

### 1. 批量加载优化

```python
def batch_load_stocks(
    self,
    stock_codes: List[str],
    date_range: DateRange
) -> pd.DataFrame:
    """批量加载多只股票数据"""
    dataframes = []

    for code in stock_codes:
        kdata = self._load_single_stock(code, date_range)
        df = self.kdata_to_qlib_dataframe(kdata, code)
        dataframes.append(df)

    return pd.concat(dataframes, axis=0)
```

### 2. 缓存机制

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def _load_single_stock_cached(
    self,
    code: str,
    start_date: str,
    end_date: str
) -> pd.DataFrame:
    """带缓存的单只股票加载"""
    # ...实现
```

---

## 测试策略

### 单元测试

```python
# tests/unit/adapters/hikyuu/test_data_adapter.py

import pytest
from adapters.hikyuu.data_adapter import HikyuuDataAdapter

def test_hikyuu_datetime_to_pandas():
    """测试时间戳转换"""
    import hikyuu as hku

    adapter = HikyuuDataAdapter("~/.hikyuu/config.ini")

    hq_dt = hku.Datetime(201809210930)
    pd_dt = adapter._hikyuu_datetime_to_pandas(hq_dt)

    assert pd_dt.year == 2018
    assert pd_dt.month == 9
    assert pd_dt.day == 21
    assert pd_dt.hour == 9
    assert pd_dt.minute == 30

def test_normalize_stock_code():
    """测试股票代码标准化"""
    adapter = HikyuuDataAdapter("~/.hikyuu/config.ini")

    assert adapter._normalize_stock_code("sh600000") == "SH600000"
    assert adapter._normalize_stock_code("sz000001") == "SZ000001"

def test_kdata_to_qlib_dataframe():
    """测试 KData → DataFrame 转换"""
    # Mock hikyuu.KData
    # 验证 DataFrame 结构
    pass
```

---

## 参考文档

- Hikyuu Stock Manager API: https://github.com/fasiondog/hikyuu
- Hikyuu KData 文档: `docs/source/stock_manager.rst`
- Qlib 数据格式: https://github.com/microsoft/qlib
- Domain 端口定义: [`src/domain/ports/stock_data_provider.py`](../../domain/ports/stock_data_provider.py)

---

**最后更新**: 2025-11-11
**状态**: ✅ 技术方案完成,待实现
