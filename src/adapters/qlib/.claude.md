# Qlib Feature Adapter - Hikyuu 指标转换为 Qlib 特征

## 模块概述

**位置**: `src/adapters/qlib/`
**职责**: 实现 `IFeatureConverter` 接口,将 Hikyuu 技术指标转换为 Qlib 特征表达式
**优先级**: P2 - 中等复杂度
**状态**: ✅ 技术方案已完成

---

## 核心集成挑战

### 1. Hikyuu 指标 vs Qlib 特征表达式

**问题描述**:
- **Hikyuu**: 使用 Python API 计算指标,例如 `MA(CLOSE(), 5)`, `MACD()`
- **Qlib**: 使用字符串表达式定义特征,例如 `"Mean($close, 5)"`, `"EMA($close, 12)"`
- 需要将 Hikyuu 指标计算逻辑转换为 Qlib 表达式

**示例对比**:

| Hikyuu 指标 | Qlib 表达式 | 说明 |
|------------|-------------|------|
| `MA(CLOSE(), 5)` | `Mean($close, 5)` | 5日均线 |
| `STD(CLOSE(), 20)` | `Std($close, 20)` | 20日标准差 |
| `REF(CLOSE(), 1)` | `Ref($close, 1)` | 昨日收盘价 |
| `CLOSE() / REF(CLOSE(), 1) - 1` | `$close / Ref($close, 1) - 1` | 日收益率 |
| `MAX(HIGH(), 20)` | `Max($high, 20)` | 20日最高价 |

### 2. Qlib 表达式引擎算子

**核心算子列表**:

#### 基础算子
- `$open`, `$close`, `$high`, `$low`, `$volume`, `$vwap`: 基础数据
- `Ref(feature, N)`: 引用 N 天前的值
- `Mean(feature, N)`: N 天滑动平均
- `Std(feature, N)`: N 天标准差
- `Sum(feature, N)`: N 天求和
- `Max(feature, N)`: N 天最大值
- `Min(feature, N)`: N 天最小值

#### 高级算子
- `Rank(feature)`: 截面排序
- `Corr(feature1, feature2, N)`: N 天相关性
- `Delta(feature, N)`: N 天变化量 (`feature - Ref(feature, N)`)
- `Greater(feature1, feature2)`: 比较算子
- `IfThenElse(condition, true_value, false_value)`: 条件算子
- `Rolling(feature, N, func)`: 滚动窗口函数

#### 数学运算
- `+`, `-`, `*`, `/`: 四则运算
- `Abs(feature)`: 绝对值
- `Log(feature)`: 对数
- `Sign(feature)`: 符号函数

### 3. Alpha158 特征集

Qlib 提供的 Alpha158 是一个包含 158 个特征的标准特征集,基于以下技术指标:

**价格动量特征** (60个):
```python
# 收益率序列
["Ref($close, N) / $close - 1" for N in range(1, 61)]  # 过去60天收益率

# 成交量比率
["Ref($volume, N) / $volume" for N in range(1, 61)]
```

**技术指标特征** (40个):
```python
# 移动平均
["Mean($close, N)" for N in [5, 10, 20, 30, 60]]
["Mean($volume, N)" for N in [5, 10, 20, 30, 60]]

# 标准差
["Std($close, N)" for N in [5, 10, 20, 30, 60]]
["Std($volume, N)" for N in [5, 10, 20, 30, 60]]

# MACD 类指标
"EMA($close, 12) - EMA($close, 26)"  # MACD DIF
"EMA(EMA($close, 12) - EMA($close, 26), 9)"  # MACD DEA

# RSI
"RSI($close, 14)"

# 布林带
"($close - Mean($close, 20)) / Std($close, 20)"  # BOLL位置
```

---

## 架构设计

### HikyuuFeatureConverter 类

```python
# src/adapters/qlib/hikyuu_feature_converter.py

from typing import List, Dict, Any
from hikyuu import Indicator
from domain.ports.feature_converter import IFeatureConverter


class HikyuuFeatureConverter(IFeatureConverter):
    """
    Hikyuu 指标 → Qlib 特征表达式转换器

    核心功能:
    1. 将 Hikyuu 指标定义转换为 Qlib 表达式字符串
    2. 支持常用技术指标的自动转换
    3. 支持自定义转换规则
    """

    def __init__(self):
        # 内置转换规则
        self._builtin_rules = self._init_builtin_rules()

    def _init_builtin_rules(self) -> Dict[str, str]:
        """
        初始化内置转换规则

        Returns:
            规则字典: {Hikyuu指标名称: Qlib表达式模板}
        """
        return {
            # 移动平均类
            "MA": "Mean($close, {period})",
            "EMA": "EMA($close, {period})",
            "SMA": "Mean($close, {period})",

            # 波动率类
            "STD": "Std($close, {period})",
            "ATR": "Mean(Max(Max($high - $low, Abs($high - Ref($close, 1))), Abs($low - Ref($close, 1))), {period})",

            # 动量类
            "ROC": "($close - Ref($close, {period})) / Ref($close, {period})",
            "MOM": "$close - Ref($close, {period})",

            # 价格位置类
            "STOCHRSI": "RSI($close, {period})",

            # 趋势类
            "ADX": None,  # 需要自定义实现
            "CCI": "($close - Mean($close, {period})) / (0.015 * Std($close, {period}))",

            # 成交量类
            "OBV": "Sum(IfThenElse($close > Ref($close, 1), $volume, -$volume), {period})",
            "VROC": "($volume - Ref($volume, {period})) / Ref($volume, {period})",
        }

    def convert_indicator(
        self,
        indicator_name: str,
        params: Dict[str, Any]
    ) -> str:
        """
        转换单个指标

        Args:
            indicator_name: Hikyuu 指标名称,如 "MA", "STD"
            params: 参数字典,如 {"period": 5}

        Returns:
            Qlib 表达式字符串

        Example:
            >>> converter = HikyuuFeatureConverter()
            >>> converter.convert_indicator("MA", {"period": 5})
            'Mean($close, 5)'
        """
        if indicator_name not in self._builtin_rules:
            raise ValueError(f"不支持的指标: {indicator_name}")

        template = self._builtin_rules[indicator_name]

        if template is None:
            raise NotImplementedError(f"指标 {indicator_name} 需要自定义实现")

        # 替换模板参数
        return template.format(**params)

    def convert_indicator_list(
        self,
        indicators: List[tuple[str, Dict[str, Any]]]
    ) -> List[str]:
        """
        批量转换指标列表

        Args:
            indicators: [(指标名称, 参数字典), ...]

        Returns:
            Qlib 表达式列表

        Example:
            >>> indicators = [
            ...     ("MA", {"period": 5}),
            ...     ("STD", {"period": 20}),
            ... ]
            >>> converter.convert_indicator_list(indicators)
            ['Mean($close, 5)', 'Std($close, 20)']
        """
        return [
            self.convert_indicator(name, params)
            for name, params in indicators
        ]

    def create_alpha158_features(self) -> Dict[str, str]:
        """
        创建完整的 Alpha158 特征集

        Returns:
            {特征名称: Qlib表达式} 字典
        """
        features = {}

        # 1. KBAR (价格K线特征)
        for field in ['open', 'high', 'low', 'close', 'volume']:
            for i in range(5):
                features[f"KBAR_{field.upper()}_{i}"] = f"Ref(${field}, {i})"

        # 2. KDJ (随机指标)
        # 简化版,完整实现需要更复杂的逻辑
        features["KDJ_K"] = "(($close - Min($low, 9)) / (Max($high, 9) - Min($low, 9))) * 100"

        # 3. RSI (相对强弱指标)
        for period in [6, 12, 24]:
            features[f"RSI_{period}"] = f"RSI($close, {period})"

        # 4. BIAS (乖离率)
        for period in [5, 10, 20, 30, 60]:
            features[f"BIAS_{period}"] = f"($close - Mean($close, {period})) / Mean($close, {period})"

        # 5. BOLL (布林带)
        for period in [10, 20, 30, 60]:
            features[f"BOLL_UPPER_{period}"] = f"Mean($close, {period}) + 2 * Std($close, {period})"
            features[f"BOLL_LOWER_{period}"] = f"Mean($close, {period}) - 2 * Std($close, {period})"

        # 6. ROC (变动率)
        for period in [5, 10, 20, 30, 60]:
            features[f"ROC_{period}"] = f"($close - Ref($close, {period})) / Ref($close, {period})"

        # 7. MA (移动平均)
        for period in [5, 10, 20, 30, 60]:
            features[f"MA_{period}"] = f"Mean($close, {period})"

        # 8. STD (标准差)
        for period in [5, 10, 20, 30, 60]:
            features[f"STD_{period}"] = f"Std($close, {period})"

        # 9. BETA (贝塔系数) - 需要市场指数数据
        # features["BETA"] = "Corr($close, $benchmark, 60) * Std($close, 60) / Std($benchmark, 60)"

        # 10. 成交量特征
        for period in [5, 10, 20, 30, 60]:
            features[f"VOLUME_MA_{period}"] = f"Mean($volume, {period})"
            features[f"VOLUME_STD_{period}"] = f"Std($volume, {period})"

        return features

    def convert_custom_expression(
        self,
        hikyuu_expr: str
    ) -> str:
        """
        转换自定义表达式

        Args:
            hikyuu_expr: Hikyuu 风格表达式

        Returns:
            Qlib 表达式

        Example:
            >>> converter.convert_custom_expression("CLOSE() / REF(CLOSE(), 1) - 1")
            '$close / Ref($close, 1) - 1'
        """
        # 基础替换规则
        replacements = {
            "CLOSE()": "$close",
            "OPEN()": "$open",
            "HIGH()": "$high",
            "LOW()": "$low",
            "VOL()": "$volume",
            "VOLUME()": "$volume",
            "REF(": "Ref(",
            "MA(": "Mean(",
            "STD(": "Std(",
            "MAX(": "Max(",
            "MIN(": "Min(",
            "SUM(": "Sum(",
        }

        qlib_expr = hikyuu_expr
        for hikyuu_pattern, qlib_pattern in replacements.items():
            qlib_expr = qlib_expr.replace(hikyuu_pattern, qlib_pattern)

        return qlib_expr
```

---

## 使用示例

### 示例 1: 转换单个指标

```python
# examples/qlib/convert_single_indicator.py

from adapters.qlib.hikyuu_feature_converter import HikyuuFeatureConverter


def main():
    converter = HikyuuFeatureConverter()

    # 转换5日均线
    ma5 = converter.convert_indicator("MA", {"period": 5})
    print(f"MA(5): {ma5}")
    # 输出: Mean($close, 5)

    # 转换20日标准差
    std20 = converter.convert_indicator("STD", {"period": 20})
    print(f"STD(20): {std20}")
    # 输出: Std($close, 20)

    # 转换10日收益率
    roc10 = converter.convert_indicator("ROC", {"period": 10})
    print(f"ROC(10): {roc10}")
    # 输出: ($close - Ref($close, 10)) / Ref($close, 10)


if __name__ == "__main__":
    main()
```

### 示例 2: 批量转换指标

```python
# examples/qlib/convert_indicator_list.py

from adapters.qlib.hikyuu_feature_converter import HikyuuFeatureConverter


def main():
    converter = HikyuuFeatureConverter()

    # 定义指标列表
    indicators = [
        ("MA", {"period": 5}),
        ("MA", {"period": 10}),
        ("MA", {"period": 20}),
        ("STD", {"period": 20}),
        ("ROC", {"period": 5}),
        ("OBV", {"period": 10}),
    ]

    # 批量转换
    qlib_features = converter.convert_indicator_list(indicators)

    for (name, params), qlib_expr in zip(indicators, qlib_features):
        print(f"{name}{params} -> {qlib_expr}")


if __name__ == "__main__":
    main()
```

### 示例 3: 生成 Alpha158 特征集

```python
# examples/qlib/generate_alpha158.py

from adapters.qlib.hikyuu_feature_converter import HikyuuFeatureConverter
import json


def main():
    converter = HikyuuFeatureConverter()

    # 生成 Alpha158 特征
    alpha158 = converter.create_alpha158_features()

    # 保存为 JSON
    with open("alpha158_features.json", "w") as f:
        json.dump(alpha158, f, indent=2)

    print(f"生成 {len(alpha158)} 个特征")

    # 打印前10个特征
    for i, (name, expr) in enumerate(list(alpha158.items())[:10]):
        print(f"{i+1}. {name}: {expr}")


if __name__ == "__main__":
    main()
```

### 示例 4: 集成到 Qlib DataHandler

```python
# examples/qlib/use_converted_features.py

from qlib.data.dataset import DatasetH
from qlib.data.dataset.handler import DataHandlerLP
from adapters.qlib.hikyuu_feature_converter import HikyuuFeatureConverter


def create_dataset_with_hikyuu_features():
    """使用转换后的 Hikyuu 特征创建 Qlib 数据集"""
    converter = HikyuuFeatureConverter()

    # 转换特征
    features = converter.create_alpha158_features()

    # 创建 Qlib DataHandler
    handler_config = {
        "start_time": "2018-01-01",
        "end_time": "2023-12-31",
        "fit_start_time": "2018-01-01",
        "fit_end_time": "2020-12-31",
        "instruments": "csi300",
        "infer_processors": [],
        "learn_processors": [],
        "label": ["Ref($close, -2)/Ref($close, -1) - 1"],
    }

    # 使用转换后的特征
    fields = list(features.values())

    # 创建数据集
    dataset = DatasetH(
        handler={
            "class": "DataHandlerLP",
            "module_path": "qlib.data.dataset.handler",
            "kwargs": {
                **handler_config,
                "fields": fields,
            }
        },
        segments={
            "train": ("2018-01-01", "2020-12-31"),
            "valid": ("2021-01-01", "2021-12-31"),
            "test": ("2022-01-01", "2023-12-31"),
        }
    )

    return dataset
```

---

## 复杂指标转换

### MACD 指标

```python
def convert_macd(self, fast: int = 12, slow: int = 26, signal: int = 9) -> Dict[str, str]:
    """
    转换 MACD 指标

    Returns:
        {"DIF": ..., "DEA": ..., "MACD": ...}
    """
    dif = f"EMA($close, {fast}) - EMA($close, {slow})"
    dea = f"EMA({dif}, {signal})"
    macd = f"({dif} - {dea}) * 2"

    return {
        "MACD_DIF": dif,
        "MACD_DEA": dea,
        "MACD": macd,
    }
```

### KDJ 指标

```python
def convert_kdj(self, period: int = 9, m1: int = 3, m2: int = 3) -> Dict[str, str]:
    """
    转换 KDJ 指标

    KDJ 计算逻辑:
    1. RSV = (收盘价 - N日最低价) / (N日最高价 - N日最低价) * 100
    2. K = RSV 的 M1 日移动平均
    3. D = K 的 M2 日移动平均
    4. J = 3K - 2D
    """
    rsv = f"(($close - Min($low, {period})) / (Max($high, {period}) - Min($low, {period}))) * 100"

    # 注意: Qlib 的 EMA 与传统 SMA 不同
    # 这里简化为移动平均
    k = f"Mean({rsv}, {m1})"
    d = f"Mean({k}, {m2})"
    j = f"3 * {k} - 2 * {d}"

    return {
        "KDJ_K": k,
        "KDJ_D": d,
        "KDJ_J": j,
    }
```

### 布林带指标

```python
def convert_boll(
    self,
    period: int = 20,
    num_std: float = 2.0
) -> Dict[str, str]:
    """
    转换布林带指标

    Returns:
        {"UPPER": ..., "MIDDLE": ..., "LOWER": ...}
    """
    middle = f"Mean($close, {period})"
    std = f"Std($close, {period})"

    upper = f"{middle} + {num_std} * {std}"
    lower = f"{middle} - {num_std} * {std}"

    return {
        "BOLL_UPPER": upper,
        "BOLL_MIDDLE": middle,
        "BOLL_LOWER": lower,
    }
```

---

## Domain 层定义

### IFeatureConverter 端口

```python
# src/domain/ports/feature_converter.py

from abc import ABC, abstractmethod
from typing import List, Dict, Any


class IFeatureConverter(ABC):
    """特征转换器端口"""

    @abstractmethod
    def convert_indicator(
        self,
        indicator_name: str,
        params: Dict[str, Any]
    ) -> str:
        """转换单个指标为 Qlib 表达式"""
        pass

    @abstractmethod
    def convert_indicator_list(
        self,
        indicators: List[tuple[str, Dict[str, Any]]]
    ) -> List[str]:
        """批量转换指标"""
        pass

    @abstractmethod
    def create_alpha158_features(self) -> Dict[str, str]:
        """创建 Alpha158 特征集"""
        pass
```

---

## 测试策略

### 单元测试

```python
# tests/unit/adapters/qlib/test_hikyuu_feature_converter.py

import pytest
from adapters.qlib.hikyuu_feature_converter import HikyuuFeatureConverter


def test_convert_ma():
    """测试移动平均转换"""
    converter = HikyuuFeatureConverter()
    result = converter.convert_indicator("MA", {"period": 5})
    assert result == "Mean($close, 5)"


def test_convert_std():
    """测试标准差转换"""
    converter = HikyuuFeatureConverter()
    result = converter.convert_indicator("STD", {"period": 20})
    assert result == "Std($close, 20)"


def test_convert_roc():
    """测试收益率转换"""
    converter = HikyuuFeatureConverter()
    result = converter.convert_indicator("ROC", {"period": 10})
    assert result == "($close - Ref($close, 10)) / Ref($close, 10)"


def test_convert_indicator_list():
    """测试批量转换"""
    converter = HikyuuFeatureConverter()
    indicators = [
        ("MA", {"period": 5}),
        ("STD", {"period": 20}),
    ]
    results = converter.convert_indicator_list(indicators)
    assert len(results) == 2
    assert results[0] == "Mean($close, 5)"
    assert results[1] == "Std($close, 20)"


def test_create_alpha158():
    """测试 Alpha158 生成"""
    converter = HikyuuFeatureConverter()
    features = converter.create_alpha158_features()
    assert len(features) > 100  # Alpha158 应该有超过100个特征
    assert "MA_5" in features
    assert "STD_20" in features


def test_unsupported_indicator():
    """测试不支持的指标"""
    converter = HikyuuFeatureConverter()
    with pytest.raises(ValueError, match="不支持的指标"):
        converter.convert_indicator("UNKNOWN_IND", {})


def test_convert_custom_expression():
    """测试自定义表达式转换"""
    converter = HikyuuFeatureConverter()
    hikyuu_expr = "CLOSE() / REF(CLOSE(), 1) - 1"
    qlib_expr = converter.convert_custom_expression(hikyuu_expr)
    assert qlib_expr == "$close / Ref($close, 1) - 1"
```

### 集成测试

```python
# tests/integration/test_qlib_feature_integration.py

import pytest
import qlib
from qlib.data import D
from adapters.qlib.hikyuu_feature_converter import HikyuuFeatureConverter


@pytest.mark.asyncio
async def test_qlib_can_parse_converted_features():
    """测试 Qlib 是否能解析转换后的特征"""
    # 初始化 Qlib
    qlib.init(provider_uri="~/.qlib/qlib_data/cn_data")

    converter = HikyuuFeatureConverter()

    # 转换特征
    ma5 = converter.convert_indicator("MA", {"period": 5})

    # 使用 Qlib 加载数据
    try:
        data = D.features(
            instruments=["SH600000"],
            fields=[ma5],
            start_time="2020-01-01",
            end_time="2020-12-31"
        )
        assert data is not None
        assert len(data) > 0
    except Exception as e:
        pytest.fail(f"Qlib 无法解析特征: {e}")
```

---

## 性能优化

### 1. 表达式缓存

```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def convert_indicator_cached(
    self,
    indicator_name: str,
    params_tuple: tuple
) -> str:
    """缓存转换结果"""
    params = dict(params_tuple)
    return self.convert_indicator(indicator_name, params)
```

### 2. 批量生成优化

```python
def create_alpha158_features_optimized(self) -> Dict[str, str]:
    """优化版 Alpha158 生成"""
    features = {}

    # 使用列表推导式批量生成
    periods = [5, 10, 20, 30, 60]
    fields = ['open', 'high', 'low', 'close', 'volume']

    # 批量生成 MA 特征
    features.update({
        f"MA_{period}": f"Mean($close, {period})"
        for period in periods
    })

    # 批量生成 STD 特征
    features.update({
        f"STD_{period}": f"Std($close, {period})"
        for period in periods
    })

    return features
```

---

## 后续优化方向

1. **自动化指标发现**: 从 Hikyuu 代码自动识别使用的指标
2. **表达式验证**: 验证生成的 Qlib 表达式语法正确性
3. **性能对比**: 对比 Hikyuu 计算结果与 Qlib 计算结果的一致性
4. **自定义算子**: 支持用户定义新的转换规则
5. **可视化工具**: 提供指标转换的可视化界面

---

## 参考文档

- Qlib 表达式引擎: https://qlib.readthedocs.io/en/latest/component/data.html
- Alpha158 定义: https://github.com/microsoft/qlib/blob/main/qlib/contrib/data/handler.py
- Hikyuu 指标 API: https://hikyuu.org/indicator.html
- Domain 端口定义: [`src/domain/ports/feature_converter.py`](../../domain/ports/feature_converter.py)

---

**最后更新**: 2025-11-11
**状态**: ✅ 技术方案已完成,待实现
