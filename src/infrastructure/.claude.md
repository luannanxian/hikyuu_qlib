# Infrastructure å±‚ - Claude AI å¼€å‘æŒ‡å—

## æ¨¡å—æ¦‚è¿°

Infrastructure å±‚æä¾›**æŠ€æœ¯åŸºç¡€è®¾æ–½æ”¯æŒ**,åŒ…æ‹¬é…ç½®ç®¡ç†ã€æ—¥å¿—ã€æ•°æ®åº“è¿æ¥ã€ä¾èµ–æ³¨å…¥ç­‰ã€‚

**æ¶æ„åŸåˆ™**:
- âœ… **æä¾›æŠ€æœ¯æ”¯æŒ** - é…ç½®ã€æ—¥å¿—ã€æ•°æ®åº“ç­‰
- âœ… **è·¨å±‚æœåŠ¡** - è¢«æ‰€æœ‰å±‚ä½¿ç”¨
- âœ… **æ¡†æ¶å°è£…** - ç»Ÿä¸€æŠ€æœ¯æ¥å£
- âœ… **ç¯å¢ƒç®¡ç†** - å¼€å‘ã€æµ‹è¯•ã€ç”Ÿäº§ç¯å¢ƒ

**æ ¸å¿ƒèŒè´£**:
1. é…ç½®ç®¡ç† (åŠ è½½ã€éªŒè¯ã€çƒ­æ›´æ–°)
2. æ—¥å¿—ç®¡ç† (ç»“æ„åŒ–æ—¥å¿—ã€æ—¥å¿—è½®è½¬)
3. æ•°æ®åº“è¿æ¥æ± ç®¡ç†
4. ä¾èµ–æ³¨å…¥å®¹å™¨
5. ç¯å¢ƒå˜é‡ç®¡ç†

## TDD å¼€å‘è¦æ±‚ ğŸ§ª

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡

- **Config**: >= 90%
- **Logging**: >= 85%
- **Database**: >= 90%
- **DI Container**: >= 85%
- **æ•´ä½“ Infrastructure å±‚**: >= 88%

## å­æ¨¡å—è¯´æ˜

### 1. config/ - é…ç½®ç®¡ç†

```python
# infrastructure/config/settings.py
from pydantic import BaseSettings, Field
from typing import Optional
from pathlib import Path

class HikyuuSettings(BaseSettings):
    """Hikyuu é…ç½®"""
    config_file: str = Field(..., env='HIKYUU_CONFIG')
    data_dir: Path = Field(..., env='HIKYUU_DATA_DIR')

    class Config:
        env_file = '.env'
        env_file_encoding = 'utf-8'

class QlibSettings(BaseSettings):
    """Qlib é…ç½®"""
    provider_uri: Path = Field(..., env='QLIB_PROVIDER_URI')
    region: str = Field(default='REG_CN', env='QLIB_REGION')

class DatabaseSettings(BaseSettings):
    """æ•°æ®åº“é…ç½®"""
    host: str = Field(..., env='DB_HOST')
    port: int = Field(5432, env='DB_PORT')
    user: str = Field(..., env='DB_USER')
    password: str = Field(..., env='DB_PASSWORD')
    database: str = Field(..., env='DB_NAME')

    @property
    def url(self) -> str:
        """ç”Ÿæˆæ•°æ®åº“ URL"""
        return (
            f"postgresql://{self.user}:{self.password}"
            f"@{self.host}:{self.port}/{self.database}"
        )

class Settings(BaseSettings):
    """åº”ç”¨é…ç½®"""
    app_name: str = "Hikyuu Ã— Qlib"
    debug: bool = Field(False, env='DEBUG')
    log_level: str = Field('INFO', env='LOG_LEVEL')

    # å­é…ç½®
    hikyuu: HikyuuSettings
    qlib: QlibSettings
    database: DatabaseSettings

    class Config:
        env_file = '.env'
        env_nested_delimiter = '__'

# å…¨å±€é…ç½®å®ä¾‹
_settings: Optional[Settings] = None

def get_settings() -> Settings:
    """è·å–é…ç½®å•ä¾‹"""
    global _settings
    if _settings is None:
        _settings = Settings()
    return _settings

# infrastructure/config/config_loader.py
import yaml
from pathlib import Path
from typing import Dict, Any

class ConfigLoader:
    """é…ç½®åŠ è½½å™¨

    æ”¯æŒå¤šç§æ ¼å¼:
    - YAML
    - JSON
    - ENV
    """

    @staticmethod
    def load_yaml(file_path: Path) -> Dict[str, Any]:
        """åŠ è½½ YAML é…ç½®"""
        with open(file_path, 'r', encoding='utf-8') as f:
            return yaml.safe_load(f)

    @staticmethod
    def load_env(env_file: Path = Path('.env')):
        """åŠ è½½ç¯å¢ƒå˜é‡"""
        if not env_file.exists():
            return

        with open(env_file) as f:
            for line in f:
                line = line.strip()
                if line and not line.startswith('#'):
                    key, value = line.split('=', 1)
                    os.environ[key.strip()] = value.strip()

    @staticmethod
    def validate_config(config: Dict[str, Any]) -> bool:
        """éªŒè¯é…ç½®"""
        required_keys = [
            'hikyuu.config_file',
            'qlib.provider_uri',
            'database.host'
        ]

        for key in required_keys:
            if not ConfigLoader._get_nested(config, key):
                raise ValueError(f"Missing required config: {key}")

        return True

    @staticmethod
    def _get_nested(d: Dict, key: str):
        """è·å–åµŒå¥—é”®"""
        keys = key.split('.')
        value = d
        for k in keys:
            if k not in value:
                return None
            value = value[k]
        return value
```

### 2. logging/ - æ—¥å¿—ç®¡ç†

```python
# infrastructure/logging/logger.py
from loguru import logger
import sys
from pathlib import Path
from typing import Optional

class LoggerSetup:
    """æ—¥å¿—é…ç½®

    ç‰¹æ€§:
    - ç»“æ„åŒ–æ—¥å¿—
    - æ—¥å¿—è½®è½¬
    - ä¸åŒçº§åˆ«æ—¥å¿—åˆ†æ–‡ä»¶
    - å½©è‰²æ§åˆ¶å°è¾“å‡º
    """

    @staticmethod
    def setup(
        log_dir: Optional[Path] = None,
        level: str = "INFO",
        rotation: str = "500 MB",
        retention: str = "10 days"
    ):
        """é…ç½®æ—¥å¿—"""
        # ç§»é™¤é»˜è®¤ handler
        logger.remove()

        # æ§åˆ¶å°è¾“å‡º (å½©è‰²)
        logger.add(
            sys.stderr,
            level=level,
            format=(
                "<green>{time:YYYY-MM-DD HH:mm:ss}</green> | "
                "<level>{level: <8}</level> | "
                "<cyan>{name}</cyan>:<cyan>{function}</cyan>:<cyan>{line}</cyan> - "
                "<level>{message}</level>"
            ),
            colorize=True
        )

        if log_dir:
            log_dir = Path(log_dir)
            log_dir.mkdir(parents=True, exist_ok=True)

            # INFO åŠä»¥ä¸Šæ—¥å¿—
            logger.add(
                log_dir / "app.log",
                level="INFO",
                rotation=rotation,
                retention=retention,
                encoding="utf-8",
                format=(
                    "{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | "
                    "{name}:{function}:{line} - {message}"
                )
            )

            # ERROR æ—¥å¿—å•ç‹¬æ–‡ä»¶
            logger.add(
                log_dir / "error.log",
                level="ERROR",
                rotation=rotation,
                retention=retention,
                encoding="utf-8",
                format=(
                    "{time:YYYY-MM-DD HH:mm:ss} | {level: <8} | "
                    "{name}:{function}:{line} - {message}\n"
                    "{exception}"
                )
            )

        return logger

# ä½¿ç”¨ç¤ºä¾‹
from infrastructure.logging.logger import LoggerSetup
from infrastructure.config.settings import get_settings

settings = get_settings()
logger = LoggerSetup.setup(
    log_dir=Path("logs"),
    level=settings.log_level
)

# åœ¨ä»£ç ä¸­ä½¿ç”¨
logger.info("Application started")
logger.debug(f"Config: {settings.dict()}")
logger.error("An error occurred", exc_info=True)
```

### 3. database/ - æ•°æ®åº“ç®¡ç†

```python
# infrastructure/database/connection.py
import asyncpg
from typing import Optional
from infrastructure.config.settings import get_settings

class DatabaseManager:
    """æ•°æ®åº“è¿æ¥ç®¡ç†å™¨

    ç‰¹æ€§:
    - è¿æ¥æ± 
    - è‡ªåŠ¨é‡è¿
    - å¥åº·æ£€æŸ¥
    """

    def __init__(self):
        self.pool: Optional[asyncpg.Pool] = None

    async def connect(self):
        """åˆ›å»ºè¿æ¥æ± """
        if self.pool is not None:
            return

        settings = get_settings()

        self.pool = await asyncpg.create_pool(
            host=settings.database.host,
            port=settings.database.port,
            user=settings.database.user,
            password=settings.database.password,
            database=settings.database.database,
            min_size=5,
            max_size=20,
            command_timeout=60
        )

        logger.info(f"Database pool created: {settings.database.database}")

    async def disconnect(self):
        """å…³é—­è¿æ¥æ± """
        if self.pool is not None:
            await self.pool.close()
            self.pool = None
            logger.info("Database pool closed")

    async def health_check(self) -> bool:
        """å¥åº·æ£€æŸ¥"""
        if self.pool is None:
            return False

        try:
            async with self.pool.acquire() as conn:
                result = await conn.fetchval("SELECT 1")
                return result == 1
        except Exception as e:
            logger.error(f"Database health check failed: {e}")
            return False

# å…¨å±€å®ä¾‹
_db_manager: Optional[DatabaseManager] = None

def get_db_manager() -> DatabaseManager:
    """è·å–æ•°æ®åº“ç®¡ç†å™¨å•ä¾‹"""
    global _db_manager
    if _db_manager is None:
        _db_manager = DatabaseManager()
    return _db_manager
```

### 4. di/ - ä¾èµ–æ³¨å…¥å®¹å™¨

```python
# infrastructure/di/container.py
from dependency_injector import containers, providers
from infrastructure.config.settings import get_settings
from infrastructure.database.connection import get_db_manager

# Adapters
from adapters.hikyuu.hikyuu_data_adapter import HikyuuDataAdapter
from adapters.qlib.qlib_model_adapter import QlibModelAdapter
from adapters.repositories.postgres_model_repository import (
    PostgresModelRepository
)

# Use Cases
from use_cases.data.load_stock_data import LoadStockDataUseCase
from use_cases.models.train_model import TrainModelUseCase

class Container(containers.DeclarativeContainer):
    """ä¾èµ–æ³¨å…¥å®¹å™¨

    ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ä¾èµ–
    """

    # é…ç½®
    config = providers.Singleton(get_settings)

    # æ•°æ®åº“
    db_manager = providers.Singleton(get_db_manager)

    # Hikyuu Adapters
    hikyuu_data_adapter = providers.Singleton(
        HikyuuDataAdapter,
        config_file=config.provided.hikyuu.config_file
    )

    # Qlib Adapters
    qlib_model_adapter = providers.Singleton(
        QlibModelAdapter,
        provider_uri=config.provided.qlib.provider_uri,
        region=config.provided.qlib.region
    )

    # Repositories
    model_repository = providers.Factory(
        PostgresModelRepository,
        pool=db_manager.provided.pool
    )

    # Use Cases - Data
    load_stock_data_use_case = providers.Factory(
        LoadStockDataUseCase,
        data_provider=hikyuu_data_adapter
    )

    # Use Cases - Models
    train_model_use_case = providers.Factory(
        TrainModelUseCase,
        data_provider=hikyuu_data_adapter,
        model_trainer=qlib_model_adapter,
        model_repository=model_repository
    )

# å…¨å±€å®¹å™¨å®ä¾‹
_container: Optional[Container] = None

def get_container() -> Container:
    """è·å–å®¹å™¨å•ä¾‹"""
    global _container
    if _container is None:
        _container = Container()
    return _container

def wire_container(container: Container, modules: list):
    """è¿æ¥å®¹å™¨åˆ°æ¨¡å—"""
    container.wire(modules=modules)
```

### ä½¿ç”¨ä¾èµ–æ³¨å…¥

```python
# adapters/controllers/cli/train_cli.py
import click
from infrastructure.di.container import get_container

@click.command()
@click.option('--model', required=True)
def train(model: str):
    """è®­ç»ƒæ¨¡å‹"""
    # ä»å®¹å™¨è·å– Use Case
    container = get_container()
    use_case = container.train_model_use_case()

    # ä½¿ç”¨ Use Case
    request = TrainModelRequest(model_type=model, ...)
    response = asyncio.run(use_case.execute(request))

    if response.success:
        click.echo(f'âœ… è®­ç»ƒå®Œæˆ: {response.model_path}')
    else:
        click.echo(f'âŒ å¤±è´¥: {response.error}')
```

## ç¯å¢ƒé…ç½®ç¤ºä¾‹

```bash
# .env
# åº”ç”¨é…ç½®
DEBUG=false
LOG_LEVEL=INFO

# Hikyuu é…ç½®
HIKYUU_CONFIG=/path/to/hikyuu.ini
HIKYUU_DATA_DIR=/data/hikyuu

# Qlib é…ç½®
QLIB_PROVIDER_URI=/data/qlib
QLIB_REGION=REG_CN

# æ•°æ®åº“é…ç½®
DB_HOST=localhost
DB_PORT=5432
DB_USER=hikyuu_user
DB_PASSWORD=secret
DB_NAME=hikyuu_qlib
```

## TDD ç¤ºä¾‹

```python
# tests/unit/infrastructure/config/test_settings.py
import pytest
import os
from infrastructure.config.settings import Settings, get_settings

class TestSettings:
    """Settings TDD æµ‹è¯•å¥—ä»¶"""

    def test_load_settings_from_env(self, monkeypatch):
        """ğŸ”´ æµ‹è¯•: ä»ç¯å¢ƒå˜é‡åŠ è½½é…ç½®"""
        # è®¾ç½®ç¯å¢ƒå˜é‡
        monkeypatch.setenv('HIKYUU_CONFIG', '/path/to/config.ini')
        monkeypatch.setenv('HIKYUU_DATA_DIR', '/data/hikyuu')
        monkeypatch.setenv('QLIB_PROVIDER_URI', '/data/qlib')
        monkeypatch.setenv('DB_HOST', 'localhost')
        monkeypatch.setenv('DB_USER', 'test')
        monkeypatch.setenv('DB_PASSWORD', 'test')
        monkeypatch.setenv('DB_NAME', 'test_db')

        settings = Settings()

        assert settings.hikyuu.config_file == '/path/to/config.ini'
        assert settings.qlib.region == 'REG_CN'
        assert settings.database.host == 'localhost'

    def test_database_url_generation(self, monkeypatch):
        """ğŸ”´ æµ‹è¯•: ç”Ÿæˆæ•°æ®åº“ URL"""
        monkeypatch.setenv('DB_HOST', 'localhost')
        monkeypatch.setenv('DB_PORT', '5432')
        monkeypatch.setenv('DB_USER', 'user')
        monkeypatch.setenv('DB_PASSWORD', 'pass')
        monkeypatch.setenv('DB_NAME', 'db')

        settings = Settings()

        expected = "postgresql://user:pass@localhost:5432/db"
        assert settings.database.url == expected
```

## å¼€å‘æ—¶é—´è¡¨

| å­æ¨¡å— | é¢„ä¼° | TDD æµç¨‹ |
|--------|------|----------|
| Config | 2å¤© | æµ‹è¯•(0.5å¤©) + å®ç°(1å¤©) + é‡æ„(0.5å¤©) |
| Logging | 1å¤© | æµ‹è¯•(0.5å¤©) + å®ç°(0.5å¤©) |
| Database | 2å¤© | æµ‹è¯•(0.5å¤©) + å®ç°(1å¤©) + é‡æ„(0.5å¤©) |
| DI Container | 2å¤© | æµ‹è¯•(0.5å¤©) + å®ç°(1å¤©) + é‡æ„(0.5å¤©) |
| **æ€»è®¡** | **7å¤©** | **çº¦ 1.5 å‘¨** |

---

**æ¨¡å—è´Ÿè´£äºº**: Infrastructure Team
**ä¼˜å…ˆçº§**: P0 (æœ€é«˜ - åŸºç¡€æ”¯æŒ)
**é¢„ä¼°å·¥æœŸ**: 1.5 å‘¨
**ä¾èµ–**: æ— 
**å½“å‰çŠ¶æ€**: å¾…å¼€å§‹

**é‡è¦æç¤º**:
- âš ï¸ é…ç½®ä¼˜å…ˆçº§: ENV > .env æ–‡ä»¶ > é»˜è®¤å€¼
- âš ï¸ æ•°æ®åº“è¿æ¥æ± å¿…é¡»ç®¡ç†ç”Ÿå‘½å‘¨æœŸ
- âš ï¸ æ—¥å¿—ä¸èƒ½åŒ…å«æ•æ„Ÿä¿¡æ¯
- âš ï¸ DI å®¹å™¨åœ¨å¯åŠ¨æ—¶åˆå§‹åŒ–
