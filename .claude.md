# Hikyuu Ã— Qlib é‡åŒ–äº¤æ˜“å¹³å° - å¼€å‘æ€»çº²

**é¡¹ç›®åç§°**: Hikyuu Ã— Qlib - AI é©±åŠ¨çš„é‡åŒ–äº¤æ˜“å¹³å°
**æ¶æ„æ¨¡å¼**: Hexagonal Architecture (å…­è¾¹å½¢æ¶æ„) + Domain-Driven Design (DDD)
**å¼€å‘æ–¹æ³•**: Test-Driven Development (TDD)
**ç‰ˆæœ¬**: 2.0.0
**æœ€åæ›´æ–°**: 2025-11-11

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#é¡¹ç›®æ¦‚è¿°)
2. [æ¶æ„åŸåˆ™](#æ¶æ„åŸåˆ™)
3. [å¼€å‘çº¦æŸ](#å¼€å‘çº¦æŸ)
4. [TDD å¼ºåˆ¶è¦æ±‚](#tdd-å¼ºåˆ¶è¦æ±‚)
5. [ä»£ç è´¨é‡æ ‡å‡†](#ä»£ç è´¨é‡æ ‡å‡†)
6. [åˆ†å±‚å¼€å‘è§„èŒƒ](#åˆ†å±‚å¼€å‘è§„èŒƒ)
7. [æµ‹è¯•ç­–ç•¥](#æµ‹è¯•ç­–ç•¥)
8. [Git å·¥ä½œæµ](#git-å·¥ä½œæµ)
9. [æ–‡æ¡£è¦æ±‚](#æ–‡æ¡£è¦æ±‚)
10. [æ€§èƒ½ä¸å®‰å…¨](#æ€§èƒ½ä¸å®‰å…¨)

---

## é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ç›®æ ‡

æ•´åˆ **Hikyuu** (ä¸­å›½é‡åŒ–äº¤æ˜“æ¡†æ¶) å’Œ **Qlib** (å¾®è½¯ AI é‡åŒ–æŠ•èµ„å¹³å°),æ‰“é€ ä¸€ä¸ª:
- âœ… **é«˜åº¦å¯æµ‹è¯•**çš„é‡åŒ–äº¤æ˜“ç³»ç»Ÿ
- âœ… **æ¡†æ¶æ— å…³**çš„æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- âœ… **æ˜“äºæ‰©å±•**çš„æ¨¡å—åŒ–æ¶æ„
- âœ… **ç”Ÿäº§çº§**çš„ä»£ç è´¨é‡æ ‡å‡†

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

| æ¨¡å— | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|
| **æ•°æ®å¤„ç†** | Hikyuu æ•°æ®åŠ è½½ã€Qlib æ ¼å¼è½¬æ¢ã€æ•°æ®éªŒè¯ | å¾…å¼€å‘ |
| **æ¨¡å‹è®­ç»ƒ** | Qlib æ¨¡å‹è®­ç»ƒã€è¶…å‚ä¼˜åŒ–ã€å®éªŒè·Ÿè¸ª | å¾…å¼€å‘ |
| **ç­–ç•¥æ‰§è¡Œ** | Hikyuu å›æµ‹ã€ä¿¡å·è½¬æ¢ã€ç»„åˆä¼˜åŒ– | å¾…å¼€å‘ |
| **åˆ†ææŠ¥å‘Š** | ç»©æ•ˆåˆ†æã€å¯è§†åŒ–ã€ç­–ç•¥å¯¹æ¯” | å¾…å¼€å‘ |
| **CLI å·¥å…·** | å‘½ä»¤è¡Œç•Œé¢ã€é…ç½®ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦ | å¾…å¼€å‘ |

### æŠ€æœ¯æ ˆ

```yaml
è¯­è¨€: Python 3.8+
æµ‹è¯•æ¡†æ¶: Pytest
ä¾èµ–æ³¨å…¥: dependency-injector
é…ç½®ç®¡ç†: Pydantic
æ—¥å¿—ç®¡ç†: Loguru
å¼‚æ­¥ç¼–ç¨‹: asyncio
æ•°æ®åº“: PostgreSQL (asyncpg)
é‡åŒ–æ¡†æ¶:
  - Hikyuu (æ•°æ®ã€æŒ‡æ ‡ã€å›æµ‹)
  - Qlib (æ¨¡å‹ã€é¢„æµ‹ã€å®éªŒ)
ä»£ç è´¨é‡:
  - ç±»å‹æ£€æŸ¥: mypy
  - ä»£ç æ£€æŸ¥: ruff
  - æ ¼å¼åŒ–: black / ruff format
```

---

## æ¶æ„åŸåˆ™

### æ ¸å¿ƒåŸåˆ™ (ä¸å¯è¿å)

#### 1. ä¾èµ–è§„åˆ™ (Dependency Rule)

**å¼ºåˆ¶è¦æ±‚**: ä¾èµ–åªèƒ½å‘å†…,å†…å±‚å¯¹å¤–å±‚ä¸€æ— æ‰€çŸ¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Adapters (Hikyuu/Qlib/CLI)       â”‚  â† å¤–å±‚ (å¯æ›¿æ¢)
â”‚   - å®ç° Ports                      â”‚
â”‚   - è°ƒç”¨å¤–éƒ¨æ¡†æ¶                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ä¾èµ– (å‘å†…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Use Cases (ä¸šåŠ¡æµç¨‹ç¼–æ’)          â”‚  â† ä¸­å±‚ (åº”ç”¨)
â”‚   - ä¾èµ– Ports (æ¥å£)               â”‚
â”‚   - ç¼–æ’ Domain å¯¹è±¡                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ ä¾èµ– (å‘å†…)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Domain (æ ¸å¿ƒä¸šåŠ¡è§„åˆ™)             â”‚  â† å†…å±‚ (æ ¸å¿ƒ)
â”‚   - é›¶å¤–éƒ¨ä¾èµ–                      â”‚
â”‚   - å®šä¹‰ Ports (æ¥å£)               â”‚
â”‚   - çº¯ä¸šåŠ¡é€»è¾‘                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âœ… å…è®¸: Adapters â†’ Use Cases â†’ Domain
âŒ ç¦æ­¢: Domain â†’ Use Cases
âŒ ç¦æ­¢: Domain â†’ Adapters
âŒ ç¦æ­¢: Domain â†’ ä»»ä½•æ¡†æ¶ (Hikyuu/Qlib/FastAPI/ç­‰)
```

**æ£€æŸ¥æ–¹å¼**: è¿è¡Œæ¶æ„æµ‹è¯• `pytest tests/architecture/test_dependency_rules.py`

#### 2. æ¡†æ¶ç‹¬ç«‹æ€§ (Framework Independence)

**å¼ºåˆ¶è¦æ±‚**: Domain å±‚ç»å¯¹ä¸èƒ½ import ä»»ä½•å¤–éƒ¨æ¡†æ¶

```python
# âœ… æ­£ç¡®: Domain å±‚ä»£ç 
# domain/entities/stock.py
from dataclasses import dataclass
from domain.value_objects.stock_code import StockCode

@dataclass
class Stock:
    code: StockCode
    name: str

    def is_tradable(self) -> bool:
        return self.is_active

# âŒ é”™è¯¯: Domain å±‚ä¸èƒ½è¿™æ ·å†™
import hikyuu as hku  # âŒ ç¦æ­¢ import æ¡†æ¶
import qlib  # âŒ ç¦æ­¢ import æ¡†æ¶
from fastapi import APIRouter  # âŒ ç¦æ­¢ import æ¡†æ¶
```

**åŸå› **:
- Domain æ˜¯ä¸šåŠ¡çš„æ ¸å¿ƒ,å¿…é¡»ç‹¬ç«‹äºæŠ€æœ¯ç»†èŠ‚
- æ¡†æ¶å¯ä»¥æ›¿æ¢,ä¸šåŠ¡è§„åˆ™ä¸å˜
- ä¾¿äºæµ‹è¯•,æ— éœ€å¯åŠ¨æ¡†æ¶

#### 3. ä¾èµ–å€’ç½®åŸåˆ™ (Dependency Inversion)

**å¼ºåˆ¶è¦æ±‚**: Domain å®šä¹‰æ¥å£ (Ports), Adapters å®ç°æ¥å£

```python
# âœ… æ­£ç¡®æ¨¡å¼

# Step 1: Domain å®šä¹‰æ¥å£ (Port)
# domain/ports/stock_data_provider.py
from abc import ABC, abstractmethod

class IStockDataProvider(ABC):
    """Port: Domain å®šä¹‰æ¥å£"""
    @abstractmethod
    async def load_stock_data(self, code: StockCode) -> pd.DataFrame:
        pass

# Step 2: Use Case ä¾èµ–æ¥å£
# use_cases/data/load_stock_data.py
class LoadStockDataUseCase:
    def __init__(self, provider: IStockDataProvider):  # ä¾èµ–æŠ½è±¡
        self.provider = provider

    async def execute(self, request):
        data = await self.provider.load_stock_data(...)  # ä½¿ç”¨æ¥å£
        return response

# Step 3: Adapter å®ç°æ¥å£
# adapters/hikyuu/data_adapter.py
class HikyuuDataAdapter(IStockDataProvider):
    """å®ç° Domain Port"""
    async def load_stock_data(self, code: StockCode):
        # è°ƒç”¨ Hikyuu API
        stock = hku.Stock(code.value)
        return stock.getKData(...)

# âŒ é”™è¯¯æ¨¡å¼: ç›´æ¥ä¾èµ–å…·ä½“å®ç°
class LoadStockDataUseCase:
    def __init__(self):
        self.hikyuu = HikyuuDataLoader()  # âŒ ä¸èƒ½ç›´æ¥ä¾èµ–å…·ä½“ç±»
```

#### 4. å•ä¸€èŒè´£åŸåˆ™ (Single Responsibility)

**æ¯å±‚åªåšä¸€ä»¶äº‹**:

| å±‚æ¬¡ | èŒè´£ | ç¦æ­¢äº‹é¡¹ |
|------|------|---------|
| **Domain** | å®šä¹‰ä¸šåŠ¡è§„åˆ™å’Œæ¨¡å‹ | âŒ è°ƒç”¨æ•°æ®åº“<br>âŒ è°ƒç”¨ API<br>âŒ å¤„ç† HTTP |
| **Use Cases** | ç¼–æ’ä¸šåŠ¡æµç¨‹ | âŒ åŒ…å«ä¸šåŠ¡è§„åˆ™<br>âŒ ç›´æ¥è°ƒç”¨æ¡†æ¶ |
| **Adapters** | å®ç°æŠ€æœ¯ç»†èŠ‚ | âŒ åŒ…å«ä¸šåŠ¡é€»è¾‘ |
| **Infrastructure** | æä¾›æŠ€æœ¯æ”¯æŒ | âŒ åŒ…å«ä¸šåŠ¡é€»è¾‘ |

---

## å¼€å‘çº¦æŸ

### ğŸš« ç»å¯¹ç¦æ­¢äº‹é¡¹

#### 1. Domain å±‚ç¦æ­¢äº‹é¡¹

```python
# âŒ ç¦æ­¢ #1: import å¤–éƒ¨æ¡†æ¶
import hikyuu  # âŒ
import qlib  # âŒ
from sqlalchemy import Column  # âŒ
from fastapi import HTTPException  # âŒ

# âŒ ç¦æ­¢ #2: ä¾èµ–å…·ä½“å®ç°
class Stock:
    def __init__(self):
        self.db = PostgresDB()  # âŒ ä¸èƒ½ä¾èµ–å…·ä½“æ•°æ®åº“

# âŒ ç¦æ­¢ #3: åŒ…å«æŠ€æœ¯ç»†èŠ‚
class Order:
    def save_to_database(self):  # âŒ ä¸èƒ½æœ‰æ•°æ®åº“é€»è¾‘
        conn = psycopg2.connect(...)

# âœ… æ­£ç¡®: çº¯ä¸šåŠ¡é€»è¾‘
@dataclass
class Stock:
    code: StockCode
    name: str

    def is_tradable(self) -> bool:
        """çº¯ä¸šåŠ¡è§„åˆ™"""
        return self.is_active and self.market.is_open()
```

#### 2. Use Cases ç¦æ­¢äº‹é¡¹

```python
# âŒ ç¦æ­¢: ç›´æ¥è°ƒç”¨æ¡†æ¶
class TrainModelUseCase:
    async def execute(self, request):
        qlib.init(...)  # âŒ ä¸èƒ½ç›´æ¥è°ƒç”¨ Qlib
        model = LGBModel(...)  # âŒ ä¸èƒ½ç›´æ¥åˆ›å»ºæ¡†æ¶å¯¹è±¡

# âœ… æ­£ç¡®: é€šè¿‡ Port æ¥å£
class TrainModelUseCase:
    def __init__(self, trainer: IModelTrainer):  # Port
        self.trainer = trainer

    async def execute(self, request):
        model = await self.trainer.train(...)  # ä½¿ç”¨æ¥å£
```

#### 3. æµ‹è¯•ç¦æ­¢äº‹é¡¹

```python
# âŒ ç¦æ­¢: å…ˆå†™ä»£ç ,åå†™æµ‹è¯•
def create_user(email, name):  # âŒ æ²¡æœ‰å…ˆå†™æµ‹è¯•
    ...

# âœ… æ­£ç¡®: TDD æµç¨‹
# Step 1: å…ˆå†™æµ‹è¯•
def test_create_user_with_valid_email():
    use_case = CreateUserUseCase(mock_repo)
    result = use_case.execute(...)
    assert result.success is True

# Step 2: è¿è¡Œæµ‹è¯• (å¤±è´¥)
# Step 3: å†™æœ€å°ä»£ç è®©æµ‹è¯•é€šè¿‡
# Step 4: é‡æ„
```

### âœ… å¼ºåˆ¶è¦æ±‚

#### 1. æ‰€æœ‰ Public æ–¹æ³•å¿…é¡»æœ‰ç±»å‹æ³¨è§£

```python
# âŒ é”™è¯¯: ç¼ºå°‘ç±»å‹æ³¨è§£
def load_data(code, start, end):
    pass

# âœ… æ­£ç¡®: å®Œæ•´ç±»å‹æ³¨è§£
async def load_data(
    code: StockCode,
    start: datetime,
    end: datetime
) -> pd.DataFrame:
    pass
```

#### 2. æ‰€æœ‰ç±»/æ–¹æ³•å¿…é¡»æœ‰æ–‡æ¡£å­—ç¬¦ä¸²

```python
# âŒ é”™è¯¯: ç¼ºå°‘æ–‡æ¡£
class Stock:
    def is_tradable(self):
        return True

# âœ… æ­£ç¡®: å®Œæ•´æ–‡æ¡£
class Stock:
    """è‚¡ç¥¨å®ä½“

    è¡¨ç¤ºä¸€ä¸ªå¯äº¤æ˜“çš„è‚¡ç¥¨,åŒ…å«ä»£ç ã€åç§°ç­‰å±æ€§ã€‚

    Attributes:
        code: è‚¡ç¥¨ä»£ç  (StockCode å€¼å¯¹è±¡)
        name: è‚¡ç¥¨åç§°
        is_active: æ˜¯å¦æ´»è·ƒ

    Examples:
        >>> stock = Stock(StockCode("sh000001"), "ä¸Šè¯æŒ‡æ•°", True)
        >>> stock.is_tradable()
        True
    """

    def is_tradable(self) -> bool:
        """åˆ¤æ–­è‚¡ç¥¨æ˜¯å¦å¯äº¤æ˜“

        ä¸šåŠ¡è§„åˆ™: åªæœ‰æ´»è·ƒçš„è‚¡ç¥¨æ‰èƒ½äº¤æ˜“

        Returns:
            bool: å¯äº¤æ˜“è¿”å› True,å¦åˆ™ False
        """
        return self.is_active
```

#### 3. æ¯ä¸ªæ¨¡å—å¿…é¡»æœ‰ README.md

```
src/domain/
â”œâ”€â”€ README.md          âœ… å¿…é¡»
â”œâ”€â”€ .claude.md         âœ… å¿…é¡»
â”œâ”€â”€ entities/
â”‚   â””â”€â”€ README.md      âœ… å¿…é¡»
```

---

## TDD å¼ºåˆ¶è¦æ±‚

### ğŸ”´ RED â†’ ğŸŸ¢ GREEN â†’ ğŸ”µ REFACTOR å¾ªç¯

**è¿™æ˜¯é“å¾‹,å¿…é¡»ä¸¥æ ¼éµå®ˆ**:

#### Step 1: ğŸ”´ RED (ç¼–å†™å¤±è´¥çš„æµ‹è¯•)

```python
# tests/unit/domain/entities/test_stock.py

def test_stock_is_tradable_when_active():
    """ğŸ”´ RED: å…ˆå†™æµ‹è¯•"""
    # Given: æ´»è·ƒçš„è‚¡ç¥¨
    stock = Stock(
        code=StockCode("sh000001"),
        name="ä¸Šè¯æŒ‡æ•°",
        is_active=True
    )

    # When: åˆ¤æ–­æ˜¯å¦å¯äº¤æ˜“
    result = stock.is_tradable()

    # Then: åº”è¯¥å¯äº¤æ˜“
    assert result is True

def test_stock_not_tradable_when_inactive():
    """ğŸ”´ RED: æµ‹è¯•è¾¹ç•Œæƒ…å†µ"""
    stock = Stock(
        code=StockCode("sh000001"),
        name="ä¸Šè¯æŒ‡æ•°",
        is_active=False
    )

    assert stock.is_tradable() is False
```

**è¿è¡Œæµ‹è¯•**:
```bash
pytest tests/unit/domain/entities/test_stock.py -v
# é¢„æœŸ: FAILED (å› ä¸ºè¿˜æ²¡å®ç°)
```

#### Step 2: ğŸŸ¢ GREEN (æœ€å°å®ç°)

```python
# src/domain/entities/stock.py

@dataclass
class Stock:
    """æœ€å°å®ç°,åªä¸ºé€šè¿‡æµ‹è¯•"""
    code: StockCode
    name: str
    is_active: bool = True

    def is_tradable(self) -> bool:
        """æœ€ç®€å•çš„å®ç°"""
        return self.is_active  # åªå†™è¿™ä¸€è¡Œ
```

**è¿è¡Œæµ‹è¯•**:
```bash
pytest tests/unit/domain/entities/test_stock.py -v
# é¢„æœŸ: PASSED âœ…
```

#### Step 3: ğŸ”µ REFACTOR (é‡æ„ä¼˜åŒ–)

```python
# é‡æ„: æ·»åŠ æ›´å¤æ‚çš„ä¸šåŠ¡è§„åˆ™ (å¦‚æœæµ‹è¯•è¦æ±‚)
def is_tradable(self) -> bool:
    """é‡æ„åçš„å®ç°"""
    return self.is_active and self.market.is_open()
```

**è¿è¡Œæµ‹è¯•**:
```bash
pytest tests/unit/domain/entities/test_stock.py -v
# é¢„æœŸ: ä»ç„¶ PASSED âœ…
```

### æµ‹è¯•è¦†ç›–ç‡å¼ºåˆ¶è¦æ±‚

**æ¯å±‚éƒ½æœ‰æœ€ä½è¦†ç›–ç‡è¦æ±‚,ä¸è¾¾æ ‡ä¸å…è®¸åˆå¹¶**:

| å±‚æ¬¡ | æœ€ä½è¦†ç›–ç‡ | æ¨èè¦†ç›–ç‡ | æ£€æŸ¥å‘½ä»¤ |
|------|-----------|-----------|---------|
| **Domain** | 95% | 100% | `pytest --cov=src/domain --cov-report=term-missing` |
| **Use Cases** | 90% | 95% | `pytest --cov=src/use_cases --cov-report=term-missing` |
| **Adapters** | 85% | 90% | `pytest --cov=src/adapters --cov-report=term-missing` |
| **Infrastructure** | 88% | 90% | `pytest --cov=src/infrastructure --cov-report=term-missing` |
| **æ•´ä½“** | 90% | 95% | `pytest --cov=src --cov-report=html` |

**CI/CD æ£€æŸ¥**:
```bash
# åœ¨ CI ä¸­è¿è¡Œ,è¦†ç›–ç‡ä¸è¾¾æ ‡åˆ™æ„å»ºå¤±è´¥
pytest --cov=src --cov-fail-under=90
```

### æµ‹è¯•å‘½åè§„èŒƒ

```python
# âœ… æ­£ç¡®: æè¿°æ€§æµ‹è¯•åç§°
def test_create_user_with_valid_email_returns_success():
    pass

def test_create_user_with_duplicate_email_returns_error():
    pass

def test_stock_is_tradable_when_market_is_open():
    pass

# âŒ é”™è¯¯: æ¨¡ç³Šçš„æµ‹è¯•åç§°
def test_user():
    pass

def test_1():
    pass
```

### æµ‹è¯•ç»„ç»‡ç»“æ„

```
tests/
â”œâ”€â”€ unit/                    # å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ test_stock.py
â”‚   â”‚   â”‚   â””â”€â”€ test_model.py
â”‚   â”‚   â”œâ”€â”€ value_objects/
â”‚   â”‚   â”‚   â”œâ”€â”€ test_stock_code.py
â”‚   â”‚   â”‚   â””â”€â”€ test_price.py
â”‚   â”‚   â””â”€â”€ services/
â”‚   â”œâ”€â”€ use_cases/
â”‚   â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â””â”€â”€ models/
â”‚   â””â”€â”€ adapters/
â”œâ”€â”€ integration/             # é›†æˆæµ‹è¯•
â”‚   â”œâ”€â”€ test_hikyuu_integration.py
â”‚   â”œâ”€â”€ test_qlib_integration.py
â”‚   â””â”€â”€ test_end_to_end.py
â”œâ”€â”€ architecture/            # æ¶æ„æµ‹è¯•
â”‚   â”œâ”€â”€ test_dependency_rules.py
â”‚   â””â”€â”€ test_layer_isolation.py
â””â”€â”€ conftest.py             # Pytest é…ç½®
```

---

## ä»£ç è´¨é‡æ ‡å‡†

### å¼ºåˆ¶æ€§ä»£ç æ£€æŸ¥

**æ‰€æœ‰ä»£ç å¿…é¡»é€šè¿‡ä»¥ä¸‹æ£€æŸ¥æ‰èƒ½æäº¤**:

#### 1. Type Checking (mypy)

```bash
# è¿è¡Œç±»å‹æ£€æŸ¥
mypy src/ --strict

# é…ç½®æ–‡ä»¶: pyproject.toml
[tool.mypy]
python_version = "3.8"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
```

**ç¤ºä¾‹**:
```python
# âœ… é€šè¿‡ç±»å‹æ£€æŸ¥
def load_data(code: StockCode) -> pd.DataFrame:
    pass

# âŒ ä¸é€šè¿‡ç±»å‹æ£€æŸ¥
def load_data(code):  # Missing type annotations
    pass
```

#### 2. Linting (ruff)

```bash
# è¿è¡Œä»£ç æ£€æŸ¥
ruff check src/

# é…ç½®æ–‡ä»¶: pyproject.toml
[tool.ruff]
line-length = 100
select = ["E", "F", "I", "N", "W"]
ignore = ["E501"]
```

#### 3. Formatting (ruff format / black)

```bash
# æ ¼å¼åŒ–ä»£ç 
ruff format src/
# æˆ–
black src/

# æ£€æŸ¥æ ¼å¼
ruff format --check src/
```

#### 4. Import Sorting (ruff / isort)

```python
# âœ… æ­£ç¡®çš„ import é¡ºåº
# 1. æ ‡å‡†åº“
import os
from datetime import datetime
from typing import Optional

# 2. ç¬¬ä¸‰æ–¹åº“
import pandas as pd
import pytest

# 3. æœ¬åœ°æ¨¡å—
from domain.entities.stock import Stock
from domain.value_objects.stock_code import StockCode
```

### ä»£ç å¤æ‚åº¦é™åˆ¶

```python
# é…ç½®æ–‡ä»¶: .flake8 æˆ– pyproject.toml
[flake8]
max-complexity = 10          # åœˆå¤æ‚åº¦ <= 10
max-line-length = 100        # å•è¡Œ <= 100 å­—ç¬¦
max-function-length = 50     # å‡½æ•° <= 50 è¡Œ
```

### Code Review æ£€æŸ¥æ¸…å•

**æ¯ä¸ª PR å¿…é¡»æ£€æŸ¥**:

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ (`pytest`)
- [ ] è¦†ç›–ç‡è¾¾æ ‡ (`pytest --cov=src --cov-fail-under=90`)
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡ (`mypy src/ --strict`)
- [ ] ä»£ç æ£€æŸ¥é€šè¿‡ (`ruff check src/`)
- [ ] æ ¼å¼æ£€æŸ¥é€šè¿‡ (`ruff format --check src/`)
- [ ] æ¶æ„æµ‹è¯•é€šè¿‡ (`pytest tests/architecture/`)
- [ ] æ–‡æ¡£å®Œæ•´ (æ‰€æœ‰ public æ–¹æ³•æœ‰ docstring)
- [ ] éµå¾ªä¾èµ–è§„åˆ™ (å†…å±‚ä¸ä¾èµ–å¤–å±‚)
- [ ] æ— å®‰å…¨æ¼æ´ (`bandit -r src/`)
- [ ] Commit æ¶ˆæ¯è§„èŒƒ (Conventional Commits)

---

## åˆ†å±‚å¼€å‘è§„èŒƒ

### Domain å±‚å¼€å‘è§„èŒƒ

**å‚è€ƒ**: [src/domain/.claude.md](src/domain/.claude.md)

**æ ¸å¿ƒçº¦æŸ**:
1. âœ… é›¶å¤–éƒ¨ä¾èµ– (æ—  `import hikyuu`, `import qlib`)
2. âœ… çº¯ Python æ ‡å‡†åº“ + typing
3. âœ… æ‰€æœ‰ Ports å®šä¹‰åœ¨æ­¤å±‚
4. âœ… è¦†ç›–ç‡ >= 95%

**å¼€å‘æµç¨‹**:
```
1. ä» Value Objects å¼€å§‹ (æœ€ç®€å•,æ— ä¾èµ–)
2. ç„¶å Entities (ä¾èµ– Value Objects)
3. ç„¶å Aggregates (ä¾èµ– Entities)
4. å®šä¹‰ Ports (æ¥å£)
5. å®ç° Domain Services
6. å®šä¹‰ Domain Events
```

**ç¤ºä¾‹**:
```python
# âœ… æ­£ç¡®çš„ Domain ä»£ç 
@dataclass(frozen=True)
class StockCode:
    """Value Object: ä¸å¯å˜,æ— å‰¯ä½œç”¨"""
    value: str

    def __post_init__(self):
        if not self._is_valid():
            raise ValueError(f"Invalid stock code: {self.value}")

    def _is_valid(self) -> bool:
        """ä¸šåŠ¡è§„åˆ™: è‚¡ç¥¨ä»£ç æ ¼å¼éªŒè¯"""
        return len(self.value) == 8 and self.value[:2] in ["sh", "sz"]
```

### Use Cases å±‚å¼€å‘è§„èŒƒ

**å‚è€ƒ**: [src/use_cases/.claude.md](src/use_cases/.claude.md)

**æ ¸å¿ƒçº¦æŸ**:
1. âœ… åªä¾èµ– Domain (é€šè¿‡ Ports)
2. âœ… ä½¿ç”¨ Request/Response DTOs
3. âœ… ç¼–æ’ä¸šåŠ¡æµç¨‹,ä¸åŒ…å«ä¸šåŠ¡è§„åˆ™
4. âœ… è¦†ç›–ç‡ >= 90%

**å¼€å‘æµç¨‹**:
```
1. å®šä¹‰ Request DTO
2. å®šä¹‰ Response DTO
3. ç¼–å†™æµ‹è¯• (Mock Ports)
4. å®ç° Use Case (ç¼–æ’ Domain å¯¹è±¡)
```

**ç¤ºä¾‹**:
```python
# âœ… æ­£ç¡®çš„ Use Case ä»£ç 
@dataclass
class TrainModelRequest:
    """Request DTO"""
    model_type: str
    dataset_config: Dict[str, Any]

@dataclass
class TrainModelResponse:
    """Response DTO"""
    model: Optional[Model]
    success: bool
    error: Optional[str] = None

class TrainModelUseCase:
    def __init__(
        self,
        data_provider: IDataProvider,  # Port ä¾èµ–
        trainer: IModelTrainer         # Port ä¾èµ–
    ):
        self.data_provider = data_provider
        self.trainer = trainer

    async def execute(self, request: TrainModelRequest) -> TrainModelResponse:
        # 1. åŠ è½½æ•°æ® (é€šè¿‡ Port)
        dataset = await self.data_provider.load_dataset(...)

        # 2. éªŒè¯ (è°ƒç”¨ Domain)
        if not dataset.is_valid():
            return TrainModelResponse(success=False, error="Invalid dataset")

        # 3. è®­ç»ƒ (é€šè¿‡ Port)
        model = await self.trainer.train(...)

        # 4. åº”ç”¨ä¸šåŠ¡è§„åˆ™ (è°ƒç”¨ Domain)
        model.mark_as_trained()

        return TrainModelResponse(model=model, success=True)
```

### Adapters å±‚å¼€å‘è§„èŒƒ

**å‚è€ƒ**: [src/adapters/.claude.md](src/adapters/.claude.md)

**æ ¸å¿ƒçº¦æŸ**:
1. âœ… å®ç° Domain Ports
2. âœ… å¯ä»¥è°ƒç”¨å¤–éƒ¨æ¡†æ¶ (Hikyuu, Qlib)
3. âœ… ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
4. âœ… è¦†ç›–ç‡ >= 85%

**å¼€å‘æµç¨‹**:
```
1. æ‰¾åˆ°è¦å®ç°çš„ Port æ¥å£
2. ç¼–å†™æµ‹è¯• (Mock æ¡†æ¶)
3. å®ç° Adapter
4. è¿›è¡Œè½¬æ¢ (æ¡†æ¶å¯¹è±¡ â†” Domain å¯¹è±¡)
```

**ç¤ºä¾‹**:
```python
# âœ… æ­£ç¡®çš„ Adapter ä»£ç 
class HikyuuDataAdapter(IStockDataProvider):
    """å®ç° Domain Port"""

    def __init__(self, config_file: str):
        self.config_file = config_file
        self._initialized = False

    async def load_stock_data(
        self,
        code: StockCode,      # Domain å¯¹è±¡è¾“å…¥
        date_range: DateRange  # Domain å¯¹è±¡è¾“å…¥
    ) -> pd.DataFrame:
        self._ensure_initialized()

        # 1. Domain â†’ Hikyuu è½¬æ¢
        stock = hku.Stock(code.value)
        query = hku.Query(
            start=hku.Datetime(date_range.start),
            end=hku.Datetime(date_range.end)
        )

        # 2. è°ƒç”¨ Hikyuu API
        kdata = stock.getKData(query)

        # 3. Hikyuu â†’ DataFrame è½¬æ¢
        return self._to_dataframe(kdata)
```

### Infrastructure å±‚å¼€å‘è§„èŒƒ

**å‚è€ƒ**: [src/infrastructure/.claude.md](src/infrastructure/.claude.md)

**æ ¸å¿ƒçº¦æŸ**:
1. âœ… æä¾›æŠ€æœ¯æ”¯æŒ (é…ç½®ã€æ—¥å¿—ã€DIã€æ•°æ®åº“)
2. âœ… ä¸åŒ…å«ä¸šåŠ¡é€»è¾‘
3. âœ… è¦†ç›–ç‡ >= 88%

---

## æµ‹è¯•ç­–ç•¥

### æµ‹è¯•é‡‘å­—å¡”

```
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ E2E (10%)â”‚  é›†æˆæµ‹è¯• (å°‘é‡,è¦†ç›–å…³é”®è·¯å¾„)
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚Integration   â”‚  é›†æˆæµ‹è¯• (é€‚é‡,æµ‹è¯•å±‚é—´äº¤äº’)
      â”‚   (20%)      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   Unit Tests     â”‚  å•å…ƒæµ‹è¯• (å¤§é‡,å¿«é€Ÿ,éš”ç¦»)
    â”‚     (70%)        â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„å±‚æµ‹è¯•ç­–ç•¥

#### Domain å±‚æµ‹è¯•

**ç‰¹ç‚¹**: çº¯å•å…ƒæµ‹è¯•,æ—  Mock

```python
# âœ… Domain æµ‹è¯•: æ—  Mock
def test_stock_code_validation():
    """çº¯ä¸šåŠ¡é€»è¾‘æµ‹è¯•"""
    # Valid
    code = StockCode("sh000001")
    assert code.value == "sh000001"

    # Invalid
    with pytest.raises(ValueError):
        StockCode("invalid")
```

#### Use Case å±‚æµ‹è¯•

**ç‰¹ç‚¹**: Mock Ports

```python
# âœ… Use Case æµ‹è¯•: Mock Ports
@pytest.fixture
def mock_data_provider():
    provider = Mock(spec=IDataProvider)
    provider.load_dataset.return_value = Mock()
    return provider

async def test_train_model_use_case(mock_data_provider):
    """æµ‹è¯•ä¸šåŠ¡æµç¨‹ç¼–æ’"""
    use_case = TrainModelUseCase(
        data_provider=mock_data_provider,
        trainer=Mock(spec=IModelTrainer)
    )

    response = await use_case.execute(request)

    assert response.success is True
    mock_data_provider.load_dataset.assert_called_once()
```

#### Adapter å±‚æµ‹è¯•

**ç‰¹ç‚¹**: Mock å¤–éƒ¨æ¡†æ¶

```python
# âœ… Adapter æµ‹è¯•: Mock æ¡†æ¶
@patch('hikyuu.Stock')
def test_hikyuu_data_adapter(mock_stock):
    """æµ‹è¯•æ¡†æ¶è°ƒç”¨"""
    mock_stock.return_value.getKData.return_value = [...]

    adapter = HikyuuDataAdapter()
    data = await adapter.load_stock_data(...)

    assert isinstance(data, pd.DataFrame)
    mock_stock.assert_called_once()
```

### æ¶æ„æµ‹è¯•

**æµ‹è¯•ä¾èµ–è§„åˆ™**:

```python
# tests/architecture/test_dependency_rules.py
import pytest
from pathlib import Path

def test_domain_has_no_external_dependencies():
    """Domain å±‚ä¸èƒ½ import å¤–éƒ¨æ¡†æ¶"""
    domain_files = Path("src/domain").rglob("*.py")

    forbidden_imports = ["hikyuu", "qlib", "sqlalchemy", "fastapi"]

    for file in domain_files:
        content = file.read_text()
        for forbidden in forbidden_imports:
            assert forbidden not in content, \
                f"{file} imports forbidden module: {forbidden}"

def test_use_cases_only_depend_on_domain():
    """Use Cases åªä¾èµ– Domain"""
    # å®ç°æ£€æŸ¥é€»è¾‘
    pass
```

---

## Git å·¥ä½œæµ

### åˆ†æ”¯ç­–ç•¥

```
main              (ç”Ÿäº§ç¯å¢ƒ,å—ä¿æŠ¤)
  â”œâ”€â”€ develop     (å¼€å‘ç¯å¢ƒ)
  â”‚   â”œâ”€â”€ feature/domain-entities
  â”‚   â”œâ”€â”€ feature/use-cases-data
  â”‚   â””â”€â”€ feature/adapters-hikyuu
  â””â”€â”€ hotfix/critical-bug
```

### Commit æ¶ˆæ¯è§„èŒƒ (Conventional Commits)

```bash
<type>(<scope>): <subject>

<body>

<footer>
```

**ç±»å‹ (type)**:
- `feat`: æ–°åŠŸèƒ½
- `fix`: Bug ä¿®å¤
- `refactor`: é‡æ„ (ä¸æ”¹å˜åŠŸèƒ½)
- `test`: æ·»åŠ /ä¿®æ”¹æµ‹è¯•
- `docs`: æ–‡æ¡£æ›´æ–°
- `style`: ä»£ç æ ¼å¼ (ä¸å½±å“é€»è¾‘)
- `chore`: æ„å»º/å·¥å…·å˜æ›´

**ç¤ºä¾‹**:
```bash
feat(domain): add Stock entity with tradability rules

- Implement Stock entity with StockCode value object
- Add is_tradable() business rule
- Add comprehensive unit tests (100% coverage)

Closes #42
```

### PR è¦æ±‚

**æ¯ä¸ª PR å¿…é¡»**:
1. æ ‡é¢˜éµå¾ª Conventional Commits
2. åŒ…å«å®Œæ•´æµ‹è¯• (è¦†ç›–ç‡è¾¾æ ‡)
3. é€šè¿‡æ‰€æœ‰ CI æ£€æŸ¥
4. è‡³å°‘ 1 ä¸ª Approve
5. æ—  merge conflicts
6. æ›´æ–°ç›¸å…³æ–‡æ¡£

**PR æ¨¡æ¿**:
```markdown
## å˜æ›´ç±»å‹
- [ ] feat (æ–°åŠŸèƒ½)
- [ ] fix (Bug ä¿®å¤)
- [ ] refactor (é‡æ„)
- [ ] test (æµ‹è¯•)
- [ ] docs (æ–‡æ¡£)

## å˜æ›´æè¿°
ç®€è¦æè¿°è¿™ä¸ª PR çš„å˜æ›´å†…å®¹

## æµ‹è¯•è¦†ç›–ç‡
- Domain: XX%
- Use Cases: XX%
- Adapters: XX%

## æ£€æŸ¥æ¸…å•
- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡
- [ ] è¦†ç›–ç‡è¾¾æ ‡
- [ ] ç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] ä»£ç æ£€æŸ¥é€šè¿‡
- [ ] æ–‡æ¡£å·²æ›´æ–°
- [ ] éµå¾ªæ¶æ„åŸåˆ™
```

---

## æ–‡æ¡£è¦æ±‚

### å¿…é¡»çš„æ–‡æ¡£

#### 1. æ¯å±‚çš„ README.md

```markdown
# Domain å±‚

## æ¦‚è¿°
...

## ç›®å½•ç»“æ„
...

## å¼€å‘æŒ‡å—
...

## ç¤ºä¾‹
...
```

#### 2. æ¯ä¸ªæ¨¡å—çš„ .claude.md

åŒ…å«:
- æ¨¡å—èŒè´£
- TDD å¼€å‘æµç¨‹
- æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡
- ä»£ç ç¤ºä¾‹
- äº¤ä»˜æ¸…å•

#### 3. API æ–‡æ¡£

```python
# ä½¿ç”¨ docstring è‡ªåŠ¨ç”Ÿæˆ
def load_stock_data(code: StockCode) -> pd.DataFrame:
    """åŠ è½½è‚¡ç¥¨æ•°æ®

    Args:
        code: è‚¡ç¥¨ä»£ç 

    Returns:
        è‚¡ç¥¨æ•°æ® DataFrame

    Raises:
        ValueError: ä»£ç æ— æ•ˆæ—¶

    Examples:
        >>> data = load_stock_data(StockCode("sh000001"))
        >>> data.shape
        (1000, 7)
    """
```

---

## æ€§èƒ½ä¸å®‰å…¨


### å®‰å…¨è¦æ±‚

1. **ä¸æäº¤æ•æ„Ÿä¿¡æ¯**
   ```bash
   # .gitignore
   *.env
   config/secrets.yaml
   credentials.json
   ```

2. **ä¾èµ–æ‰«æ**
   ```bash
   # æ£€æŸ¥å·²çŸ¥æ¼æ´
   safety check
   pip-audit
   ```

3. **ä»£ç æ‰«æ**
   ```bash
   # æ£€æŸ¥å®‰å…¨é—®é¢˜
   bandit -r src/
   ```

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨å‘½ä»¤

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest

# è¿è¡Œç‰¹å®šå±‚æµ‹è¯•
pytest tests/unit/domain/ -v

# æµ‹è¯•è¦†ç›–ç‡
pytest --cov=src --cov-report=html

# ç±»å‹æ£€æŸ¥
mypy src/ --strict

# ä»£ç æ£€æŸ¥
ruff check src/

# æ ¼å¼åŒ–
ruff format src/

# æ¶æ„æµ‹è¯•
pytest tests/architecture/ -v

# å®‰å…¨æ‰«æ
bandit -r src/
```

### å¼€å‘æµç¨‹æ€»ç»“

```
1. ğŸ”´ RED: ç¼–å†™å¤±è´¥æµ‹è¯•
   â””â”€> pytest (é¢„æœŸ FAILED)

2. ğŸŸ¢ GREEN: æœ€å°å®ç°
   â””â”€> pytest (é¢„æœŸ PASSED)

3. ğŸ”µ REFACTOR: é‡æ„ä¼˜åŒ–
   â””â”€> pytest (é¢„æœŸä» PASSED)

4. è´¨é‡æ£€æŸ¥
   â”œâ”€> mypy src/ --strict
   â”œâ”€> ruff check src/
   â”œâ”€> pytest --cov=src --cov-fail-under=90
   â””â”€> pytest tests/architecture/

5. æäº¤ä»£ç 
   â””â”€> git commit -m "feat(domain): add Stock entity"

6. æ›´æ–°é¡¹ç›®çŠ¶æ€æ–‡æ¡£src/PROJECT_STATUS.mdä¸­å¯¹åº”ä»»åŠ¡çš„è¿›åº¦

6. åˆ›å»º PR
   â””â”€> ç­‰å¾… Review & CI é€šè¿‡

7. åˆå¹¶åˆ° develop
```

---

## ç›¸å…³æ–‡æ¡£

### æ¶æ„æ–‡æ¡£
- [src/ARCHITECTURE.md](src/ARCHITECTURE.md) - å®Œæ•´æ¶æ„æ–‡æ¡£
- [src/README.md](src/README.md) - å¿«é€Ÿå¼€å§‹
- [src/MIGRATION_GUIDE.md](src/MIGRATION_GUIDE.md) - è¿ç§»æŒ‡å—
- [src/PROJECT_STATUS.md](src/PROJECT_STATUS.md) - é¡¹ç›®çŠ¶æ€

### å„å±‚å¼€å‘æŒ‡å—
- [src/domain/.claude.md](src/domain/.claude.md) - Domain å±‚
- [src/use_cases/.claude.md](src/use_cases/.claude.md) - Use Cases å±‚
- [src/adapters/.claude.md](src/adapters/.claude.md) - Adapters å±‚
- [src/infrastructure/.claude.md](src/infrastructure/.claude.md) - Infrastructure å±‚

### å¤–éƒ¨å‚è€ƒ
- [Hexagonal Architecture](https://alistair.cockburn.us/hexagonal-architecture/)
- [Domain-Driven Design](https://martinfowler.com/tags/domain%20driven%20design.html)
- [Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)

---

**é¡¹ç›®è´Ÿè´£äºº**: Architecture Team
**æ¶æ„å¸ˆ**: Claude AI
**ç‰ˆæœ¬**: 2.0.0
**æœ€åæ›´æ–°**: 2025-11-11

**æ ¸å¿ƒç†å¿µ**:
> "è®©ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹äºæŠ€æœ¯ç»†èŠ‚,è®©æµ‹è¯•é©±åŠ¨è®¾è®¡,è®©æ¶æ„ä¿æŒæ¸…æ™°"

---

## âš ï¸ é‡è¦æé†’

1. **Domain å±‚ç»å¯¹ä¸èƒ½ä¾èµ–å¤–éƒ¨æ¡†æ¶** - è¿™æ˜¯ä¸å¯è¿åçš„é“å¾‹
2. **å¿…é¡»éµå¾ª TDD** - å…ˆå†™æµ‹è¯•,åå†™ä»£ç 
3. **æµ‹è¯•è¦†ç›–ç‡å¿…é¡»è¾¾æ ‡** - Domain â‰¥95%, Use Cases â‰¥90%, Adapters â‰¥85%
4. **ä¾èµ–åªèƒ½å‘å†…** - å¤–å±‚å¯ä»¥ä¾èµ–å†…å±‚,åä¹‹ç¦æ­¢
5. **æ‰€æœ‰ Public æ–¹æ³•å¿…é¡»æœ‰ç±»å‹æ³¨è§£å’Œæ–‡æ¡£å­—ç¬¦ä¸²**
6. **ä»£ç æäº¤å‰å¿…é¡»é€šè¿‡æ‰€æœ‰è´¨é‡æ£€æŸ¥** (mypy, ruff, pytest, coverage)

**è¿åä¸Šè¿°ä»»ä½•ä¸€æ¡,PR å°†è¢«æ‹’ç»!**
